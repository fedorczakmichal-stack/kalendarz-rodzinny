<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Kalendarz rodzinny</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    :root{--c-ania:#f0fff4;--c-aniaP:#fff1f2;--c-michal:#f0f9ff;--c-michalP:#f5f3ff;--c-wsp:#fffbeb;--c-inne:#f1f5f9;--k-lask:#a7f3d0;--k-brzeziny:#fde68a;--k-ortho:#f9a8d4;--k-jb:#c4b5fd;--k-jb24:#7c3aed;}
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#fef3f8,#f3f4f6);-webkit-font-smoothing:antialiased;margin:0;padding:0;min-height:100vh;overflow-x:hidden;}
    .hdr{background:#fff;border-bottom:1px solid #e5e7eb;padding:.75rem 1rem;box-shadow:0 1px 3px rgba(0,0,0,.08);position:sticky;top:0;z-index:100;}
    .grid{display:grid;grid-template-columns:64px repeat(6,1fr);border-top:1px solid #e5e7eb}
    .cell{border-bottom:1px solid #e5e7eb;border-left:1px solid #e5e7eb;min-height:60px;position:relative;padding:4px}
    .cell:nth-child(7n+1){border-left:none}
    .cell.header{background:#f9fafb;font-weight:600}
    .day-cell{cursor:pointer}
    .day-num{font-weight:800;color:#374151}
    .day-name{font-size:.7rem;color:#6b7280}
    .today .day-num,.today .day-name{color:#6d28d9}
    .off{position:relative}
    .off::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(239,68,68,.08),rgba(219,39,119,.08));pointer-events:none;z-index:1}
    .fld{height:100%;padding:6px;border-radius:10px;font-size:.9rem;line-height:1.35;cursor:pointer;word-break:break-word;transition:transform .12s;position:relative;z-index:2}
    .fld:hover{transform:translateY(-1px)}
    .c-ania{background:var(--c-ania)} .c-aniaP{background:var(--c-aniaP)} .c-michal{background:var(--c-michal)} .c-michalP{background:var(--c-michalP)} .c-wsp{background:var(--c-wsp)} .c-inne{background:var(--c-inne)}
    .tile-ortho{background:var(--k-ortho)!important;font-weight:600} .tile-brzeziny{background:var(--k-brzeziny)!important;font-weight:600} .tile-lask{background:var(--k-lask)!important;font-weight:600} .tile-jb{background:var(--k-jb)!important;font-weight:600} .tile-jb24{background:var(--k-jb24)!important;color:#fff;font-weight:700}
    
    @media (max-width:768px){
      .grid{display:none}
      .mcal{display:block}
      .m-card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:.6rem;margin-bottom:.5rem;box-shadow:0 2px 8px rgba(0,0,0,.06);}
      .m-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:.3rem;padding-bottom:.3rem;border-bottom:1px solid #f3f4f6;}
      .m-num{font-size:1.2rem;font-weight:800;color:#1f2937;}
      .m-name{font-size:.7rem;color:#6b7280;margin-left:.25rem;}
      .tag{font-size:.6rem;border-radius:999px;padding:.1rem .3rem;font-weight:600;}
      .m-row{display:flex;gap:.3rem;align-items:stretch;margin:.2rem 0;}
      .m-label{flex:0 0 70px;border-radius:6px;padding:.3rem .4rem;font-weight:600;color:#334155;font-size:.7rem;display:flex;align-items:center;}
      .m-content{flex:1;border-radius:6px;padding:.4rem .5rem;cursor:pointer;position:relative;z-index:2;min-height:30px;display:flex;align-items:center;}
      .m-content .txt{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;font-size:.8rem;line-height:1.3;}
      .m-content .placeholder{color:#9ca3af;font-size:.75rem;}
    }
    .mcal{display:none;padding:.4rem;}
    
    #edit{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:2500;display:none;align-items:center;justify-content:center;padding:1rem;}
    .edit-body{background:white;border-radius:16px;width:100%;max-width:500px;max-height:90vh;display:flex;flex-direction:column;overflow:hidden;}
    .edit-head{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid #e5e7eb;background:#f9fafb;}
    .edit-title{font-weight:700;color:#1f2937;margin:0;}
    .edit-close{width:32px;height:32px;border:none;background:none;font-size:18px;color:#6b7280;cursor:pointer;border-radius:6px;}
    .edit-content{padding:1rem;overflow-y:auto;flex:1;}
    .edit-foot{padding:1rem;border-top:1px solid #e5e7eb;background:#f9fafb;}
    .form-group{margin-bottom:1rem;}
    .form-label{display:block;font-size:.85rem;font-weight:600;color:#374151;margin-bottom:.5rem;}
    .form-input{width:100%;padding:.75rem;border:2px solid #e5e7eb;border-radius:10px;font-size:.9rem;font-weight:500;transition:all .2s;}
    .form-input:focus{outline:none;border-color:#8b5cf6;box-shadow:0 0 0 3px rgba(139,92,246,.1);background:#fefefe;}
  </style>
</head>
<body>
  <div id="app-container">
    <header class="hdr">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-gradient-to-br from-pink-300 to-purple-400 grid place-items-center shadow">
            <span class="text-white font-black">üå∏</span>
          </div>
          <div>
            <div class="font-extrabold text-slate-900">Kalendarz rodzinny</div>
            <div class="text-slate-500 text-sm -mt-1">Kalendarz</div>
          </div>
        </div>
        <div class="flex items-center gap-4 flex-wrap">
          <button id="prev" class="p-3 rounded-xl hover:bg-gray-100 transition-all duration-200 group">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 18l-6-6 6-6"/>
            </svg>
          </button>
          <h2 id="title" class="font-bold text-slate-800 min-w-[180px] text-center text-lg">‚Äî</h2>
          <button id="next" class="p-3 rounded-xl hover:bg-gray-100 transition-all duration-200 group">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 18l6-6-6-6"/>
            </svg>
          </button>
          <button id="today" class="px-4 py-2.5 text-sm font-semibold text-gray-700 bg-white border border-gray-300 rounded-xl hover:bg-gray-50 transition-all duration-200 ml-4">Dzi≈õ</button>
          <div class="flex items-center gap-2 border border-gray-200 rounded-xl p-2 ml-8">
            <button id="connectOnedriveBtn" class="px-3 py-2 text-sm font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700">Po≈ÇƒÖcz z OneDrive</button>
            <button id="forceSyncBtn" class="px-3 py-2 text-sm font-semibold text-white bg-green-600 rounded-md hover:bg-green-700">üîÑ Od≈õwie≈º</button>
            <div id="syncStatus" class="text-sm text-gray-500">Sprawdzanie...</div>
          </div>
        </div>
      </div>
    </header>
    
    <main class="w-full bg-white flex flex-col flex-grow">
      <div class="overflow-auto flex-1">
        <div class="bg-white border-t min-w-[900px]">
          <div class="grid font-semibold text-sm text-center text-gray-700 sticky top-0 bg-white z-10">
            <div class="cell header p-3">Dzie≈Ñ</div>
            <div class="cell header p-3 c-ania">Ania</div>
            <div class="cell header p-3 c-aniaP">Ania Praca</div>
            <div class="cell header p-3 c-michal">Micha≈Ç</div>
            <div class="cell header p-3 c-michalP">Micha≈Ç Praca</div>
            <div class="cell header p-3 c-wsp">Niania</div>
            <div class="cell header p-3 c-inne">Inne</div>
          </div>
          <div id="desk" class="grid"></div>
        </div>
      </div>
      
      <div id="mob" class="mcal md:hidden">
        <div id="m-cards-view"></div>
      </div>
    </main>
    
    <!-- Edit Dialog -->
    <div id="edit">
      <div class="edit-body">
        <div class="edit-head">
          <h3 id="edit-title" class="edit-title">Edycja</h3>
          <button id="edit-close" class="edit-close">‚úï</button>
        </div>
        <div id="edit-content" class="edit-content"></div>
        <div class="edit-foot">
          <button id="edit-save" class="px-4 py-2.5 text-sm font-semibold text-white bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg">Zapisz</button>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAgHtQFaHXlPweFU90GKGW2Jx0fl23VRkQ",
      authDomain: "kalendarz-rodzinny-68d04.firebaseapp.com",
      projectId: "kalendarz-rodzinny-68d04",
      storageBucket: "kalendarz-rodzinny-68d04.appspot.com",
      messagingSenderId: "1050937545151",
      appId: "1:1050937545151:web:a85fd1a5f066f4a499910a"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Global variables
    let cur = new Date();
    let data = {};
    const fields = ['ania', 'aniaPraca', 'michal', 'michalPraca', 'wspolne', 'inne'];
    const labels = { ania: 'Ania', aniaPraca: 'Ania Praca', michal: 'Micha≈Ç', michalPraca: 'Micha≈Ç Praca', wspolne: 'Niania', inne: 'Inne' };
    const mNames = ['Stycze≈Ñ','Luty','Marzec','Kwiecie≈Ñ','Maj','Czerwiec','Lipiec','Sierpie≈Ñ','Wrzesie≈Ñ','Pa≈∫dziernik','Listopad','Grudzie≈Ñ'];
    const dShort = ['PN','WT','≈öR','CZ','PT','SB','ND'];
    
    // Elements
    const E = {
      title: document.getElementById('title'),
      prev: document.getElementById('prev'),
      next: document.getElementById('next'),
      today: document.getElementById('today'),
      desk: document.getElementById('desk'),
      mob: document.getElementById('mob'),
      mCardsView: document.getElementById('m-cards-view'),
      edit: document.getElementById('edit'),
      editTitle: document.getElementById('edit-title'),
      editContent: document.getElementById('edit-content'),
      editClose: document.getElementById('edit-close'),
      editSave: document.getElementById('edit-save'),
      connectOnedriveBtn: document.getElementById('connectOnedriveBtn'),
      forceSyncBtn: document.getElementById('forceSyncBtn'),
      syncStatus: document.getElementById('syncStatus')
    };

    // Helper functions
    const getDayIdx = d => (d + 6) % 7;
    const getFieldClass = (field) => ({ aniaPraca: 'c-aniaP', michalPraca: 'c-michalP', wspolne: 'c-wsp' }[field] || `c-${field}`);
    const getEntryText = (day, field) => {
      const entry = data[day]?.[field];
      return typeof entry === 'object' ? entry.text || '' : entry || '';
    };

    const getTileClass = t => {
      if (!t) return '';
      const s = t.toLowerCase();
      if (s.includes('ortho')) return 'tile-ortho';
      if (s.includes('brzeziny')) return 'tile-brzeziny';
      if (s.includes('≈Çask')) return 'tile-lask';
      if (s.startsWith('jb')) return 'tile-jb';
      return '';
    };

    // Calendar ID
    const calId = () => `${cur.getFullYear()}-${cur.getMonth() + 1}`;

    // Save function - spr√≥buj Excel, potem Firebase fallback
    const save = async (day, field, val) => {
      try {
        console.log('üíæ TRYING EXCEL SAVE:', { day, field, val });
        
        // Spr√≥buj Excel pierwsze
        const response = await fetch('https://europe-central2-kalendarz-rodzinny-68d04.cloudfunctions.net/updateCell', {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            day: day,
            field: field,
            value: val,
            month: cur.getMonth() + 1,
            year: cur.getFullYear()
          })
        });
        
        if (response.ok) {
          console.log('‚úÖ SAVED TO EXCEL');
        } else {
          throw new Error('Excel save failed');
        }
        
      } catch (error) {
        console.log('‚ö†Ô∏è EXCEL SAVE FAILED, USING FIREBASE FALLBACK');
        
        // Fallback do Firebase
        try {
          await db.collection(calId()).doc(String(day)).set({ [field]: val }, { merge: true });
          console.log('‚úÖ SAVED TO FIREBASE');
        } catch (firebaseError) {
          console.error('‚ùå FIREBASE SAVE ERROR:', firebaseError);
          alert('B≈ÇƒÖd zapisu: ' + firebaseError.message);
          return;
        }
      }
      
      // Aktualizuj lokalnie od razu
      if (!data[day]) data[day] = {};
      data[day][field] = val;
      
      // Re-render
      renderDesktop();
      if (window.innerWidth <= 768) {
        renderMobileCards();
      }
    };

    // Render desktop calendar
    const renderDesktop = () => {
      console.log('üé® RENDERING DESKTOP with data:', data);
      E.desk.innerHTML = '';
      const days = new Date(cur.getFullYear(), cur.getMonth() + 1, 0).getDate();
      const today = new Date();
      
      for (let d = 1; d <= days; d++) {
        const date = new Date(cur.getFullYear(), cur.getMonth(), d);
        const dow = date.getDay();
        const isToday = today.toDateString() === date.toDateString();
        const off = (dow === 0 || dow === 6);
        
        // Day cell
        const dayCell = document.createElement('div');
        dayCell.className = `cell day-cell ${off ? 'off' : ''} ${isToday ? 'today' : ''} flex items-center justify-center`;
        dayCell.innerHTML = `<div class="text-center"><div class="day-num">${d}</div><div class="day-name">${dShort[getDayIdx(dow)]}</div></div>`;
        E.desk.appendChild(dayCell);
        
        // Field cells
        for (const f of fields) {
          const t = getEntryText(d, f);
          console.log(`Day ${d}, field ${f}, text: "${t}"`);
          const cell = document.createElement('div');
          cell.className = `cell ${off ? 'off' : ''} ${getFieldClass(f)}`;
          
          const fld = document.createElement('div');
          fld.className = `fld ${getTileClass(t)}`;
          fld.dataset.day = d;
          fld.dataset.field = f;
          fld.textContent = t;
          fld.addEventListener('click', () => openEdit(d, f));
          
          cell.appendChild(fld);
          E.desk.appendChild(cell);
        }
      }
      console.log('‚úÖ DESKTOP RENDERED');
    };

    // Render mobile cards
    const renderMobileCards = () => {
      E.mCardsView.innerHTML = '';
      const days = new Date(cur.getFullYear(), cur.getMonth() + 1, 0).getDate();
      const today = new Date();
      const dNamesFull = ['Poniedzia≈Çek','Wtorek','≈öroda','Czwartek','PiƒÖtek','Sobota','Niedziela'];
      
      for (let d = 1; d <= days; d++) {
        const date = new Date(cur.getFullYear(), cur.getMonth(), d);
        const dow = date.getDay();
        const isToday = today.toDateString() === date.toDateString();
        const off = (dow === 0 || dow === 6);
        
        const card = document.createElement('div');
        card.className = `m-card ${off ? 'ring-1 ring-red-200' : ''} ${isToday ? 'ring-2 ring-purple-400' : ''}`;
        
        let html = `<div class="m-head"><div><span class="m-num">${d}</span> <span class="m-name">${dNamesFull[getDayIdx(dow)]}</span></div><div class="flex gap-1">${isToday ? '<span class="tag bg-gradient-to-r from-purple-500 to-pink-500 text-white">Dzi≈õ</span>' : ''}</div></div>`;
        
        for (const f of fields) {
          const t = getEntryText(d, f);
          html += `<div class="m-row"><div class="m-label ${getFieldClass(f)}">${labels[f]}</div><div class="m-content ${getFieldClass(f)} ${getTileClass(t)}" data-day="${d}" data-field="${f}"><span class="txt">${t || '<span class="placeholder">+ Dodaj</span>'}</span></div></div>`;
        }
        
        card.innerHTML = html;
        
        // Add click listeners to mobile content
        card.querySelectorAll('.m-content').forEach(el => {
          el.addEventListener('click', () => {
            const day = parseInt(el.dataset.day);
            const field = el.dataset.field;
            openEdit(day, field);
          });
        });
        E.mCardsView.appendChild(card);
      }
    };

    // Open edit dialog
    function openEdit(day, field) {
      console.log('‚úÖ OPENING EDIT - Day:', day, 'Field:', field);
      const entry = data[day]?.[field] || {};
      const text = typeof entry === 'object' ? entry.text || '' : entry || '';
      
      E.editTitle.textContent = `${labels[field]} ‚Äî ${day} ${mNames[cur.getMonth()]}`;
      E.editContent.innerHTML = `
        <div class="form-group">
          <label class="form-label">Tre≈õƒá wpisu</label>
          <input type="text" id="editText" class="form-input" value="${text}" placeholder="Wpisz tre≈õƒá...">
        </div>
      `;
      
      const editTextEl = document.getElementById('editText');
      editTextEl.focus();
      
      E.editSave.onclick = async () => {
        const newText = editTextEl.value.trim();
        console.log('üíæ SAVING:', { day, field, newText });
        
        // Zawsze zapisz - nawet je≈õli puste (≈ºeby wyczy≈õciƒá kom√≥rkƒô Excel)
        await save(day, field, newText);
        
        E.edit.style.display = 'none';
      };
      
      E.edit.style.display = 'flex';
      console.log('‚úÖ EDIT DIALOG OPENED');
    }

    // Set title
    function setTitle() {
      const title = `${mNames[cur.getMonth()]} ${cur.getFullYear()}`;
      E.title.textContent = title;
    }

    // Load data - spr√≥buj Excel, potem Firebase fallback
    const loadDataFromExcel = async () => {
      try {
        console.log('üìñ TRYING EXCEL FIRST...');
        
        const response = await fetch('https://europe-central2-kalendarz-rodzinny-68d04.cloudfunctions.net/getData', {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            month: cur.getMonth() + 1,
            year: cur.getFullYear()
          })
        });
        
        if (response.ok) {
          const excelData = await response.json();
          console.log('‚úÖ LOADED FROM EXCEL:', excelData);
          data = excelData || {};
          renderDesktop();
          if (window.innerWidth <= 768) {
            renderMobileCards();
          }
          return;
        } else {
          throw new Error('Excel not accessible');
        }
        
      } catch (error) {
        console.log('‚ö†Ô∏è EXCEL FAILED, USING FIREBASE FALLBACK');
        loadDataFromFirebase();
      }
    };

    // Fallback - ≈Çaduj z Firebase
    const loadDataFromFirebase = () => {
      console.log('üìñ LOADING FROM FIREBASE...');
      db.collection(calId()).onSnapshot(snapshot => {
        data = {};
        snapshot.forEach(doc => data[doc.id] = doc.data());
        console.log('‚úÖ LOADED FROM FIREBASE:', data);
        
        // Render bezpo≈õrednio
        renderDesktop();
        if (window.innerWidth <= 768) {
          renderMobileCards();
        }
      });
    };

    // Update calendar
    function update() {
      setTitle();
      loadDataFromExcel(); // Spr√≥buj Excel pierwsze, potem Firebase
    }

    // Navigation
    const changeMonth = (delta) => {
      cur.setDate(1);
      cur.setMonth(cur.getMonth() + delta);
      update();
    };

    const goToToday = () => {
      const t = new Date();
      cur = new Date(t.getFullYear(), t.getMonth(), 1);
      update();
    };

    // Event listeners
    E.prev.onclick = () => changeMonth(-1);
    E.next.onclick = () => changeMonth(1);
    E.today.onclick = goToToday;
    E.editClose.onclick = () => E.edit.style.display = 'none';

    // OneDrive functions
    E.connectOnedriveBtn.onclick = () => {
      window.location.href = "https://europe-central2-kalendarz-rodzinny-68d04.cloudfunctions.net/auth";
    };

    E.forceSyncBtn.onclick = async () => {
      E.syncStatus.textContent = 'Synchronizujƒô...';
      E.forceSyncBtn.disabled = true;
      
      try {
        // Sync OneDrive  
        const response = await fetch('https://europe-central2-kalendarz-rodzinny-68d04.cloudfunctions.net/sync', {
          method: 'POST',
          mode: 'no-cors',
          credentials: 'include'
        });
        
        E.syncStatus.textContent = '‚úÖ ≈ªƒÖdanie synchronizacji wys≈Çane';
        
        // Po synchronizacji spr√≥buj prze≈Çadowaƒá dane
        setTimeout(() => {
          console.log('üîÑ Reloading data after sync...');
          loadDataFromExcel(); // To automatycznie spr√≥buje Excel ‚Üí Firebase
          E.syncStatus.textContent = '‚úÖ Dane od≈õwie≈ºone';
        }, 3000);
        
      } catch (error) {
        console.error('Sync error:', error);
        E.syncStatus.textContent = '‚ùå B≈ÇƒÖd synchronizacji';
      } finally {
        E.forceSyncBtn.disabled = false;
      }
    };

    // Check sync status
    const checkSyncStatus = async () => {
      try {
        const doc = await db.collection('onedrive_config').doc('user_token').get();
        if (doc.exists) {
          E.syncStatus.textContent = '‚úÖ Po≈ÇƒÖczono z OneDrive';
          E.connectOnedriveBtn.textContent = 'Po≈ÇƒÖcz ponownie';
        } else {
          E.syncStatus.textContent = '‚ùå Nie po≈ÇƒÖczono';
        }
      } catch (error) {
        E.syncStatus.textContent = 'Sprawdzanie...';
      }
    };

    // Initialize
    auth.signInAnonymously().then((userCredential) => {
      console.log('‚úÖ Signed in anonymously:', userCredential.user.uid);
      update();
      checkSyncStatus();
    }).catch(error => {
      console.error('‚ùå Auth error:', error);
      alert('B≈ÇƒÖd logowania: ' + error.message);
    });
  </script>
</body>
</html>
