<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>Kalendarz Rodziny Fedorczak</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
  :root{
    /* kolory kolumn */
    --c-ania:#ffe4e6; --c-aniaP:#fed7aa; --c-michal:#cce7ff; --c-michalP:#ddd6fe; --c-wsp:#d1fae5; --c-inne:#fef3c7;
    /* akcenty (zgodne z kropkami w podsumowaniu) */
    --k-ortho:#a7f3d0;     /* miƒôta */
    --k-brzeziny:#fde68a;  /* ≈º√≥≈Çty */
    --k-lask:#f9a8d4;      /* r√≥≈º */
    --k-jb:#c4b5fd;        /* jasny fiolet */
    --k-jb24:#a78bfa;      /* ciemniejszy fiolet dla 24h */
  }
  *{box-sizing:border-box}
  body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#fef3f8,#f3f4f6);-webkit-font-smoothing:antialiased}

  /* HEADER */
  .hdr{background:#fff;border-bottom:1px solid #e5e7eb;padding:.75rem 1rem;box-shadow:0 1px 2px rgba(0,0,0,.05)}
  .view-btn{display:flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:.5rem;border:1px solid transparent}
  .view-btn.active{background:#ede9fe;border-color:#8b5cf6}

  /* PODSUMOWANIE (desktop) */
  .sumbar{display:flex;gap:.5rem;flex-wrap:wrap;background:#fff;border-bottom:1px solid #e5e7eb;padding:.5rem 1rem}
  .chip{display:inline-flex;gap:.35rem;align-items:center;border:1px solid #e5e7eb;background:#f9fafb;border-radius:9999px;padding:.3rem .55rem;font-size:.82rem}
  .dot{width:.55rem;height:.55rem;border-radius:9999px}
  @media (max-width:768px){ .sumbar{display:none} }

  /* GRID ‚Äì stabilna dla IX/X */
  .grid{display:grid;grid-template-columns:64px repeat(6,1fr);border-top:1px solid #e5e7eb}
  .cell{border-bottom:1px solid #e5e7eb;border-left:1px solid #e5e7eb;min-height:60px;position:relative;padding:4px}
  .cell:nth-child(7n+1){border-left:none}
  .cell.header{background:#f9fafb;font-weight:600}
  .day-cell{cursor:pointer}
  .day-num{font-weight:800;color:#374151}
  .day-name{font-size:.7rem;color:#6b7280}
  .today .day-num,.today .day-name{color:#6d28d9}
  .off{background:linear-gradient(135deg,rgba(219,39,119,.06),rgba(147,51,234,.06))}
  .fld{height:100%;padding:6px;border-radius:10px;font-size:.9rem;line-height:1.35;cursor:pointer;word-break:break-word;transition:transform .12s}
  .fld:hover{transform:translateY(-1px)}
  .selected{outline:2px solid #8b5cf6}

  /* kolory kolumn */
  .c-ania{background:var(--c-ania)} .c-aniaP{background:var(--c-aniaP)}
  .c-michal{background:var(--c-michal)} .c-michalP{background:var(--c-michalP)}
  .c-wsp{background:var(--c-wsp)} .c-inne{background:var(--c-inne)}

  /* kafelki typ√≥w pracy (sp√≥jne z kropkami) */
  .tile-ortho{background:var(--k-ortho)!important;font-weight:600}
  .tile-lask{background:var(--k-lask)!important;font-weight:600}
  .tile-jb{background:var(--k-jb)!important;font-weight:600}
  .tile-jb24{background:var(--k-jb24)!important;color:#1f2937;font-weight:700}

  /* MOBILE LIST */
  .mcal{display:none;padding:1rem}
  @media (max-width:768px){
    .grid{display:none}
    .mcal{display:block}
    .m-card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:1rem;margin-bottom:1rem;box-shadow:0 2px 6px rgba(0,0,0,.05)}
    .m-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem;padding-bottom:.5rem;border-bottom:2px solid #f3f4f6}
    .m-num{font-size:1.5rem;font-weight:800;color:#1f2937}
    .m-name{font-size:.85rem;color:#6b7280}
    .m-row{display:flex;gap:.5rem;align-items:stretch;margin:.35rem 0}
    .m-label{flex:0 0 90px;border-radius:10px;padding:.5rem;font-weight:600;color:#334155}
    .m-content{flex:1;border-radius:10px;padding:.5rem;cursor:pointer}
    .m-content .txt{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  }

  /* COMPACT */
  #compact{display:none;padding:1rem}
  .cv-card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;margin-bottom:12px;padding:12px;cursor:pointer}
  .cv-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px}
  .cv-item{padding:8px;border-radius:10px;font-size:.85rem}

  /* MONTH */
  #month{display:none;padding:1rem}
  .mgrid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:#e5e7eb;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
  .mh{background:#f9fafb;padding:.6rem;text-align:center;font-weight:700;color:#6b7280}
  .mc{background:#fff;min-height:96px;padding:.4rem;cursor:pointer}
  .mc.week{background:linear-gradient(135deg,rgba(219,39,119,.05),rgba(147,51,234,.05))}
  .mnum{font-weight:700;color:#374151;margin-bottom:.25rem}
  .mitem{font-size:.68rem;padding:2px 4px;border-radius:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  /* CONTEXT */
  #ctx{position:fixed;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 12px 24px rgba(0,0,0,.1);padding:6px;display:none;z-index:1000}
  .ctx-it{padding:10px 14px;font-size:.9rem;color:#374151;cursor:pointer;border-radius:8px}
  .ctx-it:hover{background:#f3f4f6}

  /* MODAL EDYCJI */
  #edit{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:1200;padding:12px}
  .edit-body{background:#fff;border-radius:18px;max-width:640px;width:100%;max-height:82vh;overflow:auto;padding:16px}

  /* FAB + SHEET (MOBILE) */
  #fab{position:fixed;right:16px;bottom:16px;z-index:1100;display:none;align-items:center;gap:.5rem;
    background:linear-gradient(135deg,#a78bfa,#f472b6);color:#fff;border:none;border-radius:9999px;padding:.7rem .95rem;font-weight:800}
  #fab svg{width:18px;height:18px}
  @media (max-width:768px){ #fab{display:inline-flex} }
  #sheet{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;
    box-shadow:0 -12px 24px rgba(0,0,0,.2);transform:translateY(110%);transition:transform .22s ease-out;z-index:1200}
  #sheet.open{transform:translateY(0)}
</style>
</head>
<body>
<header class="hdr">
  <div class="flex flex-wrap items-center justify-between gap-3">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-gradient-to-br from-pink-300 to-purple-400 grid place-items-center shadow">
        <span class="text-white font-black">üå∏</span>
      </div>
      <div>
        <div class="font-extrabold text-slate-900">Rodzina Fedorczak</div>
        <div class="text-slate-500 text-sm -mt-1">Kalendarz</div>
      </div>
    </div>

    <div class="flex items-center gap-2">
      <button id="prev" class="p-2 rounded-lg hover:bg-gray-100" title="Poprzedni miesiƒÖc">‚óÄ</button>
      <h2 id="title" class="font-semibold text-slate-700 min-w-[160px] text-center">‚Äî</h2>
      <button id="next" class="p-2 rounded-lg hover:bg-gray-100" title="Nastƒôpny miesiƒÖc">‚ñ∂</button>
      <button id="today" class="px-3 py-2 text-sm font-semibold text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Dzi≈õ</button>
      <div class="flex gap-1 border border-gray-200 rounded-xl p-1">
        <button id="v-standard" class="view-btn active" data-v="standard" title="Widok normalny">‚ñ¶</button>
        <button id="v-compact"  class="view-btn" data-v="compact"  title="Widok kompaktowy">‚â°</button>
        <button id="v-month"    class="view-btn" data-v="month"    title="Widok miesiƒôczny">‚ñ§</button>
      </div>
    </div>
  </div>
</header>

<!-- Podsumowanie (desktop) -->
<div class="sumbar">
  <span class="chip"><span class="dot" style="background:var(--k-ortho)"></span> Ortho: <b id="sum-ortho">0h</b></span>
  <span class="chip"><span class="dot" style="background:var(--k-brzeziny)"></span> Brzeziny: <b id="sum-brzeziny">0h</b></span>
  <span class="chip"><span class="dot" style="background:var(--k-lask)"></span> ≈Åask: <b id="sum-lask">0h</b></span>
  <span class="chip"><span class="dot" style="background:var(--k-jb)"></span> JB: <b id="sum-jb">0h</b></span>
  <span class="chip"><span class="dot" style="background:#fca5a5"></span> Porty: <b id="sum-ports">0</b></span>
</div>

<main class="w-full bg-white flex flex-col flex-grow">
  <div id="standard" class="flex-1 flex flex-col">
    <!-- desktop -->
    <div id="desk-wrap" class="overflow-auto hidden md:block flex-1">
      <div class="bg-white border-t min-w-[900px]">
        <div class="grid font-semibold text-sm text-center text-gray-700 sticky top-0 bg-white z-10">
          <div class="cell header p-3">Dzie≈Ñ</div>
          <div class="cell header p-3 c-ania">Ania</div>
          <div class="cell header p-3 c-aniaP">Ania Praca</div>
          <div class="cell header p-3 c-michal">Micha≈Ç</div>
          <div class="cell header p-3 c-michalP">Micha≈Ç Praca</div>
          <div class="cell header p-3 c-wsp">Wsp√≥lne</div>
          <div class="cell header p-3 c-inne">Dom/Finanse</div>
        </div>
        <div id="desk" class="grid"></div>
      </div>
    </div>
    <!-- mobile -->
    <div id="mob" class="mcal md:hidden"></div>
  </div>

  <div id="compact" style="display:none">
    <div id="cv-cont"></div>
  </div>

  <div id="month" style="display:none">
    <div id="mgrid" class="mgrid"></div>
  </div>

  <div id="loading" class="text-center p-8 text-gray-500 font-semibold hidden">
    <div class="w-10 h-10 border-4 border-gray-100 border-t-purple-500 rounded-full animate-spin mx-auto"></div>
  </div>
</main>

<!-- FAB (mobile) -->
<button id="fab" aria-label="Poka≈º podsumowanie">
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor"><path d="M3 12h18M12 3v18"/></svg>
  Suma
</button>

<!-- SHEET (mobile) -->
<div id="sheet">
  <div class="w-full p-4">
    <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-2"></div>
    <div id="sheet-title" class="text-sm text-gray-500 mb-2">Podsumowanie</div>
    <div class="grid grid-cols-2 gap-2">
      <div class="p-3 rounded-lg border border-gray-200 bg-gray-50"><div class="text-xs text-gray-500">Ortho</div><div id="ms-ortho" class="text-lg font-bold">0h</div></div>
      <div class="p-3 rounded-lg border border-gray-200 bg-gray-50"><div class="text-xs text-gray-500">Brzeziny</div><div id="ms-brzeziny" class="text-lg font-bold">0h</div></div>
      <div class="p-3 rounded-lg border border-gray-200 bg-gray-50"><div class="text-xs text-gray-500">≈Åask</div><div id="ms-lask" class="text-lg font-bold">0h</div></div>
      <div class="p-3 rounded-lg border border-gray-200 bg-gray-50"><div class="text-xs text-gray-500">JB</div><div id="ms-jb" class="text-lg font-bold">0h</div></div>
      <div class="p-3 rounded-lg border border-gray-200 bg-gray-50 col-span-2"><div class="text-xs text-gray-500">Porty</div><div id="ms-ports" class="text-lg font-bold">0</div></div>
    </div>
    <div class="mt-3 text-right">
      <button id="sheet-close" class="px-3 py-2 text-sm font-semibold text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Zamknij</button>
    </div>
  </div>
</div>

<!-- Context -->
<div id="ctx">
  <div id="ctx-copy"  class="ctx-it">Kopiuj</div>
  <div id="ctx-cut"   class="ctx-it">Wytnij</div>
  <div id="ctx-paste" class="ctx-it">Wklej</div>
  <div class="h-px bg-gray-200 my-1"></div>
  <div id="ctx-del"   class="ctx-it text-red-600">Usu≈Ñ</div>
</div>

<!-- Modal edycji -->
<div id="edit">
  <div class="edit-body">
    <div class="flex items-center justify-between pb-3 border-b-2 border-gray-100 mb-3">
      <h3 id="edit-title" class="text-xl font-extrabold text-gray-900">Edycja dnia</h3>
      <button id="edit-close" class="w-8 h-8 rounded-lg bg-gray-100 grid place-items-center">‚úï</button>
    </div>
    <div id="edit-fields" class="flex flex-col gap-4"></div>
  </div>
</div>

<script type="module">
/* ==== Firebase ==== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot, collection, updateDoc, deleteField, writeBatch, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const cfg = {
  apiKey:"AIzaSyAgHtQFaHXlPweFU90GKGW2Jx0fl23VRkQ",
  authDomain:"kalendarz-rodzinny-68d04.firebaseapp.com",
  projectId:"kalendarz-rodzinny-68d04",
  storageBucket:"kalendarz-rodzinny-68d04.appspot.com",
  messagingSenderId:"1050937545151",
  appId:"1:1050937545151:web:a85fd1a5f066f4a499910a",
  measurementId:"G-57YKE2XKQ1"
};

let db;
try{
  const app = initializeApp(cfg);
  const auth = getAuth(app);
  db = getFirestore(app);
  signInAnonymously(auth);
  onAuthStateChanged(auth, u => u && init());
}catch(e){ console.error(e); }

/* ==== Stan/DOM ==== */
let cur = new Date();
let unsub = () => {};
let isMobile = matchMedia("(max-width: 768px)").matches;
const fields = ['ania','aniaPraca','michal','michalPraca','wspolne','inne'];
const labels = { ania:'Ania', aniaPraca:'Ania Praca', michal:'Micha≈Ç', michalPraca:'Micha≈Ç Praca', wspolne:'Wsp√≥lne', inne:'Dom/Finanse' };
let data = {};
let clip = null; // tekst
let view = 'standard';

const el = id => document.getElementById(id);
const E = {
  title: el('title'), prev: el('prev'), next: el('next'), today: el('today'),
  vStandard: el('v-standard'), vCompact: el('v-compact'), vMonth: el('v-month'),
  desk: el('desk'), mob: el('mob'), cv: el('cv-cont'), mgrid: el('mgrid'),
  sumOrtho: el('sum-ortho'), sumBrz: el('sum-brzeziny'), sumLask: el('sum-lask'), sumJB: el('sum-jb'), sumPorts: el('sum-ports'),
  msOrtho: el('ms-ortho'), msBrz: el('ms-brzeziny'), msLask: el('ms-lask'), msJB: el('ms-jb'), msPorts: el('ms-ports'),
  sheet: el('sheet'), sheetClose: el('sheet-close'), fab: el('fab'), sheetTitle: el('sheet-title'),
  ctx: el('ctx'), ctxCopy: el('ctx-copy'), ctxCut: el('ctx-cut'), ctxPaste: el('ctx-paste'), ctxDel: el('ctx-del'),
  edit: el('edit'), editClose: el('edit-close'), editFields: el('edit-fields'), editTitle: el('edit-title')
};
window.addEventListener('resize', ()=>{ const was = isMobile; isMobile = matchMedia("(max-width: 768px)").matches; if (was!==isMobile) update(); });

/* ==== Nazwy dni/m-cy ==== */
const mNames = ['Stycze≈Ñ','Luty','Marzec','Kwiecie≈Ñ','Maj','Czerwiec','Lipiec','Sierpie≈Ñ','Wrzesie≈Ñ','Pa≈∫dziernik','Listopad','Grudzie≈Ñ'];
const dNamesFull = ['Poniedzia≈Çek','Wtorek','≈öroda','Czwartek','PiƒÖtek','Sobota','Niedziela'];
const dShort = ['PN','WT','≈öR','CZ','PT','SB','ND'];
const getDayIdx = d => (d + 6) % 7; // Pon=0

/* ==== Rozpoznawanie typ√≥w i kafelk√≥w ==== */
const fullDuty = ['jb oit','jb zniecz','jb znieczulenia','jb znieczule≈Ñ']; // 24h
const isOrtho = t => /ortho/i.test(t||'');
const isBrzeziny = t => /brzeziny/i.test(t||'');
const isLask = t => /≈Çask/i.test(t||'');
const isJB = t => !!(t&&(t.toLowerCase().startsWith('jb')||t.toLowerCase().includes('jb ')));

const getTileClass = t=>{
  if(!t) return '';
  const s=t.toLowerCase();
  if(fullDuty.some(k=>s.includes(k))) return 'tile-jb24';
  if(isLask(s)) return 'tile-lask';
  if(isOrtho(s)) return 'tile-ortho';
  if(s.startsWith('jb')) return 'tile-jb';
  return '';
};

/* godziny ‚Äì wy≈ÇƒÖcznie w tle */
const getDefaultHours = (txt)=>{
  if(!txt) return 0;
  const s = txt.toLowerCase();
  if(isOrtho(s)||isBrzeziny(s)) return 10;
  if(isLask(s)) return 24;
  if(fullDuty.some(k=>s.includes(k))||s.startsWith('jb')) return 24;
  if(/rano|poranna|7[:\.]30|wybudze/i.test(s)) return 6;
  return 0;
};
const getSavedHours = (day, field)=>{
  const d = data[day]||{};
  const v = d[`hours_${field}`];
  return (typeof v === 'number' && Number.isFinite(v)) ? v : null; // fix [object Object]
};
const getPorts = (day, field)=>{
  const d = data[day]||{};
  const v = d[`ports_${field}`];
  return (typeof v === 'number' && Number.isFinite(v)) ? v : 0;
};
const effHours = (day, field, txt)=>{
  const saved = getSavedHours(day, field);
  if(saved!==null) return saved;
  return getDefaultHours(txt);
};

/* ==== Renderers ==== */
const renderDesktop = (y,m,ev)=>{
  E.desk.innerHTML='';
  const days = new Date(y,m+1,0).getDate();
  const today = new Date();
  for(let d=1; d<=days; d++){
    const date = new Date(y,m,d);
    const dow = date.getDay();
    const isToday = today.toDateString()===date.toDateString();
    const de = ev[d]||{};
    const off = (dow===0||dow===6)||de.isHoliday;

    const dayCell = document.createElement('div');
    dayCell.className = `cell day-cell ${off?'off':''} ${isToday?'today':''} flex items-center justify-center`;
    dayCell.dataset.day=d;
    dayCell.innerHTML = `<div class="text-center"><div class="day-num">${d}</div><div class="day-name">${dShort[getDayIdx(dow)]}</div></div>`;
    E.desk.appendChild(dayCell);

    for(const f of fields){
      const t = de[f]||'';
      const c = document.createElement('div');
      c.className = `cell ${off?'off':''} c-${f.replace('wspolne','wsp')}`;
      const div = document.createElement('div');
      div.className = `fld ${getTileClass(t)}`;
      div.dataset.day=d; div.dataset.field=f; div.dataset.id=`${d}-${f}`;
      const span = document.createElement('span'); span.className='txt'; span.textContent=t;
      div.appendChild(span); c.appendChild(div); E.desk.appendChild(c);
      if (!isMobile && t) div.draggable = true; // brak DnD na dotyku
    }
  }
};

const renderMobile = (y,m,ev)=>{
  E.mob.innerHTML='';
  const days = new Date(y,m+1,0).getDate();
  const today = new Date();
  const frag = document.createDocumentFragment();
  for(let d=1; d<=days; d++){
    const date = new Date(y,m,d);
    const dow = date.getDay();
    const de = ev[d]||{};
    const off = (dow===0||dow===6)||de.isHoliday;
    const isToday = today.toDateString()===date.toDateString();
    const card = document.createElement('div');
    card.className = `m-card ${off?'ring-0':''} ${isToday?'ring-2 ring-purple-400':''}`;
    let html = `<div class="m-head"><div><span class="m-num">${d}</span> <span class="m-name">${dNamesFull[getDayIdx(dow)]}</span></div>${de.isHoliday?'<span class="text-xs bg-purple-200 text-purple-700 px-2 py-1 rounded-full">≈öwiƒôto</span>':''}${isToday?'<span class="text-xs bg-gradient-to-r from-purple-500 to-pink-500 text-white px-2 py-1 rounded-full ml-2">Dzi≈õ</span>':''}</div>`;
    for(const f of fields){
      const t = de[f]||'';
      html += `<div class="m-row"><div class="m-label c-${f.replace('wspolne','wsp')}">${labels[f]}</div>
      <div class="m-content c-${f.replace('wspolne','wsp')} ${getTileClass(t)}" data-day="${d}" data-field="${f}">
        <span class="txt">${t||'<span class="text-gray-400">Kliknij aby dodaƒá</span>'}</span>
      </div></div>`;
    }
    card.innerHTML = html;
    frag.appendChild(card);
  }
  E.mob.appendChild(frag);
};

const renderCompact = async (y,m)=>{
  E.cv.innerHTML='';
  const days = new Date(y,m+1,0).getDate();
  for(let d=1; d<=days; d++){
    const de = data[d]||{};
    if(!fields.some(f=>de[f])) continue;
    const dow = new Date(y,m,d).getDay();
    const card = document.createElement('div');
    card.className='cv-card';
    card.onclick=()=>openEdit(d,de);
    let html = `<div class="flex items-center justify-between pb-2 border-b-2 border-gray-100 mb-2">
      <div class="font-extrabold text-lg">${d}</div>
      <div class="text-sm text-gray-500">${dNamesFull[getDayIdx(dow)]}</div></div><div class="cv-grid">`;
    for(const f of fields){
      if(de[f]){
        html += `<div class="cv-item c-${f.replace('wspolne','wsp')} ${getTileClass(de[f])}">
          <div class="text-[11px] opacity-70 font-semibold">${labels[f]}</div>
          <div>${de[f]}</div>
        </div>`;
      }
    }
    html+='</div>';
    card.innerHTML=html; E.cv.appendChild(card);
  }
};

const renderMonth = async (y,m)=>{
  E.mgrid.innerHTML='';
  ['Pon','Wt','≈ör','Czw','Pt','Sob','Nd'].forEach(h=>{ const e=document.createElement('div'); e.className='mh'; e.textContent=h; E.mgrid.appendChild(e); });
  const first = new Date(y,m,1); const start = getDayIdx(first.getDay()); const days = new Date(y,m+1,0).getDate();
  for(let i=0;i<start;i++){ const e=document.createElement('div'); e.className='mc'; e.style.background='#fafafa'; E.mgrid.appendChild(e); }
  for(let d=1; d<=days; d++){
    const dow = new Date(y,m,d).getDay();
    const de = data[d]||{};
    const cell = document.createElement('div');
    cell.className=`mc ${(dow===0||dow===6||de.isHoliday)?'week':''}`;
    cell.onclick=()=>openEdit(d,de);
    let html = `<div class="mnum">${d}</div>`;
    let shown=0;
    for(const f of fields){
      if(de[f] && shown<3){ html += `<div class="mitem c-${f.replace('wspolne','wsp')} ${getTileClass(de[f])}">${de[f]}</div>`; shown++; }
    }
    if(fields.filter(f=>de[f]).length>3) html+=`<div class="mitem" style="color:#6b7280">+ wiƒôcej</div>`;
    cell.innerHTML=html; E.mgrid.appendChild(cell);
  }
  const total = start+days; for(let i=total;i<Math.ceil(total/7)*7;i++){ const e=document.createElement('div'); e.className='mc'; e.style.background='#fafafa'; E.mgrid.appendChild(e); }
};

/* ==== Sumy ==== */
const computeSums = ()=>{
  let ortho=0, brz=0, lask=0, jb=0, ports=0;
  const days=new Date(cur.getFullYear(),cur.getMonth()+1,0).getDate();
  for(let d=1; d<=days; d++){
    const row=data[d]; if(!row) continue;
    for(const f of fields){
      const t=row[f]; if(!t) continue;
      const h=effHours(d,f,t);
      if(isOrtho(t)) ortho+=h;
      if(isBrzeziny(t)) brz+=h;
      if(isLask(t)) lask+=h;
      if(isJB(t)) jb+=h;
      ports += getPorts(d,f);
    }
  }
  E.sumOrtho.textContent=ortho+'h';
  E.sumBrz.textContent=brz+'h';
  E.sumLask.textContent=lask+'h';
  E.sumJB.textContent=jb+'h';
  E.sumPorts.textContent=String(ports);
  E.msOrtho.textContent=ortho+'h';
  E.msBrz.textContent=brz+'h';
  E.msLask.textContent=lask+'h';
  E.msJB.textContent=jb+'h';
  E.msPorts.textContent=String(ports);
  E.sheetTitle.textContent=`Podsumowanie: ${mNames[cur.getMonth()]} ${cur.getFullYear()}`;
};

/* ==== DB ==== */
const calId = ()=>`${cur.getFullYear()}-${cur.getMonth()+1}`;
const save = (day,field,val)=> setDoc(doc(db, calId(), String(day)), { [field]: val }, { merge:true });
const del  = (day,field)=> updateDoc(doc(db, calId(), String(day)), { [field]: deleteField() });
const setHours = (day,field,h)=> setDoc(doc(db, calId(), String(day)), { [`hours_${field}`]: (h===''||h===null)? deleteField() : parseInt(h,10) }, { merge:true });
const setPortsDb = (day,field,c)=> setDoc(doc(db, calId(), String(day)), { [`ports_${field}`]: (c===''||c===null)? deleteField() : parseInt(c,10) }, { merge:true });

/* ==== Modal edycji ==== */
function openEdit(day, dayRow){
  const date=new Date(cur.getFullYear(),cur.getMonth(),day);
  E.editTitle.textContent = `${day} ${mNames[cur.getMonth()]} ‚Äî ${dNamesFull[getDayIdx(date.getDay())]}`;
  E.editFields.innerHTML='';
  for(const f of fields){
    const txt = (dayRow&&dayRow[f])||'';
    const savedH = getSavedHours(day,f);
    const defH = getDefaultHours(txt);
    const ports = getPorts(day,f);

    const wrap=document.createElement('div');
    wrap.innerHTML = `
      <div class="flex items-center gap-2">
        <span class="px-2 py-1 rounded-md c-${f.replace('wspolne','wsp')} text-slate-700 font-semibold">${labels[f]}</span>
        <button class="ml-auto text-red-500 hover:text-red-600" data-act="del" data-field="${f}" title="Usu≈Ñ wpis">Usu≈Ñ</button>
      </div>
      <input type="text" class="w-full mt-2 p-3 border border-gray-200 rounded-lg ${getTileClass(txt)}" data-field="${f}" value="${txt}" placeholder="Kliknij aby dodaƒá">
      <div class="mt-2 grid grid-cols-[1fr_auto] gap-3 items-center">
        <div>
          <label class="text-xs text-gray-500">Godziny (puste = automatycznie)</label>
          <input type="range" min="0" max="48" step="1" value="${savedH!==null?savedH:defH}" data-field="${f}" data-hrs="slider" class="w-full">
        </div>
        <input type="number" min="0" max="48" step="1" value="${savedH!==null?savedH:''}" placeholder="${defH}" data-field="${f}" data-hrs="num" class="w-20 p-2 border border-gray-200 rounded-md text-center">
      </div>
      <div class="mt-2 grid grid-cols-[1fr_auto] gap-3 items-center">
        <label class="text-xs text-gray-500">Porty (opcjonalnie)</label>
        <input type="number" min="0" step="1" value="${ports||''}" placeholder="0" data-field="${f}" data-ports class="w-20 p-2 border border-gray-200 rounded-md text-center">
      </div>
    `;
    E.editFields.appendChild(wrap);
  }

  // tekst
  E.editFields.querySelectorAll('input[type="text"]').forEach(inp=>{
    inp.addEventListener('change', async ()=>{
      const f=inp.dataset.field; const v=inp.value.trim();
      if(!v) await del(day,f).catch(()=>{});
      else await save(day,f,v);
    });
  });
  // godziny
  E.editFields.querySelectorAll('input[data-hrs="slider"]').forEach(sl=>{
    sl.addEventListener('input', ()=>{
      const num = E.editFields.querySelector(`input[data-hrs="num"][data-field="${sl.dataset.field}"]`);
      const field=sl.dataset.field;
      const curTxt=(data[day]||{})[field]||'';
      const def = getDefaultHours(curTxt);
      num.value = (parseInt(sl.value,10)===def)? '' : sl.value;
    });
    sl.addEventListener('change', async ()=>{
      const f=sl.dataset.field; const num = E.editFields.querySelector(`input[data-hrs="num"][data-field="${f}"]`);
      await setHours(day,f,(num.value==='')? '': num.value);
    });
  });
  E.editFields.querySelectorAll('input[data-hrs="num"]').forEach(num=>{
    num.addEventListener('change', async ()=>{
      const f=num.dataset.field; const slider = E.editFields.querySelector(`input[data-hrs="slider"][data-field="${f}"]`);
      const curTxt=(data[day]||{})[f]||''; const def=getDefaultHours(curTxt);
      slider.value = (num.value===''? def : num.value);
      await setHours(day,f,num.value);
    });
  });
  // porty
  E.editFields.querySelectorAll('input[data-ports]').forEach(p=>{
    p.addEventListener('change', async ()=>{ await setPortsDb(day,p.dataset.field,p.value); });
  });
  // usu≈Ñ
  E.editFields.querySelectorAll('[data-act="del"]').forEach(b=>{
    b.addEventListener('click', async ()=>{
      const f=b.dataset.field; await del(day,f).catch(()=>{});
      const row={...(data[day]||{})}; delete row[f]; openEdit(day,row);
    });
  });

  E.edit.style.display='flex';
}
document.getElementById('edit-close').onclick=()=>E.edit.style.display='none';
E.edit.addEventListener('click',e=>{ if(e.target===E.edit) E.edit.style.display='none'; });

/* ==== Context menu ==== */
document.addEventListener('contextmenu', e=>{
  const fld = e.target.closest('.fld'); if(!fld) return;
  e.preventDefault();
  const r=E.ctx; r.style.display='block';
  const rect=r.getBoundingClientRect();
  let x=e.clientX, y=e.clientY;
  if(x+rect.width>innerWidth) x = innerWidth-rect.width-6;
  if(y+rect.height>innerHeight) y = innerHeight-rect.height-6;
  r.style.left=x+'px'; r.style.top=y+'px';
  r.dataset.day=fld.dataset.day; r.dataset.field=fld.dataset.field;
});
document.addEventListener('click', e=>{ if(!e.target.closest('#ctx')) E.ctx.style.display='none'; });

E.ctxCopy.onclick=()=>{ const d=E.ctx.dataset; clip = (data[d.day]?.[d.field])||''; E.ctx.style.display='none'; };
E.ctxCut.onclick=async ()=>{ const d=E.ctx.dataset; clip = (data[d.day]?.[d.field])||''; await del(d.day,d.field); E.ctx.style.display='none'; };
E.ctxPaste.onclick=async ()=>{ const d=E.ctx.dataset; if(clip!==null){ await save(d.day,d.field,clip); } E.ctx.style.display='none'; };
E.ctxDel.onclick=async ()=>{ const d=E.ctx.dataset; await del(d.day,d.field); E.ctx.style.display='none'; };

/* ==== Inline edycja ==== */
document.getElementById('desk').addEventListener('click', e=>{
  const dayCell = e.target.closest('.day-cell'); if(dayCell){ toggleHoliday(dayCell.dataset.day); return; }
  const fld = e.target.closest('.fld'); if(!fld) return openInlineEdit(fld);
});
document.getElementById('mob').addEventListener('click', e=>{
  const c = e.target.closest('.m-content'); if(c){ openEdit(c.dataset.day, data[c.dataset.day]||{}); }
});

function openInlineEdit(fld){
  const span=fld.querySelector('.txt'); const before=span.textContent;
  const ta=document.createElement('textarea'); ta.value=before; ta.className='w-full h-full p-2 border-2 border-purple-400 rounded-md';
  fld.innerHTML=''; fld.appendChild(ta);
  const saveNow=async()=>{
    const val=ta.value.trim();
    fld.innerHTML=`<span class="txt">${val}</span>`;
    if(val!==before){ if(!val) await del(fld.dataset.day,fld.dataset.field).catch(()=>{}); else await save(fld.dataset.day,fld.dataset.field,val); }
  };
  ta.addEventListener('blur',saveNow);
  ta.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); ta.blur(); } });
  ta.focus();
}

/* ==== Holiday toggle ==== */
async function toggleHoliday(day){
  const id=calId(); const ref=doc(db,id,String(day));
  const snap=await getDoc(ref); const cur=(snap.exists() && snap.data().isHoliday)||false;
  await setDoc(ref,{isHoliday:!cur},{merge:true});
}

/* ==== Update/render ==== */
function setTitle(){ E.title.textContent = `${mNames[cur.getMonth()]} ${cur.getFullYear()}`; }

async function update(){
  if(!db) return;
  setTitle();
  const id=calId(); const snap=await getDocs(collection(db,id));
  data={}; snap.forEach(d=>data[d.id]=d.data());

  if(view==='standard'){
    isMobile ? renderMobile(cur.getFullYear(),cur.getMonth(),data) : renderDesktop(cur.getFullYear(),cur.getMonth(),data);
  }else if(view==='compact'){
    await renderCompact(cur.getFullYear(),cur.getMonth());
  }else{
    await renderMonth(cur.getFullYear(),cur.getMonth());
  }
  computeSums();

  // realtime tylko dla standard
  unsub(); if(view!=='standard') return;
  unsub = onSnapshot(collection(db,id), s=>{
    s.docChanges().forEach(ch=>{
      if(ch.type==='removed'){ delete data[ch.doc.id]; }
      else { data[ch.doc.id]=ch.doc.data(); }
    });
    if(isMobile) renderMobile(cur.getFullYear(),cur.getMonth(),data);
    else renderDesktop(cur.getFullYear(),cur.getMonth(),data);
    computeSums();
  });
}

/* ==== Nawigacja/widoki ==== */
E.prev.onclick=()=>{ cur.setMonth(cur.getMonth()-1); update(); };
E.next.onclick=()=>{ cur.setMonth(cur.getMonth()+1); update(); };
E.today.onclick=()=>{ const t=new Date(); cur=new Date(t.getFullYear(),t.getMonth(),1); update(); };

function setActive(){
  for(const b of [E.vStandard,E.vCompact,E.vMonth]) b.classList.remove('active');
  ({standard:E.vStandard,compact:E.vCompact,month:E.vMonth})[view].classList.add('active');
}
[E.vStandard,E.vCompact,E.vMonth].forEach(btn=>{
  btn.onclick=()=>{ view=btn.dataset.v; setActive();
    document.getElementById('standard').style.display = (view==='standard')?'flex':'none';
    document.getElementById('compact').style.display  = (view==='compact')?'block':'none';
    document.getElementById('month').style.display    = (view==='month')?'block':'none';
    update();
  };
});

/* ==== FAB sheet ==== */
E.fab.onclick=()=> E.sheet.classList.add('open');
E.sheetClose.onclick=()=> E.sheet.classList.remove('open');
E.sheet.addEventListener('click',e=>{ if(e.target===E.sheet) E.sheet.classList.remove('open'); });

/* ==== Start ==== */
function init(){
  document.getElementById('standard').style.display='flex';
  update();
}
</script>
</body>
</html>
