<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Kalendarz rodzinny</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    :root{--c-ania:#f0fff4;--c-aniaP:#fff1f2;--c-michal:#f0f9ff;--c-michalP:#f5f3ff;--c-wsp:#fffbeb;--c-inne:#f1f5f9;--k-lask:#a7f3d0;--k-brzeziny:#fde68a;--k-ortho:#f9a8d4;--k-jb:#c4b5fd;--k-jb24:#7c3aed;}
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#fef3f8,#f3f4f6);-webkit-font-smoothing:antialiased;margin:0;padding:0;min-height:100vh;overflow-x:hidden;}
    .hdr{background:#fff;border-bottom:1px solid #e5e7eb;padding:.75rem 1rem;box-shadow:0 1px 3px rgba(0,0,0,.08);position:sticky;top:0;z-index:100;}
    .grid{display:grid;grid-template-columns:64px repeat(6,1fr);border-top:1px solid #e5e7eb}
    .cell{border-bottom:1px solid #e5e7eb;border-left:1px solid #e5e7eb;min-height:60px;position:relative;padding:4px}
    .cell:nth-child(7n+1){border-left:none}
    .cell.header{background:#f9fafb;font-weight:600}
    .fld{height:100%;padding:6px;border-radius:10px;font-size:.9rem;line-height:1.35;cursor:pointer;word-break:break-word;}
    .c-ania{background:var(--c-ania)} .c-aniaP{background:var(--c-aniaP)} .c-michal{background:var(--c-michal)} .c-michalP{background:var(--c-michalP)} .c-wsp{background:var(--c-wsp)} .c-inne{background:var(--c-inne)}
    .tile-ortho{background:var(--k-ortho)!important;font-weight:600} .tile-brzeziny{background:var(--k-brzeziny)!important;font-weight:600} .tile-lask{background:var(--k-lask)!important;font-weight:600} .tile-jb{background:var(--k-jb)!important;font-weight:600} .tile-jb24{background:var(--k-jb24)!important;color:#fff;font-weight:700}
    
    #edit{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:2500;display:none;align-items:center;justify-content:center;padding:1rem;}
    .edit-body{background:white;border-radius:16px;width:100%;max-width:500px;max-height:90vh;display:flex;flex-direction:column;overflow:hidden;}
    .edit-head{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid #e5e7eb;background:#f9fafb;}
    .edit-title{font-weight:700;color:#1f2937;margin:0;}
    .edit-close{width:32px;height:32px;border:none;background:none;font-size:18px;color:#6b7280;cursor:pointer;border-radius:6px;}
    .edit-content{padding:1rem;overflow-y:auto;flex:1;}
    .edit-foot{padding:1rem;border-top:1px solid #e5e7eb;background:#f9fafb;}
    .form-group{margin-bottom:1rem;}
    .form-label{display:block;font-size:.85rem;font-weight:600;color:#374151;margin-bottom:.5rem;}
    .form-input{width:100%;padding:.75rem;border:2px solid #e5e7eb;border-radius:10px;font-size:.9rem;font-weight:500;}
    .hours-control{margin:1rem 0;padding:1rem;background:#f8fafc;border-radius:16px;border:2px solid #e2e8f0;}
  </style>
</head>
<body>
  <div id="app-container">
    <header class="hdr">
        <div class="flex flex-wrap items-center justify-between gap-3">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-pink-300 to-purple-400 grid place-items-center shadow">
                    <span class="text-white font-black">🌸</span>
                </div>
                <div>
                    <div class="font-extrabold text-slate-900">Kalendarz rodzinny</div>
                    <div class="text-slate-500 text-sm -mt-1">Kalendarz</div>
                </div>
            </div>
            <div class="flex items-center gap-4 flex-wrap">
                <button id="prev" class="p-3 rounded-xl hover:bg-gray-100">Poprzedni</button>
                <h2 id="title" class="font-bold text-slate-800 min-w-[180px] text-center text-lg">—</h2>
                <button id="next" class="p-3 rounded-xl hover:bg-gray-100">Następny</button>
                <button id="today" class="px-4 py-2.5 text-sm font-semibold text-gray-700 bg-white border border-gray-300 rounded-xl">Dziś</button>
                <div class="flex items-center gap-2 border border-gray-200 rounded-xl p-2 ml-8">
                    <button id="connectOnedriveBtn" class="px-3 py-2 text-sm font-semibold text-white bg-blue-600 rounded-md">Połącz z OneDrive</button>
                    <button id="forceSyncBtn" class="px-3 py-2 text-sm font-semibold text-white bg-green-600 rounded-md" disabled>🔄 Odśwież</button>
                    <div id="syncStatus" class="text-sm text-gray-500"></div>
                </div>
            </div>
        </div>
    </header>
    <main class="w-full bg-white flex flex-col flex-grow">
      <div id="desk" class="grid"></div>
    </main>
    <div id="edit">
      <div class="edit-body">
        <div class="edit-head">
          <h3 id="edit-title" class="edit-title">Edycja</h3>
          <button id="edit-close" class="edit-close">✕</button>
        </div>
        <div id="edit-content" class="edit-content"></div>
        <div class="edit-foot">
          <button id="edit-save" class="px-4 py-2.5 text-sm font-semibold text-white bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg">Zapisz</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAgHtQFaHXlPweFU90GKGW2Jx0fl23VRkQ",
      authDomain: "kalendarz-rodzinny-68d04.firebaseapp.com",
      projectId: "kalendarz-rodzinny-68d04",
      storageBucket: "kalendarz-rodzinny-68d04.appspot.com",
      messagingSenderId: "1050937545151",
      appId: "1:1050937545151:web:a85fd1a5f066f4a499910a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let cur = new Date();
    let data = {};
    const fields = ['ania', 'aniaPraca', 'michal', 'michalPraca', 'wspolne', 'inne'];
    const labels = { ania: 'Ania', aniaPraca: 'Ania Praca', michal: 'Michał', michalPraca: 'Michał Praca', wspolne: 'Niania', inne: 'Inne' };
    const mNames = ['Styczeń','Luty','Marzec','Kwiecień','Maj','Czerwiec','Lipiec','Sierpień','Wrzesień','Październik','Listopad','Grudzień'];
    const dShort = ['PN','WT','ŚR','CZ','PT','SB','ND'];
    
    const E = {
      title: document.getElementById('title'),
      prev: document.getElementById('prev'),
      next: document.getElementById('next'),
      today: document.getElementById('today'),
      desk: document.getElementById('desk'),
      edit: document.getElementById('edit'),
      editTitle: document.getElementById('edit-title'),
      editContent: document.getElementById('edit-content'),
      editClose: document.getElementById('edit-close'),
      editSave: document.getElementById('edit-save'),
      connectOnedriveBtn: document.getElementById('connectOnedriveBtn'),
      forceSyncBtn: document.getElementById('forceSyncBtn'),
      syncStatus: document.getElementById('syncStatus')
    };
    
    const getFieldClass = (field) => ({ aniaPraca: 'c-aniaP', michalPraca: 'c-michalP', wspolne: 'c-wsp' }[field] || `c-${field}`);
    const getTileClass = t => {
      if (!t) return '';
      const s = t.toLowerCase();
      if (s.includes('ortho')) return 'tile-ortho';
      if (s.includes('brzeziny')) return 'tile-brzeziny';
      if (s.includes('łask')) return 'tile-lask';
      if (s.startsWith('jb')) return 'tile-jb';
      return '';
    };

    async function makeAuthenticatedRequest(url, body) {
        const user = auth.currentUser;
        if (!user) throw new Error("Użytkownik nie jest zalogowany.");
        const token = await user.getIdToken();
        const response = await fetch(url, {
            method: 'POST',
            mode: 'cors',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`},
            body: JSON.stringify(body)
        });
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Błąd serwera (${response.status}): ${errorText}`);
        }
        return response.json();
    }

    const save = async (day, field, valueObject) => {
        try {
            await makeAuthenticatedRequest('https://europe-central2-kalendarz-rodzinny-68d04.cloudfunctions.net/updateCell', {
                day, field, value: valueObject,
                month: cur.getMonth() + 1, year: cur.getFullYear()
            });
        } catch (error) {
            console.warn('Błąd zapisu do Excela, zapisuję w Firestore:', error);
            E.syncStatus.textContent = '⚠️ Błąd zapisu do Excela';
            try {
                await db.collection(`${cur.getFullYear()}-${cur.getMonth() + 1}`).doc(String(day)).set({ [field]: valueObject }, { merge: true });
            } catch (fbError) {
                alert('Krytyczny błąd zapisu: ' + fbError.message);
                return;
            }
        }
        if (!data[day]) data[day] = {};
        data[day][field] = valueObject;
        render();
    };
    
    const render = () => {
        E.desk.innerHTML = '';
        const days = new Date(cur.getFullYear(), cur.getMonth() + 1, 0).getDate();
        for (let d = 1; d <= days; d++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'cell';
            dayCell.innerHTML = `<div class="day-num">${d}</div><div class="day-name">${dShort[(new Date(cur.getFullYear(), cur.getMonth(), d).getDay() + 6) % 7]}</div>`;
            E.desk.appendChild(dayCell);
            for (const f of fields) {
                const entry = data[d]?.[f] || {};
                const text = typeof entry === 'object' ? entry.text || '' : entry;
                const cell = document.createElement('div');
                cell.className = `cell ${getFieldClass(f)}`;
                const fld = document.createElement('div');
                fld.className = `fld ${getTileClass(text)}`;
                fld.textContent = text;
                fld.onclick = () => openEdit(d, f);
                cell.appendChild(fld);
                E.desk.appendChild(cell);
            }
        }
    };

    function openEdit(day, field) {
        const entry = data[day]?.[field] || {};
        const text = typeof entry === 'object' ? entry.text || '' : entry;
        E.editTitle.textContent = `${labels[field]} — ${day} ${mNames[cur.getMonth()]}`;
        
        let formHTML = `<div class="form-group"><label class="form-label">Treść wpisu</label><input type="text" id="editText" class="form-input" value="${text}"></div>`;
        if (field === 'michalPraca') {
            formHTML += `
                <div class="hours-control">
                    <label class="form-label">Porty</label>
                    <input type="number" id="editPortsI" class="form-input" placeholder="Założenie" value="${entry.ports_i || ''}">
                    <input type="number" id="editPortsR" class="form-input mt-2" placeholder="Usunięcie" value="${entry.ports_r || ''}">
                </div>
                <div class="hours-control">
                    <label class="form-label">Inne procedury</label>
                    <input type="number" id="editEndoOD" class="form-input" placeholder="Jednodniówki" value="${entry.endo_od || ''}">
                    <input type="number" id="editEndoQ" class="form-input mt-2" placeholder="Kwalifikacje" value="${entry.endo_q || ''}">
                    <input type="number" id="editKomercja" class="form-input mt-2" placeholder="Komercja" value="${entry.komercja || ''}">
                </div>`;
        }
        E.editContent.innerHTML = formHTML;
        
        E.editSave.onclick = async () => {
            const newText = document.getElementById('editText').value.trim();
            const finalData = { text: newText };
            if (field === 'michalPraca') {
                const getVal = id => parseInt(document.getElementById(id).value) || 0;
                finalData.ports_i = getVal('editPortsI');
                finalData.ports_r = getVal('editPortsR');
                finalData.endo_od = getVal('editEndoOD');
                finalData.endo_q = getVal('editEndoQ');
                finalData.komercja = getVal('editKomercja');
            }
            await save(day, field, finalData.text && Object.keys(finalData).length === 1 ? finalData.text : finalData);
            E.edit.style.display = 'none';
        };
        E.edit.style.display = 'flex';
    }

    const loadData = async () => {
        E.syncStatus.textContent = 'Pobieram dane...';
        try {
            const excelData = await makeAuthenticatedRequest('https://europe-central2-kalendarz-rodzinny-68d04.cloudfunctions.net/getData', { month: cur.getMonth() + 1, year: cur.getFullYear() });
            data = excelData || {};
            E.syncStatus.textContent = '✅ Dane aktualne';
            render();
        } catch (error) {
            console.warn('Błąd pobierania z Excela, używam Firestore:', error);
            E.syncStatus.textContent = '⚠️ Używam danych offline';
            db.collection(`${cur.getFullYear()}-${cur.getMonth() + 1}`).onSnapshot(snapshot => {
                data = {};
                snapshot.forEach(doc => data[doc.id] = doc.data());
                render();
            });
        }
    };

    const update = () => {
        E.title.textContent = `${mNames[cur.getMonth()]} ${cur.getFullYear()}`;
        loadData();
    };

    E.prev.onclick = () => { cur.setMonth(cur.getMonth() - 1); update(); };
    E.next.onclick = () => { cur.setMonth(cur.getMonth() + 1); update(); };
    E.today.onclick = () => { cur = new Date(); update(); };
    E.editClose.onclick = () => E.edit.style.display = 'none';
    E.connectOnedriveBtn.onclick = () => window.location.href = "https://europe-central2-kalendarz-rodzinny-68d04.cloudfunctions.net/auth";

    E.forceSyncBtn.onclick = async () => {
        E.syncStatus.textContent = 'Synchronizuję...';
        E.forceSyncBtn.disabled = true;
        try {
            const response = await makeAuthenticatedRequest('https://europe-central2-kalendarz-rodzinny-68d04.cloudfunctions.net/sync', {});
            E.syncStatus.textContent = `✅ ${response.message || 'Zsynchronizowano!'}`;
            setTimeout(loadData, 1000);
        } catch (error) {
            E.syncStatus.textContent = '❌ Błąd synchronizacji';
            alert(`Błąd: ${error.message}`);
        } finally {
            E.forceSyncBtn.disabled = false;
        }
    };

    auth.onAuthStateChanged(async (user) => {
        if (!user) await auth.signInAnonymously();
        console.log('Zalogowano jako:', auth.currentUser.uid);
        const doc = await db.collection('onedrive_config').doc('user_token').get();
        if (doc.exists) {
            E.syncStatus.textContent = '✅ Połączono';
            E.connectOnedriveBtn.textContent = 'Połącz ponownie';
            E.forceSyncBtn.disabled = false;
        } else {
            E.syncStatus.textContent = '❌ Brak połączenia';
        }
        update();
    });
  </script>
</body>
</html>
