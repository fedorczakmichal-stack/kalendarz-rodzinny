<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kalendarz Rodziny Fedorczak</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #fef3f8 0%, #f3f4f6 100%);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation;
        }

        /* --- LOGO --- */
        .flower-logo {
            width: 44px; height: 44px; border-radius: 50%;
            background: linear-gradient(135deg, #f9a8d4 0%, #c084fc 100%);
            display:flex; align-items:center; justify-content:center; position:relative;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,.1);
        }
        .flower-petal { position:absolute; width:10px; height:14px; background:#fff; border-radius:50% 0; opacity:.9; }
        .flower-petal:nth-child(1){transform:rotate(0deg) translateY(-9px)}
        .flower-petal:nth-child(2){transform:rotate(72deg) translateY(-9px)}
        .flower-petal:nth-child(3){transform:rotate(144deg) translateY(-9px)}
        .flower-petal:nth-child(4){transform:rotate(216deg) translateY(-9px)}
        .flower-petal:nth-child(5){transform:rotate(288deg) translateY(-9px)}
        .flower-center{width:10px;height:10px;background:#fbbf24;border-radius:50%;z-index:10;position:relative}

        #app-container { display:flex; flex-direction:column; height:100vh; width:100%; }

        /* --- HEADER --- */
        .modern-header { background:#fff; border-bottom:1px solid #e2e8f0; padding:.75rem 1rem; flex-shrink:0; box-shadow:0 1px 3px 0 rgba(0,0,0,.1); }
        .header-content{max-width:100%; margin:0 auto; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:.75rem;}
        .brand{display:flex; align-items:center; gap:.75rem}
        .brand-text h1{font-size:1.25rem; font-weight:700; color:#1a202c; margin:0; line-height:1.1;}
        .brand-text p{font-size:.875rem; color:#64748b; margin:0; margin-top:2px;}

        .view-toggle {
            display:flex; gap:.25rem; background:#fff; padding:.25rem; border:1px solid #e5e7eb; border-radius:.75rem;
        }
        .view-btn {
            display:flex; align-items:center; justify-content:center;
            width:40px; height:40px; border-radius:.5rem; border:1px solid transparent;
            transition:all .15s; cursor:pointer;
        }
        .view-btn:hover { background:#f3f4f6; }
        .view-btn.active { background:#ede9fe; border-color:#8b5cf6; }
        .view-btn svg { width:20px; height:20px; color:#475569; }

        .header-actions { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }

        @media (max-width:768px){
            .modern-header{padding:.5rem}
            .header-content{justify-content:center}
            .brand-text h1{font-size:1.1rem}
            .header-actions{width:100%; justify-content:center; margin-top:.5rem}
            .header-actions button{padding:.6rem .8rem; font-size:.8rem; min-height:40px; min-width:40px}
            #month-year-display{font-size:1rem; width:auto; min-width:140px}
        }

        /* --- DESKTOP GRID --- */
        .calendar-grid{display:grid; grid-template-columns:minmax(80px,.5fr) repeat(6,1fr); border-top:1px solid #E5E7EB;}
        .calendar-cell{border-bottom:1px solid #E5E7EB; border-left:1px solid #E5E7EB; min-height:60px; position:relative; padding:4px;}
        .calendar-cell:first-child,.calendar-cell:nth-child(7n + 1){border-left:none}
        .calendar-cell.header{min-height:auto; font-weight:600; background:#F9FAFB;}
        .day-info-cell{cursor:pointer}
        .day-info{text-align:center; font-weight:600; position:relative; z-index:2}
        .day-number{font-size:1.25rem; color:#374151}
        .day-name{font-size:.75rem; color:#6B7280}
        .today .day-info{background:linear-gradient(135deg,#60a5fa 0%,#a78bfa 100%); color:#fff; border-radius:12px; padding:4px 0; box-shadow:0 2px 4px rgba(0,0,0,.1)}
        .day-off::before{content:''; position:absolute; inset:0; background:linear-gradient(135deg,rgba(219,39,119,.15) 0%,rgba(147,51,234,.15) 100%); z-index:1;}

        .editable-field{font-size:.9rem; line-height:1.4; padding:4px; border-radius:8px; height:100%; cursor:pointer; position:relative; z-index:2; user-select:none; word-wrap:break-word; overflow-wrap:break-word; transition:all .2s;}
        .editable-field.selected{outline:2px solid #8b5cf6; background:rgba(139,92,246,.1)!important;}
        .editable-field:hover{background:rgba(147,197,253,.15); transform:translateY(-1px)}
        .duty-shift{font-weight:600}
        .editable-field textarea{width:100%; height:100%; border:none; background:#fff; resize:none; padding:4px; margin:0; outline:none; border-radius:8px; box-shadow:0 0 0 2px #8b5cf6; position:absolute; inset:0; font-size:.9rem;}
        .char-counter{position:absolute; bottom:2px; right:4px; font-size:.65rem; color:#9ca3af; background:rgba(255,255,255,.95); padding:2px 4px; border-radius:4px;}
        .char-counter.warning{color:#f59e0b}
        .char-counter.error{color:#ef4444; font-weight:600}

        /* --- KOLORY --- */
        .color-ania{background:#ffe4e6}
        .color-aniaPraca{background:#fed7aa}
        .color-michal{background:#cce7ff}
        .color-michalPraca{background:#ddd6fe}
        .color-wspolne{background:#d1fae5}
        .color-inne{background:#fef3c7}
        .medium-duty.color-ania{background:#fecdd3!important}
        .medium-duty.color-aniaPraca{background:#fdba74!important}
        .medium-duty.color-michal{background:#93c5fd!important}
        .medium-duty.color-michalPraca{background:#c4b5fd!important}
        .medium-duty.color-wspolne{background:#a7f3d0!important}
        .medium-duty.color-inne{background:#fde68a!important}
        .full-duty.color-ania{background:#fca5a5!important}
        .full-duty.color-aniaPraca{background:#fb923c!important}
        .full-duty.color-michal{background:#60a5fa!important}
        .full-duty.color-michalPraca{background:#a78bfa!important}
        .full-duty.color-wspolne{background:#86efac!important}
        .full-duty.color-inne{background:#fcd34d!important}
        .location-lask{background:#f9a8d4!important; font-weight:600}
        .location-other{background:#fdba74!important; font-weight:600}

        /* --- MOBILE LIST --- */
        .mobile-calendar{display:none; padding:1rem;}
        @media (max-width:768px){
            .calendar-grid{display:none}
            .mobile-calendar{display:block!important}
            .mobile-day-card{background:#fff; border-radius:12px; padding:1rem; margin-bottom:1rem; box-shadow:0 2px 4px rgba(0,0,0,.05); border:1px solid #e5e7eb;}
            .mobile-day-card.weekend{background:linear-gradient(135deg,rgba(219,39,119,.08) 0%,rgba(147,51,234,.08) 100%); border:1px solid rgba(219,39,119,.2)}
            .mobile-day-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:.75rem; padding-bottom:.5rem; border-bottom:2px solid #f3f4f6;}
            .mobile-day-number{font-size:1.5rem; font-weight:700; color:#1f2937}
            .mobile-day-name{font-size:.875rem; color:#6b7280; font-weight:500}
            .mobile-events{display:flex; flex-direction:column; gap:.5rem}
            .mobile-event-row{display:flex; align-items:stretch; gap:.5rem; min-height:44px}
            .mobile-event-label{flex:0 0 90px; font-size:.75rem; font-weight:600; padding:.5rem; border-radius:8px; display:flex; align-items:center; color:#4b5563}
            .mobile-event-content{flex:1; padding:.5rem; border-radius:8px; font-size:.875rem; min-height:44px; display:flex; align-items:center; cursor:pointer; transition:all .2s}
            .mobile-event-content:active{transform:scale(.98)}
            /* NIE ROZCIĄGAĆ – przytnij do 2 linii */
            .mobile-event-content .event-text{
                display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
                overflow:hidden; line-height:1.2; width:100%;
            }
        }

        /* --- COMPACT OVERVIEW --- */
        #compact-view{display:none; padding:1rem; overflow-y:auto}
        .overview-container{max-width:1200px; margin:0 auto}
        .overview-day-card{background:#fff; border:1px solid #E5E7EB; border-radius:12px; padding:1rem; margin-bottom:1rem; cursor:pointer; transition:.2s}
        .overview-day-card:hover{transform:translateY(-2px); box-shadow:0 4px 6px -1px rgba(0,0,0,.1)}
        .overview-day-card.weekend{background:linear-gradient(135deg,rgba(219,39,119,.08) 0%,rgba(147,51,234,.08) 100%); border:1px solid rgba(219,39,119,.2)}
        .overview-day-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:.75rem; padding-bottom:.5rem; border-bottom:2px solid #f3f4f6}
        .overview-day-info{display:flex; align-items:center; gap:.5rem}
        .overview-day-number{font-size:1.5rem; font-weight:700; color:#1f2937}
        .overview-day-name{font-size:.875rem; color:#6b7280; font-weight:500}
        .overview-events-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:.5rem}
        .overview-event-item{padding:6px 10px; border-radius:6px; font-size:.8rem; display:flex; flex-direction:column; gap:2px}
        .overview-event-label{font-weight:600; font-size:.7rem; opacity:.7}
        .overview-event-text{word-wrap:break-word}

        /* --- MONTH VIEW --- */
        #month-view{display:none; padding:1rem; overflow-y:auto}
        .month-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:1px; background:#e5e7eb; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden}
        .month-header-cell{background:#f9fafb; padding:.75rem .5rem; text-align:center; font-weight:600; font-size:.875rem; color:#6b7280}
        .month-day-cell{background:#fff; min-height:100px; padding:.5rem; position:relative; cursor:pointer; transition:.2s; overflow:hidden; contain:layout paint;}
        .month-day-cell:hover{background:#f9fafb}
        .month-day-cell.other-month{background:#fcfcfc; opacity:.5}
        .month-day-cell.weekend{background:linear-gradient(135deg,rgba(219,39,119,.05) 0%,rgba(147,51,234,.05) 100%)}
        .month-day-cell.today{background:#ede9fe; border:2px solid #8b5cf6}
        .month-day-number{font-weight:600; font-size:.875rem; color:#374151; margin-bottom:.25rem}
        .month-day-events{display:flex; flex-direction:column; gap:2px}
        .month-event-item{
            font-size:.65rem; padding:2px 4px; border-radius:4px;
            white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%;
        }
        @media (max-width:768px){
            .month-day-cell{min-height:70px; padding:.25rem}
            .month-day-number{font-size:.75rem}
            .month-event-item{font-size:.6rem; padding:1px 2px}
        }

        /* --- MODALE, MENU, LOADER --- */
        #context-menu{position:fixed; background:#fff; border-radius:12px; box-shadow:0 10px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,.04); z-index:1000; min-width:150px; padding:6px; display:none; border:1px solid #e5e7eb;}
        .context-menu-item{padding:10px 14px; font-size:.875rem; color:#374151; cursor:pointer; display:flex; align-items:center; gap:8px; transition:background-color .2s; border-radius:8px}
        .context-menu-item:hover{background:#f9fafb}
        .context-menu-separator{height:1px; background:#e5e7eb; margin:4px 0}

        #loading{display:flex; align-items:center; justify-content:center; padding:3rem}
        .loading-spinner{width:40px; height:40px; border:3px solid #f3f4f6; border-top:3px solid #8b5cf6; border-radius:50%; animation:spin 1s linear infinite}
        @keyframes spin {0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

        #bulk-actions{background:#fff; border-radius:12px; box-shadow:0 20px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,.04); border:1px solid #e5e7eb;}
        @media (max-width:768px){
            #bulk-actions{bottom:80px; left:50%; transform:translateX(-50%); width:calc(100% - 2rem); max-width:350px;}
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- HEADER -->
        <header class="modern-header">
            <div class="header-content">
                <div class="brand">
                    <div class="flower-logo">
                        <div class="flower-petal"></div>
                        <div class="flower-petal"></div>
                        <div class="flower-petal"></div>
                        <div class="flower-petal"></div>
                        <div class="flower-petal"></div>
                        <div class="flower-center"></div>
                    </div>
                    <div class="brand-text">
                        <h1>Rodzina Fedorczak</h1>
                        <p>Kalendarz 🌸</p>
                    </div>
                </div>

                <div class="header-actions">
                    <button id="prev-month" class="p-2 rounded-lg hover:bg-gray-100 transition-colors" title="Poprzedni miesiąc">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    </button>

                    <h2 id="month-year-display" class="text-base md:text-lg font-semibold text-gray-700 text-center">Ładowanie...</h2>

                    <button id="next-month" class="p-2 rounded-lg hover:bg-gray-100 transition-colors" title="Następny miesiąc">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                    </button>

                    <button id="today-btn" class="px-3 py-2 text-sm font-semibold text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50">Dziś</button>

                    <!-- NOWE: trzy osobne ikony widoków -->
                    <div class="view-toggle" role="tablist" aria-label="Przełącz widok">
                        <button id="btn-view-standard" class="view-btn active" title="Widok normalny" aria-label="Widok normalny" data-view="standard" role="tab" aria-selected="true">
                            <!-- Ikona: siatka kolumn (tabela) -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M9 4v16M15 4v16M3 10h18M3 14h18"/></svg>
                        </button>
                        <button id="btn-view-compact" class="view-btn" title="Widok kompaktowy" aria-label="Widok kompaktowy" data-view="compact" role="tab" aria-selected="false">
                            <!-- Ikona: lista -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
                        </button>
                        <button id="btn-view-month" class="view-btn" title="Widok miesięczny" aria-label="Widok miesięczny" data-view="month" role="tab" aria-selected="false">
                            <!-- Ikona: kalendarz -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="5" width="18" height="16" rx="2"/><path d="M8 3v4M16 3v4M3 11h18"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main id="app" class="w-full bg-white flex flex-col flex-grow">
            <div id="main-view" class="overflow-auto flex-1 flex flex-col">
                <!-- Desktop -->
                <div id="calendar-wrapper" class="overflow-auto flex-1 hidden md:block">
                    <div id="calendar-container" class="bg-white border-t min-w-[900px]">
                        <div class="calendar-grid font-semibold text-sm text-center text-gray-700 sticky top-0 bg-white z-10">
                            <div class="calendar-cell header p-3">Dzień</div>
                            <div class="calendar-cell header p-3 color-ania">Ania</div>
                            <div class="calendar-cell header p-3 color-aniaPraca">Ania Praca</div>
                            <div class="calendar-cell header p-3 color-michal">Michał</div>
                            <div class="calendar-cell header p-3 color-michalPraca">Michał Praca</div>
                            <div class="calendar-cell header p-3 color-wspolne">Wspólne</div>
                            <div class="calendar-cell header p-3 color-inne">Dom/Finanse</div>
                        </div>
                        <div id="calendar-body" class="calendar-grid"></div>
                    </div>
                </div>
                <!-- Mobile list -->
                <div id="mobile-calendar" class="mobile-calendar md:hidden"></div>
            </div>

            <!-- Widok kompaktowy -->
            <div id="compact-view">
                <div class="overview-container"></div>
            </div>

            <!-- Widok miesięczny -->
            <div id="month-view">
                <div class="month-grid"></div>
            </div>

            <div id="loading" class="text-center p-8 text-gray-500 font-semibold">
                <div class="loading-spinner"></div>
            </div>
        </main>
    </div>

    <!-- Menu kontekstowe -->
    <div id="context-menu" class="context-menu">
        <div id="copy-btn" class="context-menu-item">Kopiuj</div>
        <div id="paste-btn" class="context-menu-item">Wklej</div>
        <div class="context-menu-separator"></div>
        <div id="delete-btn" class="context-menu-item text-red-600">Usuń</div>
    </div>

    <!-- Panel akcji masowych -->
    <div id="bulk-actions" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 bg-white px-4 py-3 rounded-lg shadow-2xl z-20 flex items-center gap-4">
        <span id="selection-count" class="text-sm font-medium text-gray-700"></span>
        <button id="bulk-delete-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md text-sm">Usuń</button>
        <button id="clear-selection-btn" class="text-gray-500 hover:text-gray-700 p-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
    </div>

    <!-- Modal edycji dnia -->
    <div id="day-edit-modal" class="day-edit-modal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:2000;padding:1rem;">
        <div class="day-edit-content" style="background:#fff;border-radius:16px;max-width:600px;width:100%;max-height:80vh;overflow:auto;padding:1.5rem;">
            <div class="day-edit-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:2px solid #f3f4f6;">
                <h3 class="day-edit-title" style="font-size:1.5rem;font-weight:700;color:#1f2937">Edycja dnia</h3>
                <div class="day-edit-close" onclick="closeDayEdit()" style="width:32px;height:32px;border-radius:8px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.2s">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </div>
            </div>
            <div class="day-edit-fields" id="day-edit-fields" style="display:flex;flex-direction:column;gap:1rem;"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, updateDoc, deleteField, writeBatch, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase ---
        const userFirebaseConfig = {
            apiKey: "AIzaSyAgHtQFaHXlPweFU90GKGW2Jx0fl23VRkQ",
            authDomain: "kalendarz-rodzinny-68d04.firebaseapp.com",
            projectId: "kalendarz-rodzinny-68d04",
            storageBucket: "kalendarz-rodzinny-68d04.appspot.com",
            messagingSenderId: "1050937545151",
            appId: "1:1050937545151:web:a85fd1a5f066f4a499910a",
            measurementId: "G-57YKE2XKQ1"
        };

        let db;
        try {
            const app = initializeApp(userFirebaseConfig);
            const auth = getAuth(app);
            db = getFirestore(app);
            signInAnonymously(auth);
            onAuthStateChanged(auth, user => user && initCalendar());
        } catch (error) { console.error("Firebase Error:", error); }

        // --- State ---
        let currentDate = new Date();
        let unsubscribe = () => {};
        let clipboard = null;
        let contextTarget = null;
        const selected = new Set();
        let currentView = 'standard'; // 'standard', 'compact', 'month'
        let isMobile = window.innerWidth <= 768;
        let currentEditDay = null;
        let currentEvents = {};
        const MAX_CHARS = 50;

        // --- DOM ---
        const dom = {
            monthYear: document.getElementById('month-year-display'),
            prevBtn: document.getElementById('prev-month'),
            nextBtn: document.getElementById('next-month'),
            todayBtn: document.getElementById('today-btn'),
            mainView: document.getElementById('main-view'),
            compactView: document.getElementById('compact-view'),
            monthView: document.getElementById('month-view'),
            container: document.getElementById('calendar-container'),
            mobileCalendar: document.getElementById('mobile-calendar'),
            body: document.getElementById('calendar-body'),
            loading: document.getElementById('loading'),
            contextMenu: document.getElementById('context-menu'),
            copyBtn: document.getElementById('copy-btn'),
            pasteBtn: document.getElementById('paste-btn'),
            deleteBtn: document.getElementById('delete-btn'),
            bulkActions: document.getElementById('bulk-actions'),
            selectionCount: document.getElementById('selection-count'),
            bulkDelete: document.getElementById('bulk-delete-btn'),
            clearSelection: document.getElementById('clear-selection-btn'),
            dayEditModal: document.getElementById('day-edit-modal'),
            dayEditFields: document.getElementById('day-edit-fields'),
            btnStandard: document.getElementById('btn-view-standard'),
            btnCompact: document.getElementById('btn-view-compact'),
            btnMonth: document.getElementById('btn-view-month'),
        };

        // --- Helpers ---
        const getMonthName = m => ['Styczeń','Luty','Marzec','Kwiecień','Maj','Czerwiec','Lipiec','Sierpień','Wrzesień','Październik','Listopad','Grudzień'][m];
        const getDayName = d => ['PN','WT','ŚR','CZ','PT','SB','ND'][d];
        const getDayFullName = d => ['Poniedziałek','Wtorek','Środa','Czwartek','Piątek','Sobota','Niedziela'][d];
        const fields = ['ania','aniaPraca','michal','michalPraca','wspolne','inne'];
        const fieldLabels = { ania:'Ania', aniaPraca:'Ania Praca', michal:'Michał', michalPraca:'Michał Praca', wspolne:'Wspólne', inne:'Dom/Finanse' };

        const fullDutyKeywords = ['jb oit','jb znieczuleń'];
        const locationLaskKeywords = ['łask'];
        const locationOtherKeywords = ['ortho','brzeziny'];
        const getEventType = (text) => {
            if (!text) return 'default';
            const s = text.toLowerCase();
            if (fullDutyKeywords.some(k=>s.includes(k))) return 'full-duty';
            if (s.startsWith('jb')) return 'medium-duty';
            if (locationLaskKeywords.some(k=>s.includes(k))) return 'location-lask';
            if (locationOtherKeywords.some(k=>s.includes(k))) return 'location-other';
            return 'default';
        };

        // Responsive flag
        window.addEventListener('resize', () => {
            const wasMobile = isMobile;
            isMobile = window.innerWidth <= 768;
            if (wasMobile !== isMobile) update();
        });

        // --- Renders (desktop) ---
        const renderDesktop = (year, month, events) => {
            dom.loading.style.display = 'none';
            dom.body.innerHTML = '';
            dom.monthYear.textContent = `${getMonthName(month)} ${year}`;

            const daysInMonth = new Date(year, month+1, 0).getDate();
            const today = new Date();
            const frag = document.createDocumentFragment();

            for(let day=1; day<=daysInMonth; day++){
                const date = new Date(year, month, day);
                const dow = date.getDay();
                const isToday = today.toDateString() === date.toDateString();
                const isWeekend = dow===0 || dow===6;
                const dayEvents = events[day] || {};
                const isHoliday = dayEvents.isHoliday || false;
                const isDayOff = isWeekend || isHoliday;

                const dayInfoCell = document.createElement('div');
                dayInfoCell.className = `calendar-cell day-info-cell flex items-center justify-center ${isToday ? 'today':''}`;
                if (isDayOff) dayInfoCell.classList.add('day-off');
                dayInfoCell.dataset.day = day;
                dayInfoCell.innerHTML = `<div class="day-info"><div class="day-number">${day}</div><div class="day-name">${getDayName(dow===0?6:dow-1)}</div></div>`;
                frag.appendChild(dayInfoCell);

                fields.forEach(field=>{
                    const eventText = dayEvents[field] || '';
                    const cell = document.createElement('div');
                    cell.className = `calendar-cell color-${field}`;
                    if (isDayOff) cell.classList.add('day-off');

                    const div = document.createElement('div');
                    div.className = 'editable-field';
                    const type = getEventType(eventText);
                    if (type!=='default'){
                        div.classList.add(type);
                        if (type==='full-duty' || type==='medium-duty') div.classList.add('duty-shift');
                    }

                    const id = `${day}-${field}`;
                    div.dataset.day = day; div.dataset.field = field; div.dataset.cellId = id;
                    if (selected.has(id)) div.classList.add('selected');
                    if (eventText) div.draggable = true;

                    const span = document.createElement('span');
                    span.className = 'event-text';
                    span.textContent = eventText;
                    div.appendChild(span);
                    cell.appendChild(div);
                    frag.appendChild(cell);
                });
            }
            dom.body.appendChild(frag);
        };

        // --- Render mobile list ---
        const renderMobile = (year, month, events) => {
            dom.loading.style.display = 'none';
            dom.mobileCalendar.innerHTML = '';
            dom.monthYear.textContent = `${getMonthName(month)} ${year}`;

            const daysInMonth = new Date(year, month+1, 0).getDate();
            const today = new Date();
            const frag = document.createDocumentFragment();

            for(let day=1; day<=daysInMonth; day++){
                const date = new Date(year, month, day);
                const dow = date.getDay();
                const isToday = today.toDateString() === date.toDateString();
                const isWeekend = dow===0 || dow===6;
                const dayEvents = events[day] || {};
                const isHoliday = dayEvents.isHoliday || false;

                const card = document.createElement('div');
                card.className = `mobile-day-card ${isToday ? 'ring-2 ring-purple-400':''} ${isWeekend||isHoliday ? 'weekend':''}`;

                let html = `
                  <div class="mobile-day-header">
                    <div>
                      <span class="mobile-day-number">${day}</span>
                      <span class="mobile-day-name ml-2">${['Poniedziałek','Wtorek','Środa','Czwartek','Piątek','Sobota','Niedziela'][dow===0?6:dow-1]}</span>
                    </div>
                    ${isToday?'<span class="text-xs bg-gradient-to-r from-purple-500 to-pink-500 text-white px-2 py-1 rounded-full">Dziś</span>':''}
                    ${isHoliday?'<span class="text-xs bg-purple-200 text-purple-700 px-2 py-1 rounded-full">Święto</span>':''}
                  </div>
                  <div class="mobile-events">
                `;
                fields.forEach(field=>{
                    const t = dayEvents[field] || '';
                    const type = getEventType(t);
                    let typeClass = type!=='default' ? (type + (type==='full-duty'||type==='medium-duty'?' duty-shift':'')) : '';
                    html += `
                      <div class="mobile-event-row">
                        <div class="mobile-event-label color-${field}">${fieldLabels[field]}</div>
                        <div class="mobile-event-content color-${field} ${typeClass}" data-day="${day}" data-field="${field}" data-cell-id="${day}-${field}">
                          <span class="event-text">${t || '<span class="text-gray-400">Kliknij aby dodać</span>'}</span>
                        </div>
                      </div>
                    `;
                });
                html += `</div>`;
                card.innerHTML = html;
                frag.appendChild(card);
            }
            dom.mobileCalendar.appendChild(frag);
        };

        // --- Compact view ---
        const renderCompact = async (year, month) => {
            dom.loading.style.display = 'flex';
            const container = dom.compactView.querySelector('.overview-container');
            container.innerHTML = '';
            dom.monthYear.textContent = `${getMonthName(month)} ${year}`;

            const { docs } = await getDocs(collection(db, `${year}-${month+1}`));
            const events = docs.reduce((acc, d)=>({...acc, [d.id]: d.data()}), {});
            currentEvents = events;

            const daysInMonth = new Date(year, month+1, 0).getDate();
            const today = new Date();

            for(let day=1; day<=daysInMonth; day++){
                const date = new Date(year, month, day);
                const dow = date.getDay();
                const isToday = today.toDateString() === date.toDateString();
                const isWeekend = dow===0 || dow===6;
                const dayEvents = events[day] || {};
                const isHoliday = dayEvents.isHoliday || false;

                const card = document.createElement('div');
                card.className = `overview-day-card ${isWeekend||isHoliday?'weekend':''} ${isToday?'ring-2 ring-purple-400':''}`;
                card.dataset.day = day;
                card.onclick = ()=>openDayEdit(day, dayEvents);

                let html = `
                  <div class="overview-day-header">
                    <div class="overview-day-info">
                      <span class="overview-day-number">${day}</span>
                      <span class="overview-day-name">${['Poniedziałek','Wtorek','Środa','Czwartek','Piątek','Sobota','Niedziela'][dow===0?6:dow-1]}</span>
                    </div>
                    <div>
                      ${isToday?'<span class="text-xs bg-gradient-to-r from-purple-500 to-pink-500 text-white px-2 py-1 rounded-full">Dziś</span>':''}
                      ${isHoliday?'<span class="text-xs bg-purple-200 text-purple-700 px-2 py-1 rounded-full ml-2">Święto</span>':''}
                    </div>
                  </div>
                  <div class="overview-events-grid">
                `;
                fields.forEach(field=>{
                    if (dayEvents[field]){
                        const type = getEventType(dayEvents[field]);
                        const cls = type!=='default' ? (type + (type==='full-duty'||type==='medium-duty'?' duty-shift':'')) : '';
                        html += `
                          <div class="overview-event-item color-${field} ${cls}">
                            <div class="overview-event-label">${fieldLabels[field]}</div>
                            <div class="overview-event-text">${dayEvents[field]}</div>
                          </div>
                        `;
                    }
                });
                html += `</div>`;
                card.innerHTML = html;
                container.appendChild(card);
            }

            dom.loading.style.display = 'none';
            setTimeout(()=>{
                const todayCard = container.querySelector('.overview-day-card.ring-2');
                if (todayCard) todayCard.scrollIntoView({behavior:'smooth', block:'center'});
            },100);
        };

        // --- Month view ---
        const renderMonthView = async (year, month) => {
            dom.loading.style.display = 'flex';
            const grid = dom.monthView.querySelector('.month-grid');
            grid.innerHTML = '';
            dom.monthYear.textContent = `${getMonthName(month)} ${year}`;

            const headers = ['Pon','Wt','Śr','Czw','Pt','Sob','Nd'];
            headers.forEach(h=>{
                const el = document.createElement('div');
                el.className = 'month-header-cell';
                el.textContent = h;
                grid.appendChild(el);
            });

            const { docs } = await getDocs(collection(db, `${year}-${month+1}`));
            const events = docs.reduce((acc, d)=>({...acc, [d.id]: d.data()}), {});
            currentEvents = events;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month+1, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = (firstDay.getDay() + 6) % 7; // Pon=0
            const today = new Date();

            for(let i=0;i<startDay;i++){
                const empty = document.createElement('div');
                empty.className = 'month-day-cell other-month';
                grid.appendChild(empty);
            }

            for(let day=1; day<=daysInMonth; day++){
                const date = new Date(year, month, day);
                const dow = date.getDay();
                const isToday = today.toDateString() === date.toDateString();
                const isWeekend = dow===0 || dow===6;
                const dayEvents = events[day] || {};
                const isHoliday = dayEvents.isHoliday || false;

                const cell = document.createElement('div');
                cell.className = `month-day-cell ${isWeekend||isHoliday?'weekend':''} ${isToday?'today':''}`;
                cell.dataset.day = day;
                cell.onclick = ()=>openDayEdit(day, dayEvents);

                let html = `<div class="month-day-number">${day}</div><div class="month-day-events">`;
                let shown = 0;
                for (const field of fields){
                    if (dayEvents[field] && shown < 3){
                        const type = getEventType(dayEvents[field]);
                        const cls = type!=='default' ? type : '';
                        html += `<div class="month-event-item color-${field} ${cls}">${dayEvents[field]}</div>`;
                        shown++;
                    }
                }
                const total = fields.filter(f=>dayEvents[f]).length;
                if (total > 3){
                    html += `<div class="month-event-item" style="font-size:.6rem;color:#6b7280;">+${total-3} więcej</div>`;
                }
                html += `</div>`;
                cell.innerHTML = html;
                grid.appendChild(cell);
            }

            const totalCells = startDay + daysInMonth;
            const rows = Math.ceil(totalCells/7);
            const target = rows*7;
            for(let i=totalCells; i<target; i++){
                const empty = document.createElement('div');
                empty.className = 'month-day-cell other-month';
                grid.appendChild(empty);
            }

            dom.loading.style.display = 'none';
        };

        // --- Edit day modal ---
        window.openDayEdit = (day, dayEvents) => {
            currentEditDay = day;
            const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
            const dow = date.getDay();
            document.querySelector('.day-edit-title').textContent =
              `${day} ${getMonthName(currentDate.getMonth())} - ${['Poniedziałek','Wtorek','Środa','Czwartek','Piątek','Sobota','Niedziela'][dow===0?6:dow-1]}`;

            dom.dayEditFields.innerHTML = '';
            fields.forEach(field=>{
                const wrap = document.createElement('div');
                wrap.className = 'day-edit-field';
                const value = (dayEvents[field]||'');
                const type = getEventType(value);
                wrap.innerHTML = `
                    <label class="day-edit-label color-${field}" style="font-weight:600;font-size:.875rem;padding:.5rem;border-radius:8px;color:#4b5563">${fieldLabels[field]}</label>
                    <input type="text" class="day-edit-input ${type!=='default'?type:''}" data-field="${field}" value="${value}" maxlength="${MAX_CHARS}" placeholder="Kliknij aby dodać" style="width:100%;padding:.75rem;border:1px solid #e5e7eb;border-radius:8px;font-size:.875rem;">
                `;
                dom.dayEditFields.appendChild(wrap);
            });

            dom.dayEditFields.querySelectorAll('.day-edit-input').forEach(input=>{
                input.addEventListener('change', async ()=>{
                    const field = input.dataset.field;
                    const val = input.value.trim();
                    if (!val) await dbDelete(currentEditDay, field);
                    else await dbSave(currentEditDay, field, val);
                    const type = getEventType(val);
                    input.className = `day-edit-input ${type!=='default'?type:''}`;
                });
            });

            dom.dayEditModal.style.display = 'flex';
        };
        window.closeDayEdit = () => {
            dom.dayEditModal.style.display = 'none';
            if (currentView==='compact') renderCompact(currentDate.getFullYear(), currentDate.getMonth());
            else if (currentView==='month') renderMonthView(currentDate.getFullYear(), currentDate.getMonth());
        };
        dom.dayEditModal.addEventListener('click', (e)=>{ if(e.target===dom.dayEditModal) closeDayEdit(); });

        // --- Updates ---
        const update = () => {
            if (!db) return;

            // widoki
            if (currentView==='compact'){ renderCompact(currentDate.getFullYear(), currentDate.getMonth()); return; }
            if (currentView==='month'){ renderMonthView(currentDate.getFullYear(), currentDate.getMonth()); return; }

            // standard
            unsubscribe();
            dom.loading.style.display = 'flex';
            dom.body.innerHTML = '';
            dom.mobileCalendar.innerHTML = '';
            const y = currentDate.getFullYear();
            const m = currentDate.getMonth();
            const id = `${y}-${m+1}`;
            unsubscribe = onSnapshot(collection(db, id), snap=>{
                const events = {}; snap.forEach(d=>events[d.id]=d.data());
                currentEvents = events;
                if (isMobile) renderMobile(y, m, events); else renderDesktop(y, m, events);
            });
        };

        // --- Switch view + active buttons ---
        const setActiveViewButton = () => {
            [dom.btnStandard, dom.btnCompact, dom.btnMonth].forEach(b=>{
                b.classList.remove('active');
                b.setAttribute('aria-selected','false');
            });
            const map = {standard:dom.btnStandard, compact:dom.btnCompact, month:dom.btnMonth};
            map[currentView].classList.add('active');
            map[currentView].setAttribute('aria-selected','true');
        };
        const switchView = (view) => {
            currentView = view;
            dom.mainView.style.display = 'none';
            dom.compactView.style.display = 'none';
            dom.monthView.style.display = 'none';
            if (view==='standard') dom.mainView.style.display = 'flex';
            if (view==='compact') dom.compactView.style.display = 'block';
            if (view==='month') dom.monthView.style.display = 'block';
            setActiveViewButton();
            update();
        };

        // --- Mobile inline edit ---
        const handleMobileEdit = (el) => {
            const cur = el.querySelector('.event-text').textContent;
            const isPH = cur.includes('Kliknij aby dodać');
            const val = isPH ? '' : cur;

            const ta = document.createElement('textarea');
            ta.value = val;
            ta.className = 'w-full p-2 border-2 border-purple-400 rounded-md';
            ta.style.minHeight = '60px';
            el.innerHTML = '';
            el.appendChild(ta);

            const cc = document.createElement('div');
            cc.className = 'char-counter text-xs mt-1';
            el.appendChild(cc);

            const upd = () => {
                const len = ta.value.length;
                cc.textContent = `${len}/${MAX_CHARS}`;
                cc.classList.toggle('text-yellow-500', len > MAX_CHARS-10 && len <= MAX_CHARS);
                cc.classList.toggle('text-red-500', len > MAX_CHARS);
            };
            upd();

            const save = async () => {
                const txt = ta.value.slice(0, MAX_CHARS);
                el.innerHTML = `<span class="event-text">${txt || '<span class="text-gray-400">Kliknij aby dodać</span>'}</span>`;
                if (txt !== val){
                    if (!txt) await dbDelete(el.dataset.day, el.dataset.field);
                    else await dbSave(el.dataset.day, el.dataset.field, txt);
                }
            };
            ta.addEventListener('input', upd);
            ta.addEventListener('blur', save);
            ta.addEventListener('keydown', e=>{
                if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); ta.blur(); }
            });
            ta.focus();
        };

        // --- Desktop edit/select ---
        const handleEdit = (fieldDiv) => {
            const active = document.querySelector('.editable-field textarea');
            if (active && active.parentElement === fieldDiv){ active.blur(); return; }
            if (active) active.blur();

            const span = fieldDiv.querySelector('.event-text');
            const cur = span.textContent;
            span.style.display = 'none';
            fieldDiv.draggable = false;

            const ta = document.createElement('textarea');
            ta.value = cur;

            const cc = document.createElement('div');
            cc.className = 'char-counter';
            fieldDiv.appendChild(cc);

            const upd = ()=>{
                const len = ta.value.length;
                cc.textContent = `${len}/${MAX_CHARS}`;
                cc.classList.toggle('warning', len > MAX_CHARS-10 && len <= MAX_CHARS);
                cc.classList.toggle('error', len > MAX_CHARS);
            };
            upd();
            ta.addEventListener('input', upd);

            const save = async ()=>{
                let txt = ta.value.slice(0, MAX_CHARS);
                ta.remove(); cc.remove(); span.style.display = '';
                if (txt) fieldDiv.draggable = true;
                if (txt !== cur){
                    span.textContent = txt;
                    if (!txt) await dbDelete(fieldDiv.dataset.day, fieldDiv.dataset.field);
                    else await dbSave(fieldDiv.dataset.day, fieldDiv.dataset.field, txt);
                }
            };
            ta.addEventListener('blur', save);
            ta.addEventListener('keydown', e=>{
                if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); ta.blur(); }
                else if (e.key==='Escape'){ ta.remove(); cc.remove(); span.style.display=''; if (cur) fieldDiv.draggable = true; }
            });

            fieldDiv.appendChild(ta);
            ta.focus();
        };

        // --- Listeners (grid + mobile) ---
        document.getElementById('calendar-body').addEventListener('click', e=>{
            const dayInfoCell = e.target.closest('.day-info-cell');
            if (dayInfoCell){ if (e.target.closest('.editable-field')) return; toggleHoliday(dayInfoCell.dataset.day); return; }
            const fieldDiv = e.target.closest('.editable-field');
            if (!fieldDiv){ if (!e.target.closest('#bulk-actions') && !e.target.closest('#context-menu')) clearSelection(); return; }
            if (e.ctrlKey || e.metaKey){ e.preventDefault(); toggleSelection(fieldDiv); }
            else { if (selected.size>0 && !fieldDiv.classList.contains('selected')) clearSelection(); handleEdit(fieldDiv); }
        });

        dom.mobileCalendar.addEventListener('click', e=>{
            const el = e.target.closest('.mobile-event-content');
            if (el) handleMobileEdit(el);
        });

        // --- Context menu ---
        const showContextMenu = (e,target)=>{
            contextTarget = target;
            dom.contextMenu.style.left = `${e.pageX}px`;
            dom.contextMenu.style.top = `${e.pageY}px`;
            dom.contextMenu.style.display = 'block';
        };
        dom.body.addEventListener('contextmenu', e=>{
            e.preventDefault();
            const field = e.target.closest('.editable-field');
            if (field) showContextMenu(e, field);
        });
        dom.mobileCalendar.addEventListener('contextmenu', e=>{
            e.preventDefault();
            const ec = e.target.closest('.mobile-event-content');
            if (ec) showContextMenu(e, ec);
        });
        dom.copyBtn.addEventListener('click', ()=>{ clipboard = contextTarget.querySelector('.event-text').textContent; dom.contextMenu.style.display='none'; });
        dom.pasteBtn.addEventListener('click', ()=>{ if (clipboard) dbSave(contextTarget.dataset.day, contextTarget.dataset.field, clipboard); dom.contextMenu.style.display='none'; });
        dom.deleteBtn.addEventListener('click', ()=>{ dbDelete(contextTarget.dataset.day, contextTarget.dataset.field); dom.contextMenu.style.display='none'; });
        document.addEventListener('click', e=>{ if(!e.target.closest('#context-menu')) dom.contextMenu.style.display='none'; });

        // --- Bulk selection ---
        const toggleSelection = el => { const id = el.dataset.cellId; selected.has(id) ? selected.delete(id) : selected.add(id); el.classList.toggle('selected'); updateBulkUI(); };
        const updateBulkUI = () => { const c = selected.size; if (c>0){ dom.selectionCount.textContent = `Zaznaczono: ${c}`; dom.bulkActions.classList.remove('hidden'); } else dom.bulkActions.classList.add('hidden'); };
        const clearSelection = () => { document.querySelectorAll('.selected').forEach(el=>el.classList.remove('selected')); selected.clear(); updateBulkUI(); };
        dom.bulkDelete.addEventListener('click', async ()=>{
            const batch = writeBatch(db);
            const calendarId = `${currentDate.getFullYear()}-${currentDate.getMonth()+1}`;
            selected.forEach(id=>{
                const [day, field] = id.split('-');
                batch.update(doc(db, calendarId, day), {[field]: deleteField()});
            });
            await batch.commit();
            clearSelection();
        });
        dom.clearSelection.addEventListener('click', clearSelection);

        // --- Drag & drop (desktop) ---
        dom.body.addEventListener('dragstart', e=>{
            const f = e.target.closest('.editable-field');
            if (f && f.draggable) e.dataTransfer.setData('text/plain', f.querySelector('.event-text').textContent);
        });
        dom.body.addEventListener('dragover', e=>{ e.preventDefault(); e.target.closest('.editable-field')?.classList.add('drag-over'); });
        dom.body.addEventListener('dragleave', e=> e.target.closest('.editable-field')?.classList.remove('drag-over'));
        dom.body.addEventListener('drop', e=>{
            e.preventDefault();
            const f = e.target.closest('.editable-field');
            if (f){ f.classList.remove('drag-over'); const t = e.dataTransfer.getData('text/plain'); if (t) dbSave(f.dataset.day, f.dataset.field, t); }
        });

        // --- DB helpers ---
        const dbSave = (day, field, val) => setDoc(doc(db, `${currentDate.getFullYear()}-${currentDate.getMonth()+1}`, String(day)), { [field]: val }, { merge:true });
        const dbDelete = (day, field) => updateDoc(doc(db, `${currentDate.getFullYear()}-${currentDate.getMonth()+1}`, String(day)), { [field]: deleteField() });
        const toggleHoliday = async (day) => {
            const calendarId = `${currentDate.getFullYear()}-${currentDate.getMonth()+1}`;
            const ref = doc(db, calendarId, String(day));
            try{
                const snap = await getDoc(ref);
                const cur = snap.exists() ? (snap.data().isHoliday || false) : false;
                await setDoc(ref, { isHoliday: !cur }, { merge:true });
            }catch(e){ console.error(e); }
        };

        // --- Navigation ---
        const scrollToToday = () => {
            const t = new Date();
            if (t.getMonth()!==currentDate.getMonth() || t.getFullYear()!==currentDate.getFullYear()){ currentDate = new Date(t); update(); }
            setTimeout(()=>{
                if (currentView==='standard'){
                    document.querySelector('.today')?.scrollIntoView({behavior:'smooth', block:'center'});
                    document.querySelector('.mobile-day-card.ring-2')?.scrollIntoView({behavior:'smooth', block:'center'});
                } else if (currentView==='compact'){
                    document.querySelector('#compact-view .overview-day-card.ring-2')?.scrollIntoView({behavior:'smooth', block:'center'});
                } else if (currentView==='month'){
                    document.querySelector('.month-day-cell.today')?.scrollIntoView({behavior:'smooth', block:'center'});
                }
            },100);
        };

        // --- Init ---
        const initCalendar = () => {
            const nav = (d)=>{ currentDate.setMonth(currentDate.getMonth()+d); update(); };
            dom.prevBtn.addEventListener('click', ()=>nav(-1));
            dom.nextBtn.addEventListener('click', ()=>nav(1));
            dom.todayBtn.addEventListener('click', scrollToToday);

            // Nowe przyciski widoków
            [dom.btnStandard, dom.btnCompact, dom.btnMonth].forEach(btn=>{
                btn.addEventListener('click', ()=>{
                    const v = btn.dataset.view;
                    if (currentView!==v) switchView(v);
                });
            });

            // Gesty mobile
            let sx=0, ex=0;
            if (isMobile){
                document.addEventListener('touchstart', e=>{ sx = e.changedTouches[0].screenX; });
                document.addEventListener('touchend', e=>{ ex = e.changedTouches[0].screenX; if (ex < sx - 50) nav(1); if (ex > sx + 50) nav(-1); });
            }

            setActiveViewButton();
            update();
        };
    </script>
</body>
</html>
