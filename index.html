<!DOCTYPE html>
<html lang="en" data-color-mode="auto" data-light-theme="light" data-dark-theme="dark" data-a11y-animated-images="system" data-a11y-link-underlines="true">
  <head>
    <meta charset="utf-8">
    <title>Kalendarz Ania i Michał</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
      :root {
        --fontStack-monospace: "Monaspace Neon", ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace !important;
      }
      .mcal{display:none;padding:.5rem;padding-bottom:calc(.5rem + var(--safe-bottom) + 70px);}
      .view-switcher{display:none;position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid #e5e7eb;padding:.5rem;margin:-.5rem -.5rem .5rem;}
      .view-switcher-inner{display:flex;gap:.25rem;background:#f3f4f6;border-radius:10px;padding:.25rem;}
      .view-btn{flex:1;padding:.5rem;border-radius:8px;font-weight:600;font-size:.8rem;color:#6b7280;background:transparent;border:none;transition:all .2s;}
      .view-btn.active{background:white;color:#8b5cf6;box-shadow:0 2px 4px rgba(0,0,0,.08);}
      @media (max-width:768px){
      .grid{display:none}
      .mcal{display:block}
      .view-switcher{display:block}
      .m-card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:.75rem;margin-bottom:.65rem;box-shadow:0 2px 8px rgba(0,0,0,.06);transition:all .2s;}
      .m-card:active{transform:scale(.98);}
      .m-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:.4rem;padding-bottom:.4rem;border-bottom:1.5px solid #f3f4f6;}
      .m-num{font-size:1.35rem;font-weight:800;color:#1f2937;}
      .m-name{font-size:.75rem;color:#6b7280;margin-left:.25rem;}
      .tag{font-size:.65rem;border-radius:999px;padding:.15rem .4rem;font-weight:600;}
      .m-row{display:flex;gap:.4rem;align-items:stretch;margin:.25rem 0;}
      .m-label{flex:0 0 75px;border-radius:8px;padding:.4rem .45rem;font-weight:600;color:#334155;font-size:.75rem;display:flex;align-items:center;}
      .m-content{flex:1;border-radius:8px;padding:.5rem .6rem;cursor:pointer;position:relative;z-index:2;min-height:34px;display:flex;align-items:center;transition:all .15s;}
      .m-content:active{background-color:rgba(0,0,0,.05);}
      .m-content .txt{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;font-size:.85rem;line-height:1.3;}
      .m-content .placeholder{color:#9ca3af;font-size:.8rem;}
      }
      .m-grid-view{display:none;padding-bottom:calc(1rem + var(--safe-bottom) + 70px);}
      .m-grid-view.active{display:block;}
      .m-cards-view{display:block;}
      .m-cards-view.hidden{display:none;}
      .m-grid-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;margin:-.5rem;}
      .m-grid-table{min-width:600px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;}
      .m-grid-header{display:grid;grid-template-columns:50px repeat(6,1fr);background:#f9fafb;border-bottom:2px solid #e5e7eb;}
      .m-grid-hcell{padding:.5rem .25rem;font-weight:700;font-size:.65rem;text-align:center;border-right:1px solid #e5e7eb;color:#374151;}
      .m-grid-hcell:last-child{border-right:none;}
      .m-grid-row{display:grid;grid-template-columns:50px repeat(6,1fr);border-bottom:1px solid #e5e7eb;}
      .m-grid-row:last-child{border-bottom:none;}
      .m-grid-day{padding:.35rem;font-weight:700;text-align:center;background:#fafbfc;border-right:1px solid #e5e7eb;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;}
      .m-grid-day-num{font-size:.9rem;color:#1f2937;}
      .m-grid-day-name{font-size:.5rem;color:#9ca3af;}
      .m-grid-cell{padding:.25rem;border-right:1px solid #e5e7eb;font-size:.65rem;line-height:1.2;min-height:45px;cursor:pointer;word-break:break-word;display:flex;align-items:center;}
      .m-grid-cell:last-child{border-right:none;}
      .m-grid-off{background:linear-gradient(135deg,rgba(239,68,68,.05),rgba(219,39,119,.05));}
      .m-grid-today .m-grid-day{background:linear-gradient(135deg,#ede9fe,#fce7f3);}
      .m-grid-today .m-grid-day-num{color:#8b5cf6;}
    </style>
  </head>
  <body>
    <div class="max-w-7xl mx-auto px-2 md:px-6 py-4 md:py-8">
      <div class="sticky top-0 z-10 bg-white">
        <div class="flex justify-between items-center py-2 md:py-4">
          <div class="flex items-center">
            <h1 id="title" class="font-bold text-lg md:text-xl text-gray-900"></h1>
            <button id="today-btn" class="ml-2 md:ml-4 px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-semibold hover:bg-gray-200 transition-colors">Dziś</button>
          </div>
          <div class="flex gap-2">
            <button id="prev-btn" class="px-3 py-1 bg-white border border-gray-300 rounded-full text-gray-600 hover:bg-gray-100 transition-colors">Poprzedni</button>
            <button id="next-btn" class="px-3 py-1 bg-white border border-gray-300 rounded-full text-gray-600 hover:bg-gray-100 transition-colors">Następny</button>
          </div>
        </div>
      </div>
      <div id="desktop" class="grid grid-cols-7 gap-px rounded-lg overflow-hidden bg-gray-300 p-px"></div>
      <div id="mob" class="mcal md:hidden">
        <div class="view-switcher">
          <div class="view-switcher-inner">
            <button id="view-cards" class="view-btn active">Widok kart</button>
            <button id="view-grid" class="view-btn">Widok siatki</button>
          </div>
        </div>
        <div id="m-cards-view" class="m-cards-view"></div>
        <div id="m-grid-view" class="m-grid-view">
          <div class="m-grid-wrap">
            <div id="m-grid-table" class="m-grid-table">
              <div class="m-grid-header">
                <div class="m-grid-hcell"></div>
                <div class="m-grid-hcell c-ania">A</div>
                <div class="m-grid-hcell c-aniaP">AP</div>
                <div class="m-grid-hcell c-michal">M</div>
                <div class="m-grid-hcell c-michalP">MP</div>
                <div class="m-grid-hcell c-wsp">N</div>
                <div class="m-grid-hcell c-inne">I</div>
              </div>
              <div id="m-grid-body"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="modal-container" class="fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-75 hidden">
      <div id="modal" class="relative w-full max-w-md mx-auto my-12 p-6 bg-white rounded-lg shadow-xl">
        <h2 id="modal-title" class="text-xl font-bold mb-4"></h2>
        <form id="modal-form">
          <div class="space-y-4">
            <div id="input-container" class="space-y-2"></div>
            <div class="flex justify-between items-center mt-4">
              <span id="sum-text" class="text-gray-600 text-sm"></span>
              <div>
                <button type="button" id="modal-close-btn" class="px-4 py-2 text-gray-600 rounded-md hover:bg-gray-100">Zamknij</button>
                <button type="submit" id="modal-save-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Zapisz</button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
    <div id="status" class="fixed bottom-0 left-0 w-full bg-blue-600 text-white text-center py-2 z-50 transform translate-y-full transition-transform"></div>
    <script>
      const firebaseConfig = {
        // Twoja konfiguracja Firebase
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const fields = ['ania', 'aniaP', 'michal', 'michalP', 'wsp', 'inne'];
      const labels = { ania: 'Ania', aniaP: 'Ania+', michal: 'Michał', michalP: 'Michał+', wsp: 'Wspólne', inne: 'Inne' };
      const dNames = ['Niedz.', 'Pon.', 'Wt.', 'Śr.', 'Czw.', 'Pt.', 'Sob.'];
      const dNamesFull = ['Niedziela', 'Poniedziałek', 'Wtorek', 'Środa', 'Czwartek', 'Piątek', 'Sobota'];
      const dShort = ['N', 'P', 'W', 'Ś', 'C', 'P', 'S'];
      let cur = new Date();
      let data = {};
      let unsub = null;
      const getDayIdx = d => (d === 0 ? 6 : d - 1);
      const calId = () => `${cur.getFullYear()}-${(cur.getMonth() + 1).toString().padStart(2, '0')}`;
      const getFieldClass = f => `c-${f}`;
      const getTileClass = t => t ? (t.trim() === '10' ? 'ten' : (t.trim() === '9' ? 'nine' : 'normal')) : 'empty';
      const getEntryText = (day, field) => data[day] && data[day][field] ? data[day][field] : '';
      const el = id => document.getElementById(id);
      const E = {
        title: el('title'), prevBtn: el('prev-btn'), nextBtn: el('next-btn'), todayBtn: el('today-btn'),
        desktop: el('desktop'), mob: el('mob'), modal: el('modal-container'), modalTitle: el('modal-title'),
        modalForm: el('modal-form'), inputContainer: el('input-container'), modalCloseBtn: el('modal-close-btn'),
        modalSaveBtn: el('modal-save-btn'), sumText: el('sum-text'), status: el('status'),
        mCardsView: el('m-cards-view'), mGridView: el('m-grid-view'), mGridBody: el('m-grid-body'),
        viewCardsBtn: el('view-cards'), viewGridBtn: el('view-grid')
      };
      const isMobile = window.innerWidth <= 768;

      const setTitle = () => {
        E.title.textContent = `${cur.toLocaleString('pl-PL', { month: 'long', year: 'numeric' })}`;
      };
      const renderDesktop = (y, m, ev) => {
        E.desktop.innerHTML = '';
        const days = new Date(y, m + 1, 0).getDate();
        const startDay = new Date(y, m, 1).getDay();
        const firstDayIdx = getDayIdx(startDay);
        const frag = document.createDocumentFragment();
        dNames.forEach(d => {
          const h = document.createElement('div');
          h.className = `p-2 text-center text-xs font-semibold text-gray-500 bg-gray-100`;
          h.textContent = d;
          frag.appendChild(h);
        });
        for (let i = 0; i < firstDayIdx; i++) {
          const empty = document.createElement('div');
          empty.className = 'bg-white h-24';
          frag.appendChild(empty);
        }
        for (let d = 1; d <= days; d++) {
          const date = new Date(y, m, d);
          const dow = date.getDay();
          const de = ev[d] || {};
          const isToday = new Date().toDateString() === date.toDateString();
          const off = (dow === 0 || dow === 6) || de.isHoliday;
          const cell = document.createElement('div');
          cell.className = `bg-white h-24 p-2 relative text-sm border-b border-r border-gray-200 transition-colors ${off ? 'bg-red-50' : ''} ${isToday ? 'ring-2 ring-purple-400 z-10' : ''}`;
          if (de.isHoliday) cell.classList.add('holiday');
          cell.innerHTML = `<span class="font-bold text-gray-900">${d}</span><div class="absolute bottom-2 left-2 flex gap-1"></div><div class="h-10"></div><div class="grid grid-cols-2 gap-1 mt-2"></div>`;
          const sumContainer = cell.querySelector('.grid');
          const tileFrag = document.createDocumentFragment();
          fields.forEach(f => {
            const t = getEntryText(d, f);
            const tile = document.createElement('div');
            tile.className = `p-1 rounded text-center text-xs font-medium text-white ${getTileClass(t)} ${getFieldClass(f)} cursor-pointer`;
            tile.dataset.day = d;
            tile.dataset.field = f;
            tile.textContent = t;
            tile.onclick = e => launchEdit(e);
            tileFrag.appendChild(tile);
          });
          sumContainer.appendChild(tileFrag);
          frag.appendChild(cell);
        }
        E.desktop.appendChild(frag);
      };

      const renderMobileCards = (y, m, ev) => {
        E.mCardsView.innerHTML = '';
        const days = new Date(y, m + 1, 0).getDate();
        const today = new Date();
        const frag = document.createDocumentFragment();
        for (let d = 1; d <= days; d++) {
          const date = new Date(y, m, d);
          const dow = date.getDay();
          const de = ev[d] || {};
          const off = (dow === 0 || dow === 6) || de.isHoliday;
          const isToday = today.toDateString() === date.toDateString();
          const card = document.createElement('div');
          card.className = `m-card ${off ? 'ring-1 ring-red-200' : ''} ${isToday ? 'ring-2 ring-purple-400' : ''}`;
          let html = `<div class="m-head"><div><span class="m-num">${d}</span> <span class="m-name">${dNamesFull[getDayIdx(dow)]}</span></div><div class="flex gap-1">${de.isHoliday ? '<span class="tag bg-red-100 text-red-600">Święto</span>' : ''}${isToday ? '<span class="tag bg-gradient-to-r from-purple-500 to-pink-500 text-white">Dziś</span>' : ''}</div></div>`;
          for (const f of fields) {
            const t = getEntryText(d, f);
            html += `<div class="m-row"><div class="m-label ${getFieldClass(f)}">${labels[f]}</div><div class="m-content ${getFieldClass(f)} ${getTileClass(t)}" data-day="${d}" data-field="${f}"><span class="txt">${t || '<span class="placeholder">+ Dodaj</span>'}</span></div></div>`;
          }
          card.innerHTML = html;
          frag.appendChild(card);
        }
        E.mCardsView.appendChild(frag);
      };

      const renderMobileGrid = (y, m, ev) => {
        E.mGridBody.innerHTML = '';
        const days = new Date(y, m + 1, 0).getDate();
        const today = new Date();
        const frag = document.createDocumentFragment();
        for (let d = 1; d <= days; d++) {
          const date = new Date(y, m, d);
          const dow = date.getDay();
          const de = ev[d] || {};
          const isToday = today.toDateString() === date.toDateString();
          const row = document.createElement('div');
          row.className = `m-grid-row ${isToday ? 'm-grid-today' : ''}`;
          row.innerHTML = `<div class="m-grid-day"><span class="m-grid-day-num">${d}</span><span class="m-grid-day-name">${dShort[getDayIdx(dow)]}</span></div>`;
          for (const f of fields) {
            const t = getEntryText(d, f);
            const off = (dow === 0 || dow === 6) || de.isHoliday;
            const cell = document.createElement('div');
            cell.className = `m-grid-cell ${off ? 'm-grid-off' : ''} ${getTileClass(t)}`;
            cell.dataset.day = d;
            cell.dataset.field = f;
            cell.textContent = t;
            row.appendChild(cell);
          }
          frag.appendChild(row);
        }
        E.mGridBody.appendChild(frag);
      };

      const launchEdit = e => {
        const target = e.target.closest('.m-content, .m-grid-cell, .tile');
        if (!target) return;
        const day = target.dataset.day;
        const field = target.dataset.field;
        E.modalTitle.textContent = `${labels[field]} - ${day} ${cur.toLocaleString('pl-PL', { month: 'long' })}`;
        E.inputContainer.innerHTML = `<input type="number" id="modal-input" class="w-full px-4 py-2 border rounded-md text-gray-900" placeholder="Wpisz wartość" value="${getEntryText(day, field) || ''}" required>`;
        E.modalForm.onsubmit = async (e) => {
          e.preventDefault();
          const val = E.modalInput.value.trim();
          await db.collection(calId()).doc(day).set({ [field]: val }, { merge: true });
          E.modal.classList.add('hidden');
          showStatus('Zapisano pomyślnie!');
        };
        E.modal.classList.remove('hidden');
        E.modalInput.focus();
      };
      const toggleHoliday = day => {
        const docRef = db.collection(calId()).doc(day);
        docRef.get().then(doc => {
          const isHoliday = doc.data() && doc.data().isHoliday;
          docRef.set({ isHoliday: !isHoliday }, { merge: true });
        });
      };
      const showStatus = msg => {
        E.status.textContent = msg;
        E.status.classList.remove('translate-y-full');
        setTimeout(() => E.status.classList.add('translate-y-full'), 3000);
      };
      const computeSumsAndEarnings = () => {
        let totalSum = 0;
        let earningsSum = 0;
        for (const day in data) {
          const dayData = data[day];
          fields.forEach(f => {
            const val = parseFloat(dayData[f]);
            if (!isNaN(val)) {
              totalSum += val;
              if (f === 'aniaP' || f === 'michalP') {
                earningsSum += val * 10;
              }
            }
          });
        }
        E.sumText.textContent = `Suma: ${totalSum} / Zarobek: ${earningsSum} zł`;
      };
      async function update() {
        if (!db) return;
        setTitle();
        if (unsub) unsub();
        unsub = onSnapshot(collection(db, calId()), s => {
          data = {};
          s.forEach(doc => data[doc.id] = doc.data());
          if (isMobile) {
            renderMobileCards(cur.getFullYear(), cur.getMonth(), data);
            renderMobileGrid(cur.getFullYear(), cur.getMonth(), data);
          } else {
            renderDesktop(cur.getFullYear(), cur.getMonth(), data);
          }
          computeSumsAndEarnings();
        });
      }
      E.prevBtn.onclick = () => { cur.setMonth(cur.getMonth() - 1); update(); };
      E.nextBtn.onclick = () => { cur.setMonth(cur.getMonth() + 1); update(); };
      E.todayBtn.onclick = () => { cur = new Date(); update(); };
      E.modalCloseBtn.onclick = () => E.modal.classList.add('hidden');
      E.desk.addEventListener('click', launchEdit);
      E.mCardsView.addEventListener('click', launchEdit);
      E.mGridBody.addEventListener('click', launchEdit);
      E.desk.addEventListener('click', e => {
        const dayCell = e.target.closest('.day-cell');
        if (dayCell) toggleHoliday(dayCell.dataset.day);
      });
      E.viewCardsBtn.addEventListener('click', () => {
        E.viewCardsBtn.classList.add('active');
        E.viewGridBtn.classList.remove('active');
        E.mCardsView.classList.remove('hidden');
        E.mGridView.classList.remove('active');
      });
      E.viewGridBtn.addEventListener('click', () => {
        E.viewGridBtn.classList.add('active');
        E.viewCardsBtn.classList.remove('active');
        E.mGridView.classList.add('active');
        E.mCardsView.classList.add('hidden');
      });
      document.addEventListener('DOMContentLoaded', () => {
        if (window.location.hash) {
          try {
            const date = new Date(window.location.hash.substring(1));
            if (!isNaN(date)) {
              cur = date;
            }
          } catch (e) {}
        }
        update();
      });
    </script>
  </body>
</html>
