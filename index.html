<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>Kalendarz Rodziny Fedorczak</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    :root{
      /* kolumny (delikatne, by tre≈õƒá by≈Ça czytelna) */
      --c-ania:#fff1f2; --c-aniaP:#f0fff4; --c-michal:#f0f9ff; --c-michalP:#f5f3ff; --c-wsp:#fffbeb; --c-inne:#f1f5f9;
      
      /* === ZMIANA KOLOR√ìW === */
      /* akcenty zgodne z kropkami w pasku sum */
      --k-lask:#a7f3d0;      /* ZMIANA: r√≥≈ºowy sta≈Ç siƒô miƒôtowy */
      --k-brzeziny:#fde68a;  /* ≈º√≥≈Çty */
      --k-ortho:#f9a8d4;     /* ZMIANA: miƒôtowy sta≈Ç siƒô r√≥≈ºowy */
      --k-jb:#c4b5fd;        /* fiolet (JB zwyk≈Çe) */
      --k-jb24:#7c3aed;      /* ciemny fiolet (JB OIT/zniecz ‚Äì 24h) */
    }

    *{box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#fef3f8,#f3f4f6);-webkit-font-smoothing:antialiased}

    /* Reszta styl√≥w bez zmian... */
    .hdr{background:#fff;border-bottom:1px solid #e5e7eb;padding:.75rem 1rem;box-shadow:0 1px 2px rgba(0,0,0,.05)}
    .view-btn{display:flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:.5rem;border:1px solid transparent}
    .view-btn.active{background:#ede9fe;border-color:#8b5cf6}
    .sumbar{display:flex;gap:.5rem;flex-wrap:wrap;background:#fff;border-bottom:1px solid #e5e7eb;padding:.5rem 1rem}
    .chip{display:inline-flex;gap:.35rem;align-items:center;border:1px solid #e5e7eb;background:#f9fafb;border-radius:9999px;padding:.3rem .55rem;font-size:.82rem}
    .dot{width:.55rem;height:.55rem;border-radius:9999px}
    @media (max-width:768px){ .sumbar{display:none} }
    .grid{display:grid;grid-template-columns:64px repeat(6,1fr);border-top:1px solid #e5e7eb}
    .cell{border-bottom:1px solid #e5e7eb;border-left:1px solid #e5e7eb;min-height:60px;position:relative;padding:4px}
    .cell:nth-child(7n+1){border-left:none}
    .cell.header{background:#f9fafb;font-weight:600}
    .day-cell{cursor:pointer}
    .day-num{font-weight:800;color:#374151}
    .day-name{font-size:.7rem;color:#6b7280}
    .today .day-num,.today .day-name{color:#6d28d9}
    .off{position:relative}
    .off::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(239,68,68,.08),rgba(219,39,119,.08));pointer-events:none;z-index:1}
    .fld{height:100%;padding:6px;border-radius:10px;font-size:.9rem;line-height:1.35;cursor:pointer;word-break:break-word;transition:transform .12s;position:relative;z-index:2}
    .fld:hover{transform:translateY(-1px)}
    .selected{outline:2px solid #8b5cf6}
    .c-ania{background:var(--c-ania)} .c-aniaP{background:var(--c-aniaP)}
    .c-michal{background:var(--c-michal)} .c-michalP{background:var(--c-michalP)}
    .c-wsp{background:var(--c-wsp)} .c-inne{background:var(--c-inne)}
    .tile-ortho{background:var(--k-ortho)!important;font-weight:600}
    .tile-brzeziny{background:var(--k-brzeziny)!important;font-weight:600}
    .tile-lask{background:var(--k-lask)!important;font-weight:600}
    .tile-jb{background:var(--k-jb)!important;font-weight:600}
    .tile-jb24{background:var(--k-jb24)!important;color:#fff;font-weight:700}
    .mcal{display:none;padding:.75rem}
    @media (max-width:768px){
      .grid{display:none}
      .mcal{display:block}
      .m-card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:.85rem;margin-bottom:.85rem;box-shadow:0 2px 6px rgba(0,0,0,.05)}
      .m-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;padding-bottom:.5rem;border-bottom:2px solid #f3f4f6}
      .m-num{font-size:1.25rem;font-weight:800;color:#1f2937}
      .m-name{font-size:.8rem;color:#6b7280}
      .tag{font-size:.7rem;border-radius:999px;padding:.15rem .45rem}
      .m-row{display:flex;gap:.5rem;align-items:stretch;margin:.3rem 0}
      .m-label{flex:0 0 86px;border-radius:10px;padding:.45rem .5rem;font-weight:600;color:#334155}
      .m-content{flex:1;border-radius:10px;padding:.45rem .6rem;cursor:pointer;position:relative;z-index:2;min-height:36px;display:flex;align-items:center}
      .m-content .txt{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;font-size:.92rem}
    }
    #compact{display:none;padding:1rem}
    .cv-card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;margin-bottom:12px;padding:12px;cursor:pointer;transition:all .2s}
    .cv-card:hover{transform:translateY(-2px);box-shadow:0 4px 6px rgba(0,0,0,.1)}
    .cv-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px}
    .cv-item{padding:8px;border-radius:10px;font-size:.85rem}
    #month{display:none;padding:1rem}
    .mgrid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:#e5e7eb;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
    .mh{background:#f9fafb;padding:.6rem;text-align:center;font-weight:700;color:#6b7280}
    .mc{background:#fff;min-height:96px;padding:.4rem;cursor:pointer;position:relative}
    .mc.week::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(239,68,68,.08),rgba(219,39,119,.08));pointer-events:none;z-index:1}
    .mnum{font-weight:700;color:#374151;margin-bottom:.25rem;position:relative;z-index:2}
    .mitem{font-size:.68rem;padding:2px 4px;border-radius:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;position:relative;z-index:2}
    #ctx{position:fixed;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 12px 24px rgba(0,0,0,.1);padding:6px;display:none;z-index:1000}
    .ctx-it{padding:10px 14px;font-size:.9rem;color:#374151;cursor:pointer;border-radius:8px}
    .ctx-it:hover{background:#f3f4f6}
    #edit{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:1200;padding:16px}
    .edit-body{
      background:#fff;border-radius:18px;width:min(720px,100%);max-height:86vh;overflow:auto;
      padding:0;display:flex;flex-direction:column;
    }
    .edit-head{
      position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid #f3f4f6;
      display:flex;align-items:center;gap:.75rem;padding:.9rem 1rem;border-top-left-radius:18px;border-top-right-radius:18px;
    }
    .edit-title{font-weight:800;color:#0f172a;font-size:1.1rem}
    .edit-close{margin-left:auto;flex-shrink:0;width:36px;height:36px;border-radius:10px;border:1px solid #e5e7eb;background:#f8fafc}
    .edit-close:hover{background:#eef2ff;border-color:#c7d2fe}
    .edit-content{padding:1rem 1rem 1.25rem}
    @supports (padding: env(safe-area-inset-bottom)){
      @media (max-width:768px){
        #edit{align-items:flex-end}
        .edit-body{width:100%;max-height:90vh;border-bottom-left-radius:0;border-bottom-right-radius:0}
        .edit-head{padding-top:calc(1rem + env(safe-area-inset-top))}
        .edit-content{padding-bottom:calc(1rem + env(safe-area-inset-bottom))}
      }
    }
    #fab{position:fixed;right:16px;bottom:16px;z-index:1100;display:none;align-items:center;gap:.5rem;
      background:linear-gradient(135deg,#a78bfa,#f472b6);color:#fff;border:none;border-radius:9999px;padding:.7rem .95rem;font-weight:800}
    #fab svg{width:18px;height:18px}
    @media (max-width:768px){ #fab{display:inline-flex} }
    #sheet{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;
      box-shadow:0 -12px 24px rgba(0,0,0,.2);transform:translateY(110%);transition:transform .22s ease-out;z-index:1200}
    #sheet.open{transform:translateY(0)}
  </style>
</head>
<body>
  <header class="hdr">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-pink-300 to-purple-400 grid place-items-center shadow">
          <span class="text-white font-black">üå∏</span>
        </div>
        <div>
          <div class="font-extrabold text-slate-900">Rodzina Fedorczak</div>
          <div class="text-slate-500 text-sm -mt-1">Kalendarz</div>
        </div>
      </div>

      <div class="flex items-center gap-2 flex-wrap">
        <button id="prev" class="p-2 rounded-lg hover:bg-gray-100" title="Poprzedni miesiƒÖc">‚óÄ</button>
        <h2 id="title" class="font-semibold text-slate-700 min-w-[160px] text-center">‚Äî</h2>
        <button id="next" class="p-2 rounded-lg hover:bg-gray-100" title="Nastƒôpny miesiƒÖc">‚ñ∂</button>
        <button id="today" class="px-3 py-2 text-sm font-semibold text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Dzi≈õ</button>
        <div class="flex gap-1 border border-gray-200 rounded-xl p-1">
          <button id="v-standard" class="view-btn active" data-v="standard" title="Widok normalny">‚ñ¶</button>
          <button id="v-compact"  class="view-btn" data-v="compact"  title="Widok kompaktowy">‚â°</button>
          <button id="v-month"    class="view-btn" data-v="month"    title="Widok miesiƒôczny">‚ñ§</button>
        </div>
        
        <div class="flex items-center gap-2 border border-gray-200 rounded-xl p-2 ml-4">
            <input type="file" id="csvFileInput" accept=".csv" class="text-sm">
            <input type="number" id="importYear" placeholder="Rok" class="w-20 p-2 border border-gray-300 rounded-md text-sm">
            <input type="number" id="importMonth" placeholder="MiesiƒÖc" class="w-24 p-2 border border-gray-300 rounded-md text-sm">
            <button id="importBtn" class="px-3 py-2 text-sm font-semibold text-white bg-purple-600 rounded-md hover:bg-purple-700">Importuj</button>
            <button id="clearMonthBtn" class="px-3 py-2 text-sm font-semibold text-white bg-red-600 rounded-md hover:bg-red-700">Wyczy≈õƒá miesiƒÖc</button>
            <button id="exportIcsBtn" class="px-3 py-2 text-sm font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700">Eksportuj .ics</button>
        </div>

      </div>
    </div>
  </header>

  <div class="sumbar">
    <span class="chip"><span class="dot" style="background:var(--k-ortho)"></span> Ortho: <b id="sum-ortho">0h</b></span>
    <span class="chip"><span class="dot" style="background:var(--k-brzeziny)"></span> Brzeziny: <b id="sum-brzeziny">0h</b></span>
    <span class="chip"><span class="dot" style="background:var(--k-lask)"></span> ≈Åask: <b id="sum-lask">0h</b></span>
    <span class="chip"><span class="dot" style="background:var(--k-jb)"></span> JB: <b id="sum-jb">0h</b></span>
    <span class="chip"><span class="dot" style="background:#fca5a5"></span> Porty: <b id="sum-ports">0</b></span>
    <span class="chip"><span class="dot" style="background:#6ee7b7"></span> üí∞ Zarobki: <b id="sum-earnings">0 z≈Ç</b></span>
  </div>

  <main class="w-full bg-white flex flex-col flex-grow">
    <div id="standard" class="flex-1 flex flex-col">
      <div id="desk-wrap" class="overflow-auto hidden md:block flex-1">
        <div class="bg-white border-t min-w-[900px]">
          <div class="grid font-semibold text-sm text-center text-gray-700 sticky top-0 bg-white z-10">
            <div class="cell header p-3">Dzie≈Ñ</div>
            <div class="cell header p-3 c-ania">Ania</div>
            <div class="cell header p-3 c-aniaP">Ania Praca</div>
            <div class="cell header p-3 c-michal">Micha≈Ç</div>
            <div class="cell header p-3 c-michalP">Micha≈Ç Praca</div>
            <div class="cell header p-3 c-wsp">Wsp√≥lne</div>
            <div class="cell header p-3 c-inne">Dom/Finanse</div>
          </div>
          <div id="desk" class="grid"></div>
        </div>
      </div>
      <div id="mob" class="mcal md:hidden"></div>
    </div>

    <div id="compact" style="display:none">
      <div id="cv-cont" class="p-1"></div>
    </div>

    <div id="month" style="display:none">
      <div id="mgrid" class="mgrid"></div>
    </div>
  </main>

  <button id="fab" aria-label="Poka≈º podsumowanie">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12h18M12 3v18"/></svg>
    Suma
  </button>

  <div id="sheet">
    <div class="w-full p-4">
      <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-2"></div>
      <div id="sheet-title" class="text-sm text-gray-500 mb-2">Podsumowanie</div>
      <div class="grid grid-cols-2 gap-2">
        <div class="p-3 rounded-lg border border-gray-200 bg-gray-50"><div class="text-xs text-gray-500">Ortho</div><div id="ms-ortho" class="text-lg font-bold">0h</div></div>
        <div class="p-3 rounded-lg border border-gray-200 bg-gray-50"><div class="text-xs text-gray-500">Brzeziny</div><div id="ms-brzeziny" class="text-lg font-bold">0h</div></div>
        <div class="p-3 rounded-lg border border-gray-200 bg-gray-50"><div class="text-xs text-gray-500">≈Åask</div><div id="ms-lask" class="text-lg font-bold">0h</div></div>
        <div class="p-3 rounded-lg border border-gray-200 bg-gray-50"><div class="text-xs text-gray-500">JB</div><div id="ms-jb" class="text-lg font-bold">0h</div></div>
        <div class="p-3 rounded-lg border border-gray-200 bg-gray-50"><div class="text-xs text-gray-500">Porty</div><div id="ms-ports" class="text-lg font-bold">0</div></div>
        <div class="p-3 rounded-lg border border-gray-200 bg-emerald-50 col-span-2"><div class="text-xs text-gray-500">üí∞ Zarobki</div><div id="ms-earnings" class="text-lg font-bold">0 z≈Ç</div></div>
      </div>
      <div class="mt-3 text-right">
        <button id="sheet-close" class="px-3 py-2 text-sm font-semibold text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Zamknij</button>
      </div>
    </div>
  </div>

  <div id="ctx">
    <div id="ctx-copy"  class="ctx-it">Kopiuj</div>
    <div id="ctx-cut"   class="ctx-it">Wytnij</div>
    <div id="ctx-paste" class="ctx-it">Wklej</div>
    <div class="h-px bg-gray-200 my-1"></div>
    <div id="ctx-del"   class="ctx-it text-red-600">Usu≈Ñ</div>
  </div>

  <div id="edit">
    <div class="edit-body">
      <div class="edit-head">
        <h3 id="edit-title" class="edit-title">Edycja dnia</h3>
        <button id="edit-close" class="edit-close">‚úï</button>
      </div>
      <div id="edit-fields" class="edit-content"></div>
    </div>
  </div>

  <script type="module">
    /* ===== Firebase ===== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, updateDoc, deleteField, getDocs, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const cfg = {
      apiKey:"AIzaSyAgHtQFaHXlPweFU90GKGW2Jx0fl23VRkQ",
      authDomain:"kalendarz-rodzinny-68d04.firebaseapp.com",
      projectId:"kalendarz-rodzinny-68d04",
      storageBucket:"kalendarz-rodzinny-68d04.appspot.com",
      messagingSenderId:"1050937545151",
      appId:"1:1050937545151:web:a85fd1a5f066f4a499910a",
      measurementId:"G-57YKE2XKQ1"
    };

    let db;
    try{
      const app = initializeApp(cfg);
      const auth = getAuth(app);
      db = getFirestore(app);
      signInAnonymously(auth);
      onAuthStateChanged(auth, u => u && init());
    }catch(e){ console.error(e); }

    /* ===== Stan ===== */
    let cur = new Date();
    let unsub = () => {};
    let isMobile = matchMedia("(max-width: 768px)").matches;
    const fields = ['ania','aniaPraca','michal','michalPraca','wspolne','inne'];
    const labels = { ania:'Ania', aniaPraca:'Ania Praca', michal:'Micha≈Ç', michalPraca:'Micha≈Ç Praca', wspolne:'Wsp√≥lne', inne:'Dom/Finanse' };
    let data = {};
    let clip = null;
    let view = 'standard';

    const el = id => document.getElementById(id);
    const E = {
      title: el('title'), prev: el('prev'), next: el('next'), today: el('today'),
      vStandard: el('v-standard'), vCompact: el('v-compact'), vMonth: el('v-month'),
      desk: el('desk'), mob: el('mob'), cv: el('cv-cont'), mgrid: el('mgrid'),
      sumOrtho: el('sum-ortho'), sumBrz: el('sum-brzeziny'), sumLask: el('sum-lask'), sumJB: el('sum-jb'), sumPorts: el('sum-ports'), sumEarnings: el('sum-earnings'),
      msOrtho: el('ms-ortho'), msBrz: el('ms-brzeziny'), msLask: el('ms-lask'), msJB: el('ms-jb'), msPorts: el('ms-ports'), msEarnings: el('ms-earnings'),
      sheet: el('sheet'), sheetClose: el('sheet-close'), fab: el('fab'), sheetTitle: el('sheet-title'),
      ctx: el('ctx'), ctxCopy: el('ctx-copy'), ctxCut: el('ctx-cut'), ctxPaste: el('ctx-paste'), ctxDel: el('ctx-del'),
      edit: el('edit'), editClose: el('edit-close'), editFields: el('edit-fields'), editTitle: el('edit-title'),
      importBtn: el('importBtn'), csvFileInput: el('csvFileInput'), importYear: el('importYear'), importMonth: el('importMonth'),
      clearMonthBtn: el('clearMonthBtn'), exportIcsBtn: el('exportIcsBtn')
    };

    window.addEventListener('resize', ()=>{ const was = isMobile; isMobile = matchMedia("(max-width: 768px)").matches; if (was!==isMobile) update(); });

    /* ===== Nazwy ===== */
    const mNames = ['Stycze≈Ñ','Luty','Marzec','Kwiecie≈Ñ','Maj','Czerwiec','Lipiec','Sierpie≈Ñ','Wrzesie≈Ñ','Pa≈∫dziernik','Listopad','Grudzie≈Ñ'];
    const dNamesFull = ['Poniedzia≈Çek','Wtorek','≈öroda','Czwartek','PiƒÖtek','Sobota','Niedziela'];
    const dShort = ['PN','WT','≈öR','CZ','PT','SB','ND'];
    const getDayIdx = d => (d + 6) % 7; // Pon=0
    
    /* ===== Stawki ===== */
    const hourlyRates = { brzeziny: 400, ortho: 400, jb: 220, lask: 190 };
    const portRates = { install: 731, remove: 386 };

    /* ===== Typy i kafelki ===== */
    const jb24 = ['jb oit','jb zniecz','jb znieczulenia','jb znieczule≈Ñ'];
    const isOrtho = t => /ortho/i.test(t||'');
    const isBrzeziny = t => /brzeziny/i.test(t||'');
    const isLask = t => /≈Çask/i.test(t||'');
    const isJB = t => !!(t&&(t.toLowerCase().startsWith('jb')||t.toLowerCase().includes('jb ')));

    const getFieldClass = (field) => ({ aniaPraca:'c-aniaP', michalPraca:'c-michalP', wspolne:'c-wsp' }[field] || `c-${field}`);

    const getTileClass = t=>{
      if(!t) return '';
      const s=t.toLowerCase();
      if(jb24.some(k=>s.includes(k))) return 'tile-jb24';
      if(isLask(s)) return 'tile-lask';
      if(isOrtho(s)) return 'tile-ortho';
      if(isBrzeziny(s)) return 'tile-brzeziny';
      if(s.startsWith('jb')) return 'tile-jb';
      return '';
    };

    /* ===== Godziny i Porty (gettery) ===== */
    const getDefaultHours = (txt)=>{
      if(!txt) return 0;
      const s = txt.toLowerCase();
      if(isOrtho(s)||isBrzeziny(s)) return 10;
      if(isLask(s)) return 24;
      if(jb24.some(k=>s.includes(k))) return 24;
      if(/rano|poranna|7[:\.]30|wybudze/i.test(s)) return 6;
      if(isJB(s)) return 6;
      return 0;
    };
    const getSavedHours = (day, field)=> (data[day] && typeof data[day][`hours_${field}`] === 'number') ? data[day][`hours_${field}`] : null;
    const getPorts = (day, field, type) => (data[day] && typeof data[day][`ports_${type}_${field}`] === 'number') ? data[day][`ports_${type}_${field}`] : 0;
    const effHours = (day, field, txt)=>{
      const saved = getSavedHours(day, field);
      return saved !== null ? saved : getDefaultHours(txt);
    };

    /* ===== Renderowanie (bez zmian) ===== */
    const renderDesktop = (y,m,ev)=>{
      E.desk.innerHTML='';
      const days = new Date(y,m+1,0).getDate();
      const today = new Date();
      for(let d=1; d<=days; d++){
        const date = new Date(y,m,d);
        const dow = date.getDay();
        const isToday = today.toDateString()===date.toDateString();
        const de = ev[d]||{};
        const off = (dow===0||dow===6)||de.isHoliday;
        const dayCell = document.createElement('div');
        dayCell.className = `cell day-cell ${off?'off':''} ${isToday?'today':''} flex items-center justify-center`;
        dayCell.dataset.day=d;
        dayCell.innerHTML = `<div class="text-center"><div class="day-num">${d}</div><div class="day-name">${dShort[getDayIdx(dow)]}</div></div>`;
        E.desk.appendChild(dayCell);
        for(const f of fields){
          const t = de[f]||'';
          const c = document.createElement('div');
          c.className = `cell ${off?'off':''} ${getFieldClass(f)}`;
          const div = document.createElement('div');
          div.className = `fld ${getTileClass(t)}`;
          div.dataset.day=d; div.dataset.field=f;
          const span = document.createElement('span'); span.className='txt'; span.textContent=t;
          div.appendChild(span); c.appendChild(div); E.desk.appendChild(c);
        }
      }
    };
    const renderMobile = (y,m,ev)=>{
      E.mob.innerHTML='';
      const days = new Date(y,m+1,0).getDate();
      const today = new Date();
      const frag = document.createDocumentFragment();
      for(let d=1; d<=days; d++){
        const date = new Date(y,m,d);
        const dow = date.getDay();
        const de = ev[d]||{};
        const off = (dow===0||dow===6)||de.isHoliday;
        const isToday = today.toDateString()===date.toDateString();
        const card = document.createElement('div');
        card.className = `m-card ${off?'ring-0':''} ${isToday?'ring-2 ring-purple-400':''}`;
        let html = `<div class="m-head">
          <div><span class="m-num">${d}</span> <span class="m-name">${dNamesFull[getDayIdx(dow)]}</span></div>
          <div class="flex gap-1">
            ${de.isHoliday?'<span class="tag bg-purple-200 text-purple-700">≈öwiƒôto</span>':''}
            ${isToday?'<span class="tag bg-gradient-to-r from-purple-500 to-pink-500 text-white">Dzi≈õ</span>':''}
          </div>
        </div>`;
        for(const f of fields){
          const t = de[f]||'';
          html += `<div class="m-row">
            <div class="m-label ${getFieldClass(f)}">${labels[f]}</div>
            <div class="m-content ${getFieldClass(f)} ${getTileClass(t)}" data-day="${d}" data-field="${f}">
              <span class="txt">${t||'<span class="text-gray-400">Kliknij aby dodaƒá</span>'}</span>
            </div>
          </div>`;
        }
        card.innerHTML = html;
        frag.appendChild(card);
      }
      E.mob.appendChild(frag);
    };
    const renderCompact = (y,m)=>{};
    const renderMonth = (y,m)=>{};
    
    /* ===== Sumy i Zarobki ===== */
    const computeSumsAndEarnings = ()=>{
      let ortho=0, brz=0, lask=0, jb=0, portsInstall=0, portsRemove=0, earnings = 0;
      const days=new Date(cur.getFullYear(),cur.getMonth()+1,0).getDate();
      for(let d=1; d<=days; d++){
        const row=data[d]; if(!row) continue;
        for(const f of fields){
          const t=row[f];
          if (t) {
              const h=effHours(d,f,t);
              if(isOrtho(t)) { ortho+=h; earnings += h * hourlyRates.ortho; }
              if(isBrzeziny(t)) { brz+=h; earnings += h * hourlyRates.brzeziny; }
              if(isLask(t)) { lask+=h; earnings += h * hourlyRates.lask; }
              if(isJB(t)) { jb+=h; earnings += h * hourlyRates.jb; }
          }
          if(f==='michalPraca') {
              const pInstall = getPorts(d, f, 'install');
              const pRemove = getPorts(d, f, 'remove');
              portsInstall += pInstall;
              portsRemove += pRemove;
              earnings += (pInstall * portRates.install) + (pRemove * portRates.remove);
          }
        }
      }
      const totalPorts = portsInstall + portsRemove;
      E.sumOrtho.textContent=ortho+'h';
      E.sumBrz.textContent=brz+'h';
      E.sumLask.textContent=lask+'h';
      E.sumJB.textContent=jb+'h';
      E.sumPorts.textContent=String(totalPorts);
      E.sumEarnings.textContent = `${earnings.toLocaleString('pl-PL')} z≈Ç`;
      
      E.msOrtho.textContent=ortho+'h';
      E.msBrz.textContent=brz+'h';
      E.msLask.textContent=lask+'h';
      E.msJB.textContent=jb+'h';
      E.msPorts.textContent=String(totalPorts);
      E.msEarnings.textContent = `${earnings.toLocaleString('pl-PL')} z≈Ç`;
      
      E.sheetTitle.textContent=`Podsumowanie: ${mNames[cur.getMonth()]} ${cur.getFullYear()}`;
    };

    /* ===== DB helpers ===== */
    const calId = ()=>`${cur.getFullYear()}-${cur.getMonth()+1}`;
    const save = (day,field,val, customCalId = null)=> setDoc(doc(db, customCalId || calId(), String(day)), { [field]: val }, { merge:true });
    const del  = (day,field)=> updateDoc(doc(db, calId(), String(day)), { [field]: deleteField() });
    const setHours = (day,field,h)=> setDoc(doc(db, calId(), String(day)), { [`hours_${field}`]: (h===''||h===null)? deleteField() : parseInt(h,10) }, { merge:true });
    // ZMIANA: Zapis port√≥w
    const setPortsDb = (day,field,count,type)=> setDoc(doc(db, calId(), String(day)), { [`ports_${type}_${field}`]: (count===''||count===null)? deleteField() : parseInt(count,10) }, { merge:true });

    /* ===== Modal edycji ===== */
    function openEdit(day, dayRow, singleField = null){
      const date=new Date(cur.getFullYear(),cur.getMonth(),day);
      const title = singleField ? `${labels[singleField]} ‚Äî ${day} ${mNames[cur.getMonth()]}` : `${day} ${mNames[cur.getMonth()]} ‚Äî ${dNamesFull[getDayIdx(date.getDay())]}`;
      E.editTitle.textContent = title;
      E.editFields.innerHTML='';

      const fieldsToRender = singleField ? [singleField] : fields;
      for(const f of fieldsToRender){
        const txt = (dayRow&&dayRow[f])||'';
        const savedH = getSavedHours(day,f);
        const defH = getDefaultHours(txt);
        // ZMIANA: Pobieranie obu typ√≥w port√≥w
        const portsInstall = getPorts(day,f,'install');
        const portsRemove = getPorts(day,f,'remove');

        const wrap=document.createElement('div');
        wrap.className = "mb-4 pb-4 border-b";
        wrap.innerHTML = `
          <div class="flex items-center gap-2">
            <span class="px-2 py-1 rounded-md ${getFieldClass(f)} text-slate-700 font-semibold">${labels[f]}</span>
            <button class="ml-auto text-red-500 hover:text-red-600" data-act="del" data-field="${f}" title="Usu≈Ñ wpis">Usu≈Ñ</button>
          </div>
          <input type="text" class="w-full mt-2 p-3 border border-gray-200 rounded-lg ${getTileClass(txt)}" data-field="${f}" value="${txt}" placeholder="Kliknij aby dodaƒá">
          <div class="mt-2 grid grid-cols-[1fr_auto] gap-3 items-center">
            <div>
              <label class="text-xs text-gray-500">Godziny (puste = auto)</label>
              <input type="range" min="0" max="48" step="1" value="${savedH!==null?savedH:defH}" data-field="${f}" data-hrs="slider" class="w-full">
            </div>
            <input type="number" min="0" max="48" step="1" value="${savedH!==null?savedH:''}" placeholder="${defH}" data-field="${f}" data-hrs="num" class="w-20 p-2 border border-gray-200 rounded-md text-center">
          </div>
          ${f==='michalPraca' ? `
          <div class="mt-2 grid grid-cols-2 gap-3">
            <div>
                <label class="text-xs text-gray-500">Porty (za≈Ço≈ºenie)</label>
                <input type="number" min="0" step="1" value="${portsInstall||''}" placeholder="0" data-field="${f}" data-ports="install" class="w-full p-2 border border-gray-200 rounded-md text-center">
            </div>
            <div>
                <label class="text-xs text-gray-500">Porty (usuniƒôcie)</label>
                <input type="number" min="0" step="1" value="${portsRemove||''}" placeholder="0" data-field="${f}" data-ports="remove" class="w-full p-2 border border-gray-200 rounded-md text-center">
            </div>
          </div>`:''}
        `;
        E.editFields.appendChild(wrap);
      }
      
      // Listenery
      E.editFields.querySelectorAll('input[type="text"]').forEach(inp=>inp.addEventListener('change', async e => save(day,e.target.dataset.field,e.target.value.trim())));
      E.editFields.querySelectorAll('input[data-hrs="slider"]').forEach(sl=>sl.addEventListener('input', e => {
          const num = E.editFields.querySelector(`input[data-hrs="num"][data-field="${e.target.dataset.field}"]`);
          num.value = (parseInt(e.target.value,10)===getDefaultHours((data[day]||{})[e.target.dataset.field]||''))? '' : e.target.value;
      }));
      E.editFields.querySelectorAll('input[data-hrs="slider"]').forEach(sl=>sl.addEventListener('change', async e => setHours(day, e.target.dataset.field, E.editFields.querySelector(`input[data-hrs="num"][data-field="${e.target.dataset.field}"]`).value)));
      E.editFields.querySelectorAll('input[data-hrs="num"]').forEach(num=>num.addEventListener('change', async e => {
          const f=e.target.dataset.field;
          E.editFields.querySelector(`input[data-hrs="slider"][data-field="${f}"]`).value = (e.target.value===''? getDefaultHours((data[day]||{})[f]||'') : e.target.value);
          await setHours(day,f,e.target.value);
      }));
      E.editFields.querySelectorAll('input[data-ports]').forEach(p=>p.addEventListener('change', async e => setPortsDb(day,e.target.dataset.field,e.target.value, e.target.dataset.ports)));
      E.editFields.querySelectorAll('[data-act="del"]').forEach(b=>b.addEventListener('click', async e => {
          const f = e.target.dataset.field; await del(day,f);
          const row={...(data[day]||{})}; delete row[f]; openEdit(day,row, singleField);
      }));

      E.edit.style.display='flex';
    }
    E.editClose.onclick=()=>E.edit.style.display='none';
    E.edit.addEventListener('click',e=>{ if(e.target===E.edit) E.edit.style.display='none'; });
    document.addEventListener('keydown', e => { if (e.key === 'Escape' && E.edit.style.display === 'flex') E.edit.style.display = 'none'; });

    /* ===== Context Menu i Klikniƒôcia (bez zmian) ===== */
    document.addEventListener('contextmenu', e=>{
      const fld = e.target.closest('.fld'); if(!fld) return;
      e.preventDefault();
      const r=E.ctx; r.style.display='block';
      const rect=r.getBoundingClientRect();
      let x=e.clientX, y=e.clientY;
      if(x+rect.width>innerWidth) x = innerWidth-rect.width-6;
      if(y+rect.height>innerHeight) y = innerHeight-rect.height-6;
      r.style.left=x+'px'; r.style.top=y+'px';
      r.dataset.day=fld.dataset.day; r.dataset.field=fld.dataset.field;
    });
    document.addEventListener('click', e=>{ if(!e.target.closest('#ctx')) E.ctx.style.display='none'; });
    E.ctxCopy.onclick=()=>{ const d=E.ctx.dataset; clip = (data[d.day]?.[d.field])||''; E.ctx.style.display='none'; };
    E.ctxCut.onclick=async ()=>{ const d=E.ctx.dataset; clip = (data[d.day]?.[d.field])||''; await del(d.day,d.field); E.ctx.style.display='none'; };
    E.ctxPaste.onclick=async ()=>{ const d=E.ctx.dataset; if(clip!==null){ await save(d.day,d.field,clip); } E.ctx.style.display='none'; };
    E.ctxDel.onclick=async ()=>{ const d=E.ctx.dataset; await del(d.day,d.field); E.ctx.style.display='none'; };
    E.desk.addEventListener('click', e=>{
      const dayCell = e.target.closest('.day-cell'); 
      if(dayCell){ toggleHoliday(dayCell.dataset.day); return; }
      const fld = e.target.closest('.fld'); 
      if(fld) openEdit(fld.dataset.day, data[fld.dataset.day]||{}, fld.dataset.field);
    });
    E.mob.addEventListener('click', e=>{
      const c = e.target.closest('.m-content'); 
      if(c) openEdit(c.dataset.day, data[c.dataset.day]||{}, c.dataset.field);
    });
    async function toggleHoliday(day){
      const id=calId(); const ref=doc(db,id,String(day));
      const snap=await getDoc(ref); const cur=(snap.exists() && snap.data().isHoliday)||false;
      await setDoc(ref,{isHoliday:!cur},{merge:true});
    }

    /* ===== Update/render ===== */
    function setTitle(){ E.title.textContent = `${mNames[cur.getMonth()]} ${cur.getFullYear()}`; }
    async function update(){
      if(!db) return;
      setTitle();
      const id=calId(); const snap=await getDocs(collection(db,id));
      data={}; snap.forEach(d=>data[d.id]=d.data());

      isMobile ? renderMobile(cur.getFullYear(),cur.getMonth(),data) : renderDesktop(cur.getFullYear(),cur.getMonth(),data);
      computeSumsAndEarnings();

      unsub();
      unsub = onSnapshot(collection(db,id), s=>{
        s.docChanges().forEach(ch=>{
          if(ch.type==='removed'){ delete data[ch.doc.id]; }
          else { data[ch.doc.id]=ch.doc.data(); }
        });
        isMobile ? renderMobile(cur.getFullYear(),cur.getMonth(),data) : renderDesktop(cur.getFullYear(),cur.getMonth(),data);
        computeSumsAndEarnings();
      });
    }
    
    /* ===== Nawigacja (bez zmian) ===== */
    E.prev.onclick=()=>{ cur.setDate(1); cur.setMonth(cur.getMonth()-1); update(); };
    E.next.onclick=()=>{ cur.setDate(1); cur.setMonth(cur.getMonth()+1); update(); };
    E.today.onclick=()=>{ const t=new Date(); cur=new Date(t.getFullYear(),t.getMonth(),1); update(); };

    /* ===== Import, Czyszczenie, Eksport ===== */
    async function importData(lines, year, month) {
        const columnMapping = ['aniaPraca', 'ania', 'michalPraca', 'michal', 'wspolne', 'inne'];
        if (!confirm(`Czy na pewno chcesz zaimportowaƒá dane dla ${mNames[month-1]} ${year}?`)) return;
        
        const daysInMonth = new Date(year, month, 0).getDate();
        for (let i = 0; i < lines.length && i < daysInMonth; i++) {
            const day = i + 1;
            const columns = lines[i];
            const dataToSave = {}; let hasData = false;
            for (let j = 0; j < columnMapping.length; j++) {
                if (j < columns.length && columns[j]) {
                    dataToSave[columnMapping[j]] = String(columns[j]).trim().replace(/"/g, '');
                    hasData = true;
                }
            }
            if (hasData) await setDoc(doc(db, `${year}-${month}`, String(day)), dataToSave, { merge: true });
        }
        alert(`Dane dla ${mNames[month-1]} ${year} zosta≈Çy zaimportowane.`);
        cur = new Date(year, month - 1, 1);
        update();
    }
    E.importBtn.addEventListener('click', () => {
        const file = E.csvFileInput.files[0];
        const year = parseInt(E.importYear.value, 10);
        const month = parseInt(E.importMonth.value, 10);
        if (!file || !year || !month || month < 1 || month > 12) {
            alert("Wybierz plik CSV oraz podaj poprawny rok i miesiƒÖc.");
            return;
        }
        Papa.parse(file, { encoding: "UTF-8", complete: res => importData(res.data, year, month) });
    });
    
    async function clearMonthData() {
        const monthName = mNames[cur.getMonth()];
        const year = cur.getFullYear();
        if(!confirm(`Czy na pewno chcesz usunƒÖƒá WSZYSTKIE wpisy z ${monthName} ${year}?`)) return;
        
        const querySnapshot = await getDocs(collection(db, calId()));
        await Promise.all(querySnapshot.docs.map(d => deleteDoc(d.ref)));
        
        alert(`Dane z ${monthName} ${year} zosta≈Çy usuniƒôte.`);
        update();
    }
    E.clearMonthBtn.addEventListener('click', clearMonthData);

    function exportToICS() {
        const year = cur.getFullYear();
        const month = cur.getMonth();
        let icsString = [
            'BEGIN:VCALENDAR',
            'VERSION:2.0',
            'PRODID:-//FedorczakFamilyCalendar//PL',
        ].join('\r\n') + '\r\n';

        for (const day in data) {
            const dayData = data[day];
            const date = new Date(year, month, parseInt(day));
            const dateString = `${year}${String(month + 1).padStart(2, '0')}${String(day).padStart(2, '0')}`;

            for (const field of fields) {
                if (dayData[field]) {
                    const summary = `${labels[field]}: ${dayData[field]}`;
                    icsString += [
                        'BEGIN:VEVENT',
                        `UID:${calId()}-${day}-${field}@fedorczak.family`,
                        `DTSTAMP:${new Date().toISOString().replace(/[-:.]/g, '')}Z`,
                        `DTSTART;VALUE=DATE:${dateString}`,
                        `SUMMARY:${summary}`,
                        'END:VEVENT'
                    ].join('\r\n') + '\r\n';
                }
            }
        }
        icsString += 'END:VCALENDAR';
        
        const blob = new Blob([icsString], { type: 'text/calendar;charset=utf-8' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `kalendarz_${year}_${month+1}.ics`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    E.exportIcsBtn.addEventListener('click', exportToICS);

    /* ===== Start Aplikacji ===== */
    function init(){ 
        const now = new Date();
        E.importYear.value = now.getFullYear();
        E.importMonth.value = now.getMonth() + 1;
        document.getElementById('standard').style.display='flex'; 
        update(); 
    }

  </script>
</body>
</html>
