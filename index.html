<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalendarz Rodzinny Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #F3F4F6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: minmax(80px, 0.5fr) repeat(6, 1fr);
            border-top: 1px solid #E5E7EB;
        }
        .calendar-cell {
            border-bottom: 1px solid #E5E7EB;
            border-left: 1px solid #E5E7EB;
            min-height: 110px;
            position: relative;
            padding: 4px;
        }
        .calendar-cell:first-child, .calendar-cell:nth-child(7n + 1) {
            border-left: none;
        }
        .calendar-cell.header {
             min-height: auto;
             font-weight: 600;
             background-color: #F9FAFB;
        }
        .day-info {
            text-align: center;
            font-weight: 600;
        }
        .day-number {
            font-size: 1.25rem;
            color: #374151;
        }
        .day-name {
             font-size: 0.75rem;
             color: #6B7280;
        }
        .weekend {
            background-color: #F9FAFB;
        }
        .today .day-info {
            background-color: #FBBF24;
            color: white;
            border-radius: 8px;
            padding: 2px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .editable-field {
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            line-height: 1.5;
            padding: 4px;
            border-radius: 6px;
            height: 100%;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .editable-field:hover {
            background-color: rgba(147, 197, 253, 0.2);
        }
        .editable-field textarea {
            width: 100%;
            height: 100%;
            border: none;
            background-color: white;
            resize: none;
            padding: 4px;
            margin: 0;
            outline: none;
            border-radius: 6px;
            box-shadow: 0 0 0 2px #3B82F6;
        }
        .saving { animation: saving-pulse 1.5s infinite; }
        .saved { background-color: #D1FAE5 !important; transition: background-color 0.3s; }

        @keyframes saving-pulse {
            0% { background-color: #FEF9C3; }
            50% { background-color: #FDE68A; }
            100% { background-color: #FEF9C3; }
        }

        .color-ania { background-color: #FFE6E6; }
        .color-aniaPraca { background-color: #FFDAB9; }
        .color-michal { background-color: #E6F3FF; }
        .color-michalPraca { background-color: #E0FFFF; }
        .color-wspolne { background-color: #E6FFE6; }
        .color-inne { background-color: #FFF9E6; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div id="app" class="w-full max-w-screen-2xl bg-white rounded-2xl shadow-lg p-4 sm:p-6">
        <!-- Komunikat o b≈Çƒôdzie -->
        <div id="error-banner" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4" role="alert">
            <strong class="font-bold">B≈ÇƒÖd konfiguracji!</strong>
            <span class="block sm:inline">Aplikacja nie jest pod≈ÇƒÖczona do bazy danych. Aby dzia≈Ça≈Ça poza tƒÖ stronƒÖ, musisz skonfigurowaƒá w≈Çasny projekt Firebase i wkleiƒá jego konfiguracjƒô w kodzie.</span>
        </div>
        
        <!-- Nag≈Ç√≥wek -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
            <div class="flex items-center gap-2">
                <div class="calendar-icon text-3xl">üìÖ</div>
                <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Kalendarz Rodzinny</h1>
            </div>
            <div class="flex items-center gap-2 md:gap-4 mt-4 sm:mt-0">
                <button id="prev-month" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                 <button id="today-btn" class="px-4 py-2 text-sm font-semibold text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50">Dzisiaj</button>
                <h2 id="month-year-display" class="text-lg sm:text-xl font-semibold text-gray-700 w-40 text-center">≈Åadowanie...</h2>
                <button id="next-month" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
             <div class="hidden sm:block w-24"></div> <!-- Pusty div dla symetrii na wiƒôkszych ekranach -->
        </div>

        <!-- Kalendarz -->
        <div class="overflow-x-auto">
            <div id="calendar-container" class="bg-white border-t min-w-[900px]">
                <div class="calendar-grid font-semibold text-sm text-center text-gray-700 sticky top-0 bg-white z-10">
                    <div class="calendar-cell header p-3">Dzie≈Ñ</div>
                    <div class="calendar-cell header p-3 color-ania">Ania</div>
                    <div class="calendar-cell header p-3 color-aniaPraca">Ania Praca</div>
                    <div class="calendar-cell header p-3 color-michal">Micha≈Ç</div>
                    <div class="calendar-cell header p-3 color-michalPraca">Micha≈Ç Praca</div>
                    <div class="calendar-cell header p-3 color-wspolne">Wsp√≥lne</div>
                    <div class="calendar-cell header p-3 color-inne">Dom/Finanse</div>
                </div>
                <div id="calendar-body" class="calendar-grid">
                    <!-- Dni bƒôdƒÖ generowane dynamicznie -->
                </div>
            </div>
        </div>
        <div id="loading" class="text-center p-8 text-gray-500 font-semibold">≈Åadowanie danych...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Konfiguracja Firebase ---
        const userFirebaseConfig = {
            apiKey: "AIzaSyAgHtQFaHXlPweFU90GKGW2Jx0fl23VRkQ",
            authDomain: "kalendarz-rodzinny-68d04.firebaseapp.com",
            projectId: "kalendarz-rodzinny-68d04",
            storageBucket: "kalendarz-rodzinny-68d04.appspot.com",
            messagingSenderId: "1050937545151",
            appId: "1:1050937545151:web:a85fd1a5f066f4a499910a",
            measurementId: "G-57YKE2XKQ1"
        };
        
        const finalFirebaseConfig = Object.keys(userFirebaseConfig).length > 0
            ? userFirebaseConfig
            : (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null);
        
        let db;

        if (finalFirebaseConfig) {
            try {
                const app = initializeApp(finalFirebaseConfig);
                const auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, user => {
                    if (user) {
                        initCalendar();
                    }
                });

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    signInAnonymously(auth).catch(error => {
                        console.error("Authentication Error:", error);
                        document.getElementById('loading').textContent = 'B≈ÇƒÖd logowania. Sprawd≈∫, czy w≈ÇƒÖczy≈Çe≈õ logowanie anonimowe w panelu Firebase.';
                    });
                }

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('error-banner').classList.remove('hidden');
                document.getElementById('loading').style.display = 'none';
            }
        } else {
            document.getElementById('error-banner').classList.remove('hidden');
            document.getElementById('loading').style.display = 'none';
        }


        // --- Stan aplikacji ---
        let currentDate = new Date();
        let unsubscribeFromEvents = () => {};

        // --- Elementy DOM ---
        const monthYearDisplay = document.getElementById('month-year-display');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const todayBtn = document.getElementById('today-btn');
        const calendarBody = document.getElementById('calendar-body');
        const loadingIndicator = document.getElementById('loading');

        // --- Funkcje pomocnicze ---
        const getMonthName = (monthIndex) => [
            'Stycze≈Ñ', 'Luty', 'Marzec', 'Kwiecie≈Ñ', 'Maj', 'Czerwiec', 
            'Lipiec', 'Sierpie≈Ñ', 'Wrzesie≈Ñ', 'Pa≈∫dziernik', 'Listopad', 'Grudzie≈Ñ'
        ][monthIndex];
        const getDayName = (dayIndex) => ['ND', 'PN', 'WT', '≈öR', 'CZ', 'PT', 'SB'][dayIndex];
        
        const fields = ['ania', 'aniaPraca', 'michal', 'michalPraca', 'wspolne', 'inne'];

        // --- G≈Ç√≥wna funkcja renderujƒÖca kalendarz ---
        const renderCalendar = (year, month, events) => {
            loadingIndicator.style.display = 'none';
            calendarBody.innerHTML = '';
            monthYearDisplay.textContent = `${getMonthName(month)} ${year}`;
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayOfWeek = date.getDay();
                
                const isToday = today.toDateString() === date.toDateString();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const dayEvents = events[day] || {};

                // Kom√≥rka z informacjƒÖ o dniu
                const dayInfoCell = document.createElement('div');
                dayInfoCell.className = `calendar-cell flex items-center justify-center ${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''}`;
                dayInfoCell.innerHTML = `
                    <div class="day-info">
                        <div class="day-number">${day}</div>
                        <div class="day-name">${getDayName(dayOfWeek)}</div>
                    </div>
                `;
                calendarBody.appendChild(dayInfoCell);

                // Kom√≥rki na wydarzenia
                fields.forEach(field => {
                    const fieldCell = document.createElement('div');
                    fieldCell.className = `calendar-cell color-${field} ${isWeekend ? 'weekend' : ''}`;
                    
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'editable-field';
                    fieldDiv.dataset.day = day;
                    fieldDiv.dataset.field = field;
                    fieldDiv.textContent = dayEvents[field] || '';
                    
                    fieldCell.appendChild(fieldDiv);
                    calendarBody.appendChild(fieldCell);
                });
            }
        };

        const updateCalendar = () => {
            if (!db) return;
            unsubscribeFromEvents();
            loadingIndicator.style.display = 'block';
            calendarBody.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const calendarId = `${year}-${month + 1}`;
            const eventsCollectionRef = collection(db, calendarId);

            unsubscribeFromEvents = onSnapshot(eventsCollectionRef, (snapshot) => {
                const events = {};
                snapshot.forEach(doc => {
                    events[doc.id] = doc.data();
                });
                renderCalendar(year, month, events);
            }, (error) => {
                console.error("Firestore Read Error:", error);
                loadingIndicator.textContent = `B≈ÇƒÖd odczytu z bazy: ${error.message}. Sprawd≈∫ regu≈Çy bezpiecze≈Ñstwa w panelu Firestore.`;
            });
        };

        // --- Obs≈Çuga edycji danych ---
        calendarBody.addEventListener('click', (e) => {
            const fieldDiv = e.target.closest('.editable-field');
            if (fieldDiv) {
                if (fieldDiv.querySelector('textarea')) return;

                const currentText = fieldDiv.textContent;
                fieldDiv.innerHTML = '';

                const textarea = document.createElement('textarea');
                textarea.value = currentText;
                
                const saveChanges = async () => {
                    const newText = textarea.value;
                    fieldDiv.innerHTML = newText;
                    
                    if (newText !== currentText) {
                        fieldDiv.classList.add('saving');
                        try {
                           await saveEvent(fieldDiv.dataset.day, fieldDiv.dataset.field, newText);
                           fieldDiv.classList.remove('saving');
                           fieldDiv.classList.add('saved');
                           setTimeout(() => fieldDiv.classList.remove('saved'), 1500);
                        } catch (err) {
                           fieldDiv.classList.remove('saving');
                        }
                    }
                }

                textarea.addEventListener('blur', saveChanges);
                textarea.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        textarea.blur();
                    } else if (e.key === 'Escape') {
                        fieldDiv.innerHTML = currentText; // Anuluj
                    }
                });
                
                fieldDiv.appendChild(textarea);
                textarea.focus();
                textarea.style.height = 'auto';
                textarea.style.height = (textarea.scrollHeight) + 'px';
                textarea.addEventListener('input', () => {
                    textarea.style.height = 'auto';
                    textarea.style.height = (textarea.scrollHeight) + 'px';
                }, false);
            }
        });

        const saveEvent = async (day, field, value) => {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1;
            const calendarId = `${year}-${month}`;
            const dayId = day.toString();

            try {
                const docRef = doc(db, calendarId, dayId);
                await setDoc(docRef, { [field]: value }, { merge: true });
            } catch (error) {
                console.error("Firestore Write Error:", error);
                throw error;
            }
        };

        // --- G≈Ç√≥wna funkcja inicjalizujƒÖca ---
        const initCalendar = () => {
            prevMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                updateCalendar();
            });
            nextMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                updateCalendar();
            });
            todayBtn.addEventListener('click', () => {
                currentDate = new Date();
                updateCalendar();
            });
            
            updateCalendar();
        };

    </script>
</body>
</html>

