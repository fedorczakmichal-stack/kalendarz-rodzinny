<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Kalendarz Rodziny Fedorczak</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

    :root{
      --c-ania:#f0fff4;--c-aniaP:#fff1f2;--c-michal:#f0f9ff;--c-michalP:#f5f3ff;--c-wsp:#fffbeb;--c-inne:#f1f5f9;
      --k-lask:#a7f3d0;--k-brzeziny:#fde68a;--k-ortho:#f9a8d4;--k-jb:#c4b5fd;--k-jb24:#7c3aed;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    body{
      font-family:'Inter',sans-serif;
      background:linear-gradient(135deg,#fef3f8,#f3f4f6);
      -webkit-font-smoothing:antialiased;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      min-height: -webkit-fill-available;
      overflow-x: hidden;
    }
    
    html, body {
      position: fixed;
      overflow: hidden;
      width: 100%;
      height: 100%;
    }
    #app-container {
      width: 100%;
      height: 100%;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .hdr{
      background:#fff;
      border-bottom:1px solid #e5e7eb;
      padding:.75rem 1rem;
      box-shadow:0 1px 3px rgba(0,0,0,.08);
      position: sticky;
      top: 0;
      z-index: 100;
      padding-top: calc(.75rem + var(--safe-top));
    }
    
    @media (max-width: 768px) {
      .mobile-grid-cell.c-ania { background: rgba(240, 255, 244, 0.5); }
      .mobile-grid-cell.c-aniaP { background: rgba(255, 241, 242, 0.5); }
      .mobile-grid-cell.c-michal { background: rgba(240, 249, 255, 0.5); }
      .mobile-grid-cell.c-michalP { background: rgba(245, 243, 255, 0.5); }
      .mobile-grid-cell.c-wsp { background: rgba(255, 251, 235, 0.5); }
      .mobile-grid-cell.c-inne { background: rgba(241, 245, 249, 0.5); }
      .hdr {
        padding: .5rem;
        padding-top: calc(.5rem + var(--safe-top));
      }
      .hdr .desktop-controls { display: none; }
      .mobile-header { display: flex; flex-direction: column; gap: .75rem; }
      .mobile-nav { display: flex; align-items: center; justify-content: space-between; gap: .5rem; padding: 0 .25rem; }
      .mobile-brand { display: flex; align-items: center; gap: .5rem; }
      .mobile-brand .logo { width: 32px; height: 32px; background: #8b5cf6; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
      .mobile-brand .title { font-weight: 800; font-size: 1rem; color: #1f2937; }
      .mobile-controls { display: flex; align-items: center; justify-content: space-between; background: #f9fafb; border-radius: 12px; padding: .5rem; margin: 0 .25rem; }
      .month-selector { display: flex; align-items: center; gap: .25rem; flex: 1; }
      .month-title { flex: 1; text-align: center; font-weight: 600; font-size: .95rem; color: #374151; }
      .nav-btn { width: 36px; height: 36px; border-radius: 8px; background: white; border: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #6b7280; transition: all .2s; }
      .nav-btn:active { background: #f3f4f6; transform: scale(0.95); }
      .today-btn { padding: .5rem 1rem; background: linear-gradient(135deg, #8b5cf6, #ec4899); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: .85rem; transition: all .2s; }
      .today-btn:active { transform: scale(0.95); }
      .mobile-menu-btn { width: 36px; height: 36px; border-radius: 8px; background: white; border: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; }
    }
    
    .sumbar{display:flex;gap:.5rem;flex-wrap:wrap;background:#fff;border-bottom:1px solid #e5e7eb;padding:.5rem 1rem}
    .chip{display:inline-flex;gap:.35rem;align-items:center;border:1px solid #e5e7eb;background:#f9fafb;border-radius:9999px;padding:.3rem .55rem;font-size:.82rem}
    .dot{width:.55rem;height:.55rem;border-radius:9999px}
    @media (max-width:768px){.sumbar{display:none}}
    
    .grid{display:grid;grid-template-columns:64px repeat(6,1fr);border-top:1px solid #e5e7eb}
    .cell{border-bottom:1px solid #e5e7eb;border-left:1px solid #e5e7eb;min-height:60px;position:relative;padding:4px}
    .cell:nth-child(7n+1){border-left:none}
    .cell.header{background:#f9fafb;font-weight:600}
    .day-cell{cursor:pointer}
    .day-num{font-weight:800;color:#374151}
    .day-name{font-size:.7rem;color:#6b7280}
    .today .day-num,.today .day-name{color:#6d28d9}
    .off{position:relative}
    .off::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(239,68,68,.08),rgba(219,39,119,.08));pointer-events:none;z-index:1}
    .fld{height:100%;padding:6px;border-radius:10px;font-size:.9rem;line-height:1.35;cursor:pointer;word-break:break-word;transition:transform .12s;position:relative;z-index:2}
    .fld:hover{transform:translateY(-1px)}
    .c-ania{background:var(--c-ania)} .c-aniaP{background:var(--c-aniaP)} .c-michal{background:var(--c-michal)} .c-michalP{background:var(--c-michalP)} .c-wsp{background:var(--c-wsp)} .c-inne{background:var(--c-inne)}
    .tile-ortho{background:var(--k-ortho)!important;font-weight:600} .tile-brzeziny{background:var(--k-brzeziny)!important;font-weight:600} .tile-lask{background:var(--k-lask)!important;font-weight:600} .tile-jb{background:var(--k-jb)!important;font-weight:600} .tile-jb24{background:var(--k-jb24)!important;color:#fff;font-weight:700}
    
    .mcal{ display:none; padding:.5rem; padding-bottom: calc(.5rem + var(--safe-bottom) + 70px); }
    .mobile-grid-view { display: none; overflow-x: auto; padding: 0.5rem; padding-bottom: calc(.5rem + var(--safe-bottom) + 70px); -webkit-overflow-scrolling: touch; position: relative; }
    .mobile-grid-wrapper { min-width: 550px; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,.06); }
    .mobile-grid-table { display: grid; grid-template-columns: 45px repeat(6, minmax(70px, 1fr)); font-size: 0.7rem; }
    .mobile-grid-cell { border: 0.5px solid #e5e7eb; min-height: 35px; padding: 3px; display: flex; align-items: center; justify-content: center; text-align: center; word-break: break-word; }
    .mobile-grid-header { background: #f9fafb; font-weight: 600; font-size: 0.6rem; color: #4b5563; position: sticky; top: 0; z-index: 10; min-height: 30px; }
    .mobile-grid-day { font-weight: 700; background: #fafafa; flex-direction: column; font-size: 0.65rem; padding: 2px; position: sticky; left: 0; z-index: 5; }
    .mobile-grid-day .day-num { font-size: 0.85rem; color: #1f2937; }
    .mobile-grid-day.weekend { background: #fef2f2; }
    .mobile-grid-day.today { background: linear-gradient(135deg, #ede9fe, #fce7f3); color: #7c3aed; box-shadow: inset 0 0 0 2px rgba(124, 58, 237, 0.3); }
    .mobile-grid-content { font-size: 0.65rem; line-height: 1.15; padding: 2px; border-radius: 3px; width: 100%; min-height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.15s; }
    .mobile-grid-content:active { transform: scale(0.95); }
    
    .view-toggle { background: #f3f4f6; border-radius: 999px; padding: 4px; z-index: 1000; display:flex; gap:4px; border: 1px solid #e5e7eb; }
    .view-toggle button { padding: 4px 10px; border-radius: 999px; font-size: 0.7rem; font-weight: 600; transition: all 0.2s; background: transparent; color: #6b7280; border: none; }
    .view-toggle button.active { background: white; color: #1f2937; box-shadow: 0 1px 2px rgba(0,0,0,.08); }
    
    @media (max-width:768px){
      .grid{display:none} 
      .mcal{display:none}
      .mobile-grid-view{display:block}
      body.card-view .mcal{display:block}
      body.card-view .mobile-grid-view{display:none}
      .m-card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:.75rem; margin-bottom:.65rem; box-shadow:0 2px 8px rgba(0,0,0,.06); transition: all .2s; }
      .m-card:active { transform: scale(0.98); }
      .m-head{ display:flex; justify-content:space-between; align-items:center; margin-bottom:.4rem; padding-bottom:.4rem; border-bottom:1.5px solid #f3f4f6; }
      .m-num{ font-size:1.35rem; font-weight:800; color:#1f2937; } 
      .m-name{ font-size:.75rem; color:#6b7280; margin-left: .25rem; } 
      .tag{ font-size:.65rem; border-radius:999px; padding:.15rem .4rem; font-weight: 600; }
      .m-row{ display:flex; gap:.4rem; align-items:stretch; margin:.25rem 0; } 
      .m-label{ flex:0 0 75px; border-radius:8px; padding:.4rem .45rem; font-weight:600; color:#334155; font-size: .75rem; display: flex; align-items: center; } 
      .m-content{ flex:1; border-radius:8px; padding:.5rem .6rem; cursor:pointer; position:relative; z-index:2; min-height:34px; display:flex; align-items:center; transition: all .15s; }
      .m-content:active { background-color: rgba(0,0,0,.05); }
      .m-content .txt{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; font-size:.85rem; line-height: 1.3; }
      .m-content .placeholder { color: #9ca3af; font-size: .8rem; }
    }
    
    #ctx{position:fixed;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 12px 24px rgba(0,0,0,.15);padding:6px;display:none;z-index:1000}
    .ctx-it{padding:10px 14px;font-size:.9rem;color:#374151;cursor:pointer;border-radius:8px} .ctx-it:hover{background:#f3f4f6}
    
    #edit{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:1200; padding:16px; }
    .edit-body{ background:#fff; border-radius:20px; width:min(720px,100%); max-height:86vh; overflow:hidden; padding:0; display:flex; flex-direction:column; box-shadow: 0 20px 40px rgba(0,0,0,.2); }
    .edit-head{ position:sticky; top:0; z-index:5; background:#fff; border-bottom:1.5px solid #e5e7eb; display:flex; align-items:center; gap:.75rem; padding:1rem; }
    .edit-title{font-weight:800;color:#0f172a;font-size:1.1rem}
    .edit-close{ margin-left:auto; flex-shrink:0; width:36px; height:36px; border-radius:10px; border:1px solid #e5e7eb; background:#f8fafc; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #6b7280; }
    .edit-close:active{background:#eef2ff;border-color:#c7d2fe}
    .edit-content{ padding:1rem; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    .edit-foot{ padding: 1rem; border-top: 1.5px solid #e5e7eb; background: #f8fafc; display:flex; justify-content:flex-end; gap: .5rem; }
    
    @media (max-width:768px){
        #edit{align-items:flex-end;padding:0}
        .edit-body{ width:100%; max-height:92vh; border-radius:20px 20px 0 0; animation: slideUp .3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .edit-head{ padding-top:1.25rem; padding-bottom:1rem; }
        .edit-content { padding: 1rem; padding-bottom: 1.5rem; }
        .edit-foot{ padding-bottom:calc(1rem + var(--safe-bottom)); }
        .edit-content input[type="text"], .edit-content input[type="number"] { font-size: 16px; }
    }
    
    #fab{ position:fixed; right:16px; bottom:calc(16px + var(--safe-bottom)); z-index:1100; display:none; align-items:center; gap:.4rem; background:linear-gradient(135deg,#8b5cf6,#ec4899); color:#fff; border:none; border-radius:999px; padding:.65rem .9rem; font-weight:700; font-size: .85rem; box-shadow: 0 4px 12px rgba(139, 92, 246, .4); transition: all .2s; }
    #fab:active { transform: scale(0.95); }
    #fab svg{width:16px;height:16px}
    @media (max-width:768px){#fab{display:inline-flex}}
    
    #sheet{ position:fixed; left:0; right:0; bottom:0; background:#fff; border-top-left-radius:20px; border-top-right-radius:20px; box-shadow:0 -8px 24px rgba(0,0,0,.15); transform:translateY(110%); transition:transform .25s cubic-bezier(0.4, 0, 0.2, 1); z-index:1200; padding-bottom: var(--safe-bottom); max-height: 85vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    #sheet.open{transform:translateY(0)}
    .sheet-handle { width: 36px; height: 4px; background: #d1d5db; border-radius: 999px; margin: .75rem auto .5rem; }
    .sheet-content { padding: 1rem; padding-top: 0; }
    .sheet-grid { display: grid; grid-template-columns: 1fr 1fr; gap: .5rem; margin-top: .75rem; }
    .sheet-item { padding: .75rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px; }
    .sheet-item.highlight { background: linear-gradient(135deg, #ede9fe, #fce7f3); border-color: #c7d2fe; }
    .sheet-item.full { grid-column: span 2; }
    .sheet-label { font-size: .7rem; color: #6b7280; font-weight: 500; margin-bottom: .15rem; }
    .sheet-value { font-size: 1.1rem; font-weight: 700; color: #1f2937; }
    .sheet-close-btn { width: 100%; padding: .75rem; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 12px; font-weight: 600; color: #374151; margin-top: 1rem; transition: all .2s; }
    .sheet-close-btn:active { background: #e5e7eb; transform: scale(0.98); }
    
    #mobile-menu { position: fixed; top: 0; right: 0; bottom: 0; left: 0; background: rgba(0,0,0,.5); z-index: 1300; display: none; animation: fadeIn .2s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    #mobile-menu.open { display: block; }
    .menu-panel { position: absolute; right: 0; top: 0; bottom: 0; width: min(85%, 320px); background: white; padding: 1rem; padding-top: calc(1rem + var(--safe-top)); box-shadow: -4px 0 12px rgba(0,0,0,.1); animation: slideIn .3s; overflow-y: auto; }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    .menu-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: .75rem; border-bottom: 1px solid #e5e7eb; }
    .menu-title { font-weight: 700; font-size: 1.1rem; color: #1f2937; }
    .menu-close { width: 32px; height: 32px; border-radius: 8px; background: #f3f4f6; border: none; display: flex; align-items: center; justify-content: center; }
    .menu-item { display: block; width: 100%; padding: .75rem 1rem; margin-bottom: .5rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 10px; font-weight: 600; font-size: .9rem; text-align: left; transition: all .2s; }
    .menu-item:active { background: #f3f4f6; transform: scale(0.98); }
    .menu-item.primary { background: linear-gradient(135deg, #8b5cf6, #ec4899); color: white; border: none; }
    .menu-item.danger { background: #fee2e2; color: #dc2626; border-color: #fca5a5; }
    
    .sync-status { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 0.5rem; font-size: 0.875rem; color: #0369a1; margin-left: 0.5rem; }
    .sync-status.success { background: #f0fdf4; border-color: #86efac; color: #14532d; }
    .sync-status.error { background: #fef2f2; border-color: #fca5a5; color: #7f1d1d; }
    .sync-status.syncing { background: #fef3c7; border-color: #fcd34d; color: #92400e; }
    
    .form-group { margin-bottom: 1rem; }
    .form-label { display: block; font-weight: 600; color: #374151; margin-bottom: .35rem; font-size: .85rem; }
    .form-input { width: 100%; padding: .75rem; border: 1.5px solid #e5e7eb; border-radius: 10px; font-size: 16px; transition: all .2s; }
    .form-input:focus { outline: none; border-color: #8b5cf6; box-shadow: 0 0 0 3px rgba(139, 92, 246, .1); }
    .hours-control { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px; padding: .75rem; margin-bottom: .75rem; }
    .hours-control-label { font-weight: 600; color: #1f2937; font-size: .85rem; margin-bottom: .5rem; }
    .hours-slider { width: 100%; margin: .5rem 0; }
    .hours-number { width: 100%; padding: .5rem; border: 1.5px solid #e5e7eb; border-radius: 8px; text-align: center; font-weight: 600; font-size: 16px; }
    
    button, .m-content, .m-card, .nav-btn, .menu-item { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 999px; }

    .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="app-container">
    <header class="hdr">
      <div class="desktop-controls flex flex-wrap items-center justify-between gap-3">
        <div class="flex items-center gap-4 flex-1">
          <div class="w-12 h-12 rounded-lg bg-purple-600 flex items-center justify-center shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7 text-white">
              <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 002 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/>
            </svg>
          </div>
          <div>
            <div class="font-extrabold text-xl text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600">Kalendarz Rodzinny</div>
            <div class="text-slate-500 text-xs uppercase tracking-wider">Auto-Sync z OneDrive</div>
          </div>
          <div class="ml-auto flex items-center gap-2 text-sm text-gray-500">
            <span class="hidden lg:inline-flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <span id="current-time"></span>
            </span>
          </div>
        </div>
        <div class="flex items-center gap-2 flex-wrap">
          <button id="prev" class="p-2 rounded-lg hover:bg-gray-100" title="Poprzedni miesiƒÖc"><svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
          <h2 id="title" class="font-semibold text-slate-700 min-w-[160px] text-center">‚Äî</h2>
          <button id="next" class="p-2 rounded-lg hover:bg-gray-100 mr-2" title="Nastƒôpny miesiƒÖc"><svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
          <button id="today" class="px-3 py-2 text-sm font-semibold text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Dzi≈õ</button>
          <div class="flex items-center gap-2 ml-4">
            <button id="onedriveBtn" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white rounded-lg transition-all" style="background: #0078d4;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M16.95 8.89c-.21-3.85-3.44-6.89-7.35-6.89-2.54 0-4.79 1.31-6.12 3.3C1.53 5.6 0 7.56 0 9.89c0 2.75 2.25 5 5 5h11.5c2.49 0 4.5-2.01 4.5-4.5 0-2.32-1.75-4.23-4.05-4.5z"/></svg>
                <span id="onedriveBtnText">Po≈ÇƒÖcz OneDrive</span>
            </button>
            <div id="syncStatus" style="display:none"></div>
            <input type="file" id="xlsxFileInput" accept=".xlsx,.xls" class="hidden">
            <label for="xlsxFileInput" class="cursor-pointer inline-flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-gradient-to-r from-green-500 to-green-600 rounded-lg hover:from-green-600 hover:to-green-700 shadow-sm transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                <span>Import rƒôczny</span>
            </label>
            <button id="clearMonthBtn" class="px-3 py-2 text-sm font-semibold text-white bg-red-600 rounded-md hover:bg-red-700">Wyczy≈õƒá miesiƒÖc</button>
            <button id="exportIcsBtn" class="px-3 py-2 text-sm font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700">Eksportuj .ics</button>
          </div>
        </div>
      </div>
      
      <div class="mobile-header md:hidden">
        <div class="mobile-nav">
          <div class="mobile-brand">
            <div class="logo">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-white">
                <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 002 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/>
              </svg>
            </div>
            <div class="title">Kalendarz Rodzinny</div>
          </div>
          <div class="view-toggle">
              <button id="grid-view-btn" class="active">Siatka</button>
              <button id="card-view-btn">Karty</button>
          </div>
          <button id="mobile-menu-btn" class="mobile-menu-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"></path></svg>
          </button>
        </div>
        <div class="mobile-controls">
          <div class="month-selector mr-2">
            <button id="prev-mobile" class="nav-btn"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path></svg></button>
            <h2 id="title-mobile" class="month-title">‚Äî</h2>
            <button id="next-mobile" class="nav-btn"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path></svg></button>
          </div>
          <button id="today-mobile" class="today-btn">Dzi≈õ</button>
        </div>
      </div>
    </header>
    
    <div class="sumbar">
      <span class="chip"><span class="dot" style="background:var(--k-ortho)"></span> Ortho: <b id="sum-ortho">0h</b></span>
      <span class="chip"><span class="dot" style="background:var(--k-brzeziny)"></span> Brzeziny: <b id="sum-brzeziny">0h</b></span>
      <span class="chip"><span class="dot" style="background:var(--k-lask)"></span> ≈Åask: <b id="sum-lask">0h</b></span>
      <span class="chip"><span class="dot" style="background:var(--k-jb)"></span> JB: <b id="sum-jb">0h</b></span>
      <span class="chip"><span class="dot" style="background:#8b5cf6"></span> ≈ÅƒÖcznie godzin: <b id="sum-total-hours">0h</b></span>
      <span class="chip"><span class="dot" style="background:#fca5a5"></span> Porty: <b id="sum-ports">0</b></span>
      <span class="chip"><span class="dot" style="background:#fcd34d"></span> Jednodni√≥wki: <b id="sum-jednodniowki">0</b></span>
      <span class="chip"><span class="dot" style="background:#818cf8"></span> Kwalifikacje: <b id="sum-kwalifikacje">0</b></span>
      <span class="chip"><span class="dot" style="background:#f87171"></span> Komercja: <b id="sum-komercja">0</b></span>
      <span class="chip"><span class="dot" style="background:#6ee7b7"></span> üí∞ Zarobki: <b id="sum-earnings">0 z≈Ç</b></span>
    </div>
    
    <main class="w-full bg-white flex flex-col flex-grow">
      <div id="standard" class="flex-1 flex flex-col">
        <div id="desk-wrap" class="overflow-auto hidden md:block flex-1">
          <div class="bg-white border-t min-w-[900px]">
            <div class="grid font-semibold text-sm text-center text-gray-700 sticky top-0 bg-white z-10">
              <div class="cell header p-3">Dzie≈Ñ</div><div class="cell header p-3 c-ania">Ania</div><div class="cell header p-3 c-aniaP">Ania Praca</div><div class="cell header p-3 c-michal">Micha≈Ç</div><div class="cell header p-3 c-michalP">Micha≈Ç Praca</div><div class="cell header p-3 c-wsp">Niania</div><div class="cell header p-3 c-inne">Inne</div>
            </div>
            <div id="desk" class="grid"></div>
          </div>
        </div>
        <div id="mobile-grid-view" class="mobile-grid-view md:hidden">
          <div class="mobile-grid-wrapper">
            <div id="mobile-grid-content" class="mobile-grid-table"></div>
          </div>
        </div>
        <div id="mob" class="mcal md:hidden"></div>
      </div>
    </main>
    
    <button id="fab" aria-label="Poka≈º podsumowanie">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
      Podsumowanie
    </button>
    
    <div id="sheet">
      <div class="sheet-handle"></div>
      <div class="sheet-content">
        <h3 id="sheet-title" class="text-lg font-bold text-gray-900 mb-1">Podsumowanie</h3>
        <div class="sheet-grid">
          <div class="sheet-item"><div class="sheet-label">Ortho</div><div id="ms-ortho" class="sheet-value">0h</div></div>
          <div class="sheet-item"><div class="sheet-label">Brzeziny</div><div id="ms-brzeziny" class="sheet-value">0h</div></div>
          <div class="sheet-item"><div class="sheet-label">≈Åask</div><div id="ms-lask" class="sheet-value">0h</div></div>
          <div class="sheet-item"><div class="sheet-label">JB</div><div id="ms-jb" class="sheet-value">0h</div></div>
          <div class="sheet-item highlight full"><div class="sheet-label">üìä ≈ÅƒÖcznie godzin</div><div id="ms-total-hours" class="sheet-value">0h</div></div>
          <div class="sheet-item"><div class="sheet-label">Porty</div><div id="ms-ports" class="sheet-value">0</div></div>
          <div class="sheet-item"><div class="sheet-label">Jednodni√≥wki</div><div id="ms-jednodniowki" class="sheet-value">0</div></div>
          <div class="sheet-item"><div class="sheet-label">Kwalifikacje</div><div id="ms-kwalifikacje" class="sheet-value">0</div></div>
          <div class="sheet-item"><div class="sheet-label">Komercja</div><div id="ms-komercja" class="sheet-value">0</div></div>
          <div class="sheet-item highlight full"><div class="sheet-label">üí∞ Zarobki</div><div id="ms-earnings" class="sheet-value">0 z≈Ç</div></div>
        </div>
        <button id="sheet-close" class="sheet-close-btn">Zamknij</button>
      </div>
    </div>
    
    <div id="mobile-menu">
      <div class="menu-panel">
        <div class="menu-header"><div class="menu-title">Menu</div><button id="menu-close" class="menu-close">‚úï</button></div>
        <button id="onedriveBtnMobile" class="menu-item primary">‚òÅÔ∏è OneDrive</button>
        <input type="file" id="xlsxFileInputMobile" accept=".xlsx,.xls" class="hidden">
        <label for="xlsxFileInputMobile" class="menu-item">üìÑ Import rƒôczny</label>
        <button id="exportIcsBtnMobile" class="menu-item">üìÖ Eksportuj .ics</button>
        <button id="clearMonthBtnMobile" class="menu-item danger">üóëÔ∏è Wyczy≈õƒá miesiƒÖc</button>
      </div>
    </div>
    
    <div id="ctx">
      <div id="ctx-copy" class="ctx-it">Kopiuj</div><div id="ctx-cut" class="ctx-it">Wytnij</div>
      <div id="ctx-paste" class="ctx-it">Wklej</div><div class="h-px bg-gray-200 my-1"></div>
      <div id="ctx-del" class="ctx-it text-red-600">Usu≈Ñ</div>
    </div>
    
    <div id="edit">
      <div class="edit-body">
        <div class="edit-head"><h3 id="edit-title" class="edit-title">Edycja</h3><button id="edit-close" class="edit-close">‚úï</button></div>
        <div id="edit-content" class="edit-content"></div>
        <div class="edit-foot"><button id="edit-save" class="px-4 py-2.5 text-sm font-semibold text-white bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg">Zapisz</button></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, updateDoc, deleteField, getDocs, getDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const cfg = { apiKey:"AIzaSyAgHtQFaHXlPweFU90GKGW2Jx0fl23VRkQ", authDomain:"kalendarz-rodzinny-68d04.firebaseapp.com", projectId:"kalendarz-rodzinny-68d04", storageBucket:"kalendarz-rodzinny-68d04.appspot.com", messagingSenderId:"1050937545151", appId:"1:1050937545151:web:a85fd1a5f066f4a499910a", measurementId:"G-57YKE2XKQ1"};
    let db; 
    try{ 
      const app=initializeApp(cfg); 
      const auth=getAuth(app); 
      db=getFirestore(app); 
      signInAnonymously(auth); 
      onAuthStateChanged(auth, u=>u && init()); 
    } catch(e){ 
      console.error(e); 
    }

    // Tw√≥j Client ID z Azure Portal
    const ONEDRIVE_CLIENT_ID = 'b128c542-2b84-466f-a1e1-8c10862821e5';
    const ONEDRIVE_REDIRECT_URI = 'https://rodzinnykalendarz.netlify.app/';
    const SYNC_INTERVAL = 300000; // 5 minut (300000 ms) - zmie≈Ñ na 60000 dla 1 minuty
    
    let cur = new Date(); 
    let unsub=()=>{}; 
    let isMobile=matchMedia("(max-width: 768px)").matches;
    const fields=['ania','aniaPraca','michal','michalPraca','wspolne','inne'];
    const labels={ania:'Ania',aniaPraca:'Ania Praca',michal:'Micha≈Ç',michalPraca:'Micha≈Ç Praca',wspolne:'Niania',inne:'Inne'};
    let data={}; 
    let clip=null;
    let onedriveToken = null;
    let autoSyncInterval = null;
    
    const el=id=>document.getElementById(id);
    const E={ title:el('title'),titleMobile:el('title-mobile'),prev:el('prev'),prevMobile:el('prev-mobile'), next:el('next'),nextMobile:el('next-mobile'),today:el('today'),todayMobile:el('today-mobile'), desk:el('desk'),mob:el('mob'),sumOrtho:el('sum-ortho'),sumBrz:el('sum-brzeziny'), sumLask:el('sum-lask'),sumJB:el('sum-jb'),sumPorts:el('sum-ports'), sumJednodniowki:el('sum-jednodniowki'),sumKwalifikacje:el('sum-kwalifikacje'), sumKomercja:el('sum-komercja'),sumEarnings:el('sum-earnings'),sumTotalHours:el('sum-total-hours'), msOrtho:el('ms-ortho'),msBrz:el('ms-brzeziny'),msLask:el('ms-lask'),msJB:el('ms-jb'), msPorts:el('ms-ports'),msJednodniowki:el('ms-jednodniowki'),msKwalifikacje:el('ms-kwalifikacje'), msKomercja:el('ms-komercja'),msEarnings:el('ms-earnings'),msTotalHours:el('ms-total-hours'), sheet:el('sheet'),sheetClose:el('sheet-close'),fab:el('fab'),sheetTitle:el('sheet-title'), ctx:el('ctx'),ctxCopy:el('ctx-copy'),ctxCut:el('ctx-cut'),ctxPaste:el('ctx-paste'), ctxDel:el('ctx-del'),edit:el('edit'),editClose:el('edit-close'),editContent:el('edit-content'), editTitle:el('edit-title'),editSave:el('edit-save'), xlsxFileInput:el('xlsxFileInput'), clearMonthBtn:el('clearMonthBtn'), exportIcsBtn:el('exportIcsBtn'),mobileMenu:el('mobile-menu'),mobileMenuBtn:el('mobile-menu-btn'), menuClose:el('menu-close'), xlsxFileInputMobile:el('xlsxFileInputMobile'), clearMonthBtnMobile:el('clearMonthBtnMobile'), exportIcsBtnMobile:el('exportIcsBtnMobile'), syncStatus:el('syncStatus'), mobileGridView:el('mobile-grid-view'), mobileGridContent:el('mobile-grid-content'), gridViewBtn:el('grid-view-btn'), cardViewBtn:el('card-view-btn'), currentTime:el('current-time'), onedriveBtn:el('onedriveBtn'), onedriveBtnText:el('onedriveBtnText'), onedriveBtnMobile:el('onedriveBtnMobile') };
    
    window.addEventListener('resize',()=>{const was=isMobile;isMobile=matchMedia("(max-width: 768px)").matches;if(was!==isMobile)update();});
    
    const mNames=['Stycze≈Ñ','Luty','Marzec','Kwiecie≈Ñ','Maj','Czerwiec','Lipiec','Sierpie≈Ñ','Wrzesie≈Ñ','Pa≈∫dziernik','Listopad','Grudzie≈Ñ'];
    const dNamesFull=['Poniedzia≈Çek','Wtorek','≈öroda','Czwartek','PiƒÖtek','Sobota','Niedziela']; 
    const dShort=['PN','WT','≈öR','CZ','PT','SB','ND'];
    const getDayIdx=d=>(d+6)%7;
    const hourlyRates={brzeziny:400,ortho:400,jb:220,lask:190};
    const portRates={install:731,remove:386};
    const endoRates={one_day:200,qual:80};
    const komercjaRate = 500;
    const ZASTEPCA_ORDYNATORA_BONUS = 4000;
    const jb24=['jb oit','jb zniecz','jb znieczulenia','jb znieczule≈Ñ'];
    const isOrtho=t=>/ortho/i.test(t||''); 
    const isBrzeziny=t=>/brzeziny/i.test(t||''); 
    const isLask=t=>/≈Çask/i.test(t||''); 
    const isJB=t=>!!(t&&(t.toLowerCase().startsWith('jb')||t.toLowerCase().includes('jb ')));

    const getFieldClass=(field)=>({aniaPraca:'c-aniaP',michalPraca:'c-michalP',wspolne:'c-wsp'}[field]||`c-${field}`);
    const getTileClass=t=>{ if(!t)return''; const s=t.toLowerCase(); if(jb24.some(k=>s.includes(k)))return'tile-jb24'; if(isLask(s))return'tile-lask'; if(isOrtho(s))return'tile-ortho'; if(isBrzeziny(s))return'tile-brzeziny'; if(s.startsWith('jb'))return'tile-jb'; return''; };
    const getDefaultHours = (txt) => { if (!txt) return 0; const s = txt.toLowerCase(); if (isOrtho(s) || isBrzeziny(s)) return 10; if (isLask(s)) return 24; if (jb24.some(k => s.includes(k))) return 24; if (/rano|poranna|7[:\.]30|wybudze/i.test(s)) return 6; if (isJB(s)) return 6; return 0; };
    const getEntryProp = (day, field, prop, fallback) => (data[day]?.[field]?.[prop]) ?? fallback;
    const getEntryText = (day, field) => { const entry = data[day]?.[field]; return typeof entry === 'object' ? entry.text || '' : entry || ''; };

    function showSyncStatus(message, type = 'info') { 
      E.syncStatus.style.display = 'inline-flex'; 
      E.syncStatus.className = `sync-status ${type}`; 
      E.syncStatus.innerHTML = message; 
      if (type !== 'syncing') setTimeout(() => { E.syncStatus.style.display = 'none'; }, 5000); 
    }

    async function connectOneDrive() {
      if (ONEDRIVE_CLIENT_ID === 'TW√ìJ_CLIENT_ID_TUTAJ') {
        alert('‚ùå BRAK CLIENT ID\n\nMusisz najpierw:\n1. Przej≈õƒá na portal.azure.com\n2. Utworzyƒá aplikacjƒô w Azure Active Directory\n3. Skopiowaƒá Application (client) ID\n4. Wkleiƒá go w kodzie zamiast TW√ìJ_CLIENT_ID_TUTAJ');
        return;
      }
      
      const authUrl = `https://login.microsoftonline.com/common/oauth2/v2.0/authorize?` +
        `client_id=${ONEDRIVE_CLIENT_ID}` +
        `&response_type=token` +
        `&redirect_uri=${encodeURIComponent(ONEDRIVE_REDIRECT_URI)}` +
        `&scope=${encodeURIComponent('Files.Read offline_access')}`;
      
      window.location.href = authUrl;
    }

    function handleAuthRedirect() {
      const hash = window.location.hash;
      if (hash && hash.includes('access_token')) {
        const params = new URLSearchParams(hash.substring(1));
        const token = params.get('access_token');
        if (token) {
          onedriveToken = token;
          localStorage.setItem('onedrive_token', token);
          window.history.replaceState({}, document.title, window.location.pathname);
          updateOneDriveUI(true);
          startAutoSync();
          return true;
        }
      }
      return false;
    }

    function updateOneDriveUI(connected) {
      if (connected) {
        E.onedriveBtnText.textContent = 'Po≈ÇƒÖczono ‚úì';
        E.onedriveBtn.style.background = '#16a34a';
        E.onedriveBtnMobile.textContent = '‚òÅÔ∏è Po≈ÇƒÖczono z OneDrive';
        E.onedriveBtnMobile.style.background = '#16a34a';
      } else {
        E.onedriveBtnText.textContent = 'Po≈ÇƒÖcz OneDrive';
        E.onedriveBtn.style.background = '#0078d4';
        E.onedriveBtnMobile.textContent = '‚òÅÔ∏è Po≈ÇƒÖcz OneDrive';
        E.onedriveBtnMobile.style.background = '';
      }
    }

    async function getOnedriveFiles() {
      if (!onedriveToken) throw new Error('Brak tokenu OneDrive');
      
      // Szukaj w folderze "plany pracy"
      const response = await fetch('https://graph.microsoft.com/v1.0/me/drive/root:/plany pracy:/children', {
        headers: { 'Authorization': `Bearer ${onedriveToken}` }
      });
      
      if (!response.ok) {
        if (response.status === 401) {
          onedriveToken = null;
          localStorage.removeItem('onedrive_token');
          updateOneDriveUI(false);
          throw new Error('Token wygas≈Ç - zaloguj siƒô ponownie');
        }
        if (response.status === 404) {
          throw new Error('Nie znaleziono folderu "plany pracy" w OneDrive');
        }
        throw new Error('B≈ÇƒÖd pobierania plik√≥w z OneDrive');
      }
      
      const data = await response.json();
      return data.value.filter(file => file.name.match(/\.(xlsx|xls)$/i));
    }

    async function downloadFile(fileId) {
      const response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/content`, {
        headers: { 'Authorization': `Bearer ${onedriveToken}` }
      });
      
      if (!response.ok) throw new Error('B≈ÇƒÖd pobierania pliku');
      return await response.arrayBuffer();
    }

    async function syncFromOneDrive() {
      if (!onedriveToken) {
        showSyncStatus('‚ö†Ô∏è Brak po≈ÇƒÖczenia z OneDrive', 'error');
        return;
      }

      try {
        showSyncStatus('<span class="spinner"></span> Synchronizacja...', 'syncing');
        
        const files = await getOnedriveFiles();
        const mNamesToNum = { 
          'stycze≈Ñ': 0, 'styczen': 0, 'stycznia': 0, 'sty': 0, 
          'luty': 1, 'lutego': 1, 'lut': 1, 
          'marzec': 2, 'marca': 2, 'mar': 2, 
          'kwiecie≈Ñ': 3, 'kwiecien': 3, 'kwietnia': 3, 'kwi': 3, 
          'maj': 4, 'maja': 4, 
          'czerwiec': 5, 'czerwca': 5, 'cze': 5, 
          'lipiec': 6, 'lipca': 6, 'lip': 6, 
          'sierpie≈Ñ': 7, 'sierpien': 7, 'sierpnia': 7, 'sie': 7, 
          'wrzesie≈Ñ': 8, 'wrzesien': 8, 'wrze≈õnia': 8, 'wrz': 8, 
          'pa≈∫dziernik': 9, 'pazdziernik': 9, 'pa≈∫dziernika': 9, 'pa≈∫': 9, 'paz': 9,
          'listopad': 10, 'listopada': 10, 'lis': 10, 
          'grudzie≈Ñ': 11, 'grudzien': 11, 'grudnia': 11, 'gru': 11 
        };
        
        let syncedFiles = 0;
        
        // Synchronizuj WSZYSTKIE pliki znalezione w folderze
        for (const file of files) {
          const monthNamesPattern = Object.keys(mNamesToNum).join('|');
          const dateRegex = new RegExp(`(?:plan\\s+pracy\\s+)?(${monthNamesPattern})\\s+(\\d{4})`, 'i');
          const match = file.name.match(dateRegex);
          
          if (match) {
            const targetMonth = mNamesToNum[match[1].toLowerCase()];
            const targetYear = parseInt(match[2], 10);
            
            console.log(`Synchronizacja: ${file.name} -> ${mNames[targetMonth]} ${targetYear}`);
            
            const fileData = await downloadFile(file.id);
            await processExcelData(fileData, file.name, targetYear, targetMonth);
            syncedFiles++;
          }
        }
        
        if (syncedFiles === 0) {
          showSyncStatus('‚ö†Ô∏è Brak plik√≥w do synchronizacji', 'error');
          return;
        }
        
        showSyncStatus(`‚úì Zsynchronizowano ${syncedFiles} ${syncedFiles === 1 ? 'miesiƒÖc' : syncedFiles < 5 ? 'miesiƒÖce' : 'miesiƒôcy'}`, 'success');
        
        await update();
        
      } catch (error) {
        console.error('B≈ÇƒÖd synchronizacji:', error);
        showSyncStatus(`‚úï ${error.message}`, 'error');
      }
    }

    async function processExcelData(arrayBuffer, filename, targetYear, targetMonth) {
      const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array', cellDates: true });
      const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { defval: "", raw: false });
      
      const findValue = (row, keys) => {
        const lowerKeys = keys.map(k => k.toLowerCase());
        for (const key in row) {
          if (lowerKeys.includes(key.toLowerCase())) return row[key];
        }
      };
      
      const processedDays = new Set();
      const fieldMappings = {
        aniaPraca: ['Ania praca'],
        ania: ['Ania inne', 'Ania'],
        michalPraca: ['Michal praca', 'Micha≈Ç praca'],
        michal: ['Micha≈Ç inne', 'Michal inne', 'Micha≈Ç'],
        wspolne: ['Niania', 'Wsp√≥lne'],
        inne: ['Inne']
      };
      
      const calendarId = `${targetYear}-${targetMonth + 1}`;
      
      // Najpierw wyczy≈õƒá ca≈Çy miesiƒÖc
      console.log(`Czyszczenie ${mNames[targetMonth]} ${targetYear}...`);
      const existingDocs = await getDocs(collection(db, calendarId));
      const deleteBatch = writeBatch(db);
      existingDocs.docs.forEach(d => deleteBatch.delete(d.ref));
      await deleteBatch.commit();
      
      // Teraz dodaj nowe dane
      const batch = writeBatch(db);
      
      for (const row of jsonData) {
        let day = 0;
        const dateValue = findValue(row, ['Data', 'Date', 'Dzie≈Ñ']);
        if (dateValue) {
          if (String(dateValue).includes('-') || String(dateValue).includes('/')) {
            const parsedDate = new Date(dateValue);
            if (!isNaN(parsedDate.getTime())) day = parsedDate.getDate();
          } else {
            const parsed = parseInt(String(dateValue).trim(), 10);
            if (!isNaN(parsed) && parsed >= 1 && parsed <= 31) day = parsed;
          }
        }
        
        if (!day || processedDays.has(day)) continue;
        
        let dayData = {}, hasData = false;
        for (const field in fieldMappings) {
          const value = findValue(row, fieldMappings[field]);
          if (value && String(value).trim()) {
            const text = String(value).trim();
            const hours = getDefaultHours(text);
            dayData[field] = hours > 0 ? { text, h1: hours } : text;
            hasData = true;
          }
        }
        
        if (hasData) {
          batch.set(doc(db, calendarId, String(day)), dayData);
          processedDays.add(day);
        }
      }
      
      await batch.commit();
      console.log(`‚úÖ Zaimportowano ${processedDays.size} dni do ${mNames[targetMonth]} ${targetYear}`);
    }

    function startAutoSync() {
      if (autoSyncInterval) clearInterval(autoSyncInterval);
      syncFromOneDrive();
      autoSyncInterval = setInterval(syncFromOneDrive, SYNC_INTERVAL);
    }

    function stopAutoSync() {
      if (autoSyncInterval) {
        clearInterval(autoSyncInterval);
        autoSyncInterval = null;
      }
    }

    E.onedriveBtn.onclick = () => {
      if (onedriveToken) {
        syncFromOneDrive();
      } else {
        connectOneDrive();
      }
    };
    
    E.onedriveBtnMobile.onclick = () => {
      E.mobileMenu.classList.remove('open');
      if (onedriveToken) {
        syncFromOneDrive();
      } else {
        connectOneDrive();
      }
    };

    const renderDesktop=(y,m,ev)=>{ E.desk.innerHTML=''; const days=new Date(y,m+1,0).getDate(); const today=new Date(); for(let d=1; d<=days; d++){ const date=new Date(y,m,d); const dow=date.getDay(); const isToday=today.toDateString()===date.toDateString(); const de=ev[d]||{}; const off=(dow===0||dow===6)||de.isHoliday; const dayCell=document.createElement('div'); dayCell.className=`cell day-cell ${off?'off':''} ${isToday?'today':''} flex items-center justify-center`; dayCell.dataset.day=d; dayCell.innerHTML=`<div class="text-center"><div class="day-num">${d}</div><div class="day-name">${dShort[getDayIdx(dow)]}</div></div>`; E.desk.appendChild(dayCell); for(const f of fields){ const t=getEntryText(d,f); const c=document.createElement('div'); c.className=`cell ${off?'off':''} ${getFieldClass(f)}`; const div=document.createElement('div'); div.className=`fld ${getTileClass(t)}`; div.dataset.day=d; div.dataset.field=f; const span=document.createElement('span'); span.className='txt'; span.textContent=t; div.appendChild(span); c.appendChild(div); E.desk.appendChild(c); }}};
    const renderMobileGrid=(y,m,ev)=>{ E.mobileGridContent.innerHTML=''; const days=new Date(y,m+1,0).getDate(); const today=new Date(); const headers = ['', 'Ania', 'A.Praca', 'Micha≈Ç', 'M.Praca', 'Niania', 'Inne']; headers.forEach(h => { const header = document.createElement('div'); header.className = 'mobile-grid-cell mobile-grid-header'; header.textContent = h; E.mobileGridContent.appendChild(header); }); let todayElement = null; for(let d=1; d<=days; d++){ const date=new Date(y,m,d); const dow=date.getDay(); const isToday=today.toDateString()===date.toDateString(); const de=ev[d]||{}; const off=(dow===0||dow===6)||de.isHoliday; const dayCell = document.createElement('div'); dayCell.className = `mobile-grid-cell mobile-grid-day ${off?'weekend':''} ${isToday?'today':''}`; dayCell.innerHTML = `<div class="day-num">${d}</div><div style="font-size:0.5rem">${dShort[getDayIdx(dow)]}</div>`; dayCell.dataset.day=d; dayCell.addEventListener('click', ()=>toggleHoliday(d)); E.mobileGridContent.appendChild(dayCell); if(isToday) todayElement = dayCell; for(const f of fields){ const t=getEntryText(d,f); const cell=document.createElement('div'); cell.className=`mobile-grid-cell ${getFieldClass(f)}`; const content=document.createElement('div'); content.className=`mobile-grid-content ${getTileClass(t)}`; content.dataset.day=d; content.dataset.field=f; const shortText = t.length > 12 ? t.substring(0,10) + '...' : t; content.textContent=shortText; content.title=t; cell.appendChild(content); E.mobileGridContent.appendChild(cell); }} if(todayElement && isMobile) { setTimeout(() => { todayElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' }); }, 100); }};
    const renderMobile=(y,m,ev)=>{ E.mob.innerHTML=''; const days=new Date(y,m+1,0).getDate(); const today=new Date(); const frag=document.createDocumentFragment(); for(let d=1; d<=days; d++){ const date=new Date(y,m,d); const dow=date.getDay(); const de=ev[d]||{}; const off=(dow===0||dow===6)||de.isHoliday; const isToday=today.toDateString()===date.toDateString(); const card=document.createElement('div'); card.className=`m-card ${off?'ring-1 ring-red-200':''} ${isToday?'ring-2 ring-purple-400':''}`; let html=`<div class="m-head"><div><span class="m-num">${d}</span> <span class="m-name">${dNamesFull[getDayIdx(dow)]}</span></div><div class="flex gap-1">${de.isHoliday?'<span class="tag bg-red-100 text-red-600">≈öwiƒôto</span>':''}${isToday?'<span class="tag bg-gradient-to-r from-purple-500 to-pink-500 text-white">Dzi≈õ</span>':''}</div></div>`; for(const f of fields){ const t=getEntryText(d, f); html+=`<div class="m-row"><div class="m-label ${getFieldClass(f)}">${labels[f]}</div><div class="m-content ${getFieldClass(f)} ${getTileClass(t)}" data-day="${d}" data-field="${f}"><span class="txt">${t||'<span class="placeholder">+ Dodaj</span>'}</span></div></div>`; } card.innerHTML=html; frag.appendChild(card); } E.mob.appendChild(frag);};

    const computeSumsAndEarnings = () => { let sums = { ortho: 0, brz: 0, lask: 0, jb: 0, portsInstall: 0, portsRemove: 0, earnings: 0, jednodniowki: 0, kwalifikacje: 0, komercja: 0 }; const days = new Date(cur.getFullYear(), cur.getMonth() + 1, 0).getDate(); const calculateEarningsForText = (text, hours) => { if (!text || !hours) return 0; if (isOrtho(text)) return hours * hourlyRates.ortho; if (isBrzeziny(text)) return hours * hourlyRates.brzeziny; if (isLask(text)) return hours * hourlyRates.lask; if (isJB(text)) return hours * hourlyRates.jb; return 0; }; const sumHoursForText = (text, hours, target) => { if (!text || !hours) return; if (isOrtho(text)) target.ortho += hours; else if (isBrzeziny(text)) target.brz += hours; else if (isLask(text)) target.lask += hours; else if (isJB(text)) target.jb += hours; }; for (let d = 1; d <= days; d++) { const dayData = data[d]; if (!dayData) continue; for (const f of fields) { const entry = dayData[f]; if (!entry) continue; if (typeof entry === 'object') { const textParts = (entry.text || '').split('/').map(t => t.trim()); const h1 = entry.h1 || 0, h2 = entry.h2 || 0; sumHoursForText(textParts[0], h1, sums); sums.earnings += calculateEarningsForText(textParts[0], h1); if (textParts.length > 1) { sumHoursForText(textParts[1], h2, sums); sums.earnings += calculateEarningsForText(textParts[1], h2); } } else { const hours = getDefaultHours(entry); sumHoursForText(entry, hours, sums); sums.earnings += calculateEarningsForText(entry, hours); } if (f === 'michalPraca') { sums.portsInstall += getEntryProp(d, f, 'ports_i', 0); sums.portsRemove += getEntryProp(d, f, 'ports_r', 0); sums.jednodniowki += getEntryProp(d, f, 'endo_od', 0); sums.kwalifikacje += getEntryProp(d, f, 'endo_q', 0); sums.komercja += getEntryProp(d, f, 'komercja', 0); } } } sums.earnings += (sums.portsInstall * portRates.install) + (sums.portsRemove * portRates.remove); sums.earnings += sums.jednodniowki * endoRates.one_day; sums.earnings += sums.kwalifikacje * endoRates.qual; sums.earnings += sums.komercja * komercjaRate; sums.earnings += ZASTEPCA_ORDYNATORA_BONUS; if(E.sumEarnings) E.sumEarnings.title = 'Zawiera sta≈Çy bonus 4000 z≈Ç'; if(E.msEarnings) E.msEarnings.title = 'Zawiera sta≈Çy bonus 4000 z≈Ç'; const totalPorts = sums.portsInstall + sums.portsRemove; const totalHours = sums.ortho + sums.brz + sums.lask + sums.jb; E.sumOrtho.textContent=`${sums.ortho}h`; E.sumBrz.textContent=`${sums.brz}h`; E.sumLask.textContent=`${sums.lask}h`; E.sumJB.textContent=`${sums.jb}h`; E.sumTotalHours.textContent=`${totalHours}h`; E.sumPorts.textContent=String(totalPorts); E.sumJednodniowki.textContent=String(sums.jednodniowki); E.sumKwalifikacje.textContent=String(sums.kwalifikacje); E.sumKomercja.textContent=String(sums.komercja); E.sumEarnings.textContent=`${sums.earnings.toLocaleString('pl-PL')} z≈Ç`; E.msOrtho.textContent=`${sums.ortho}h`; E.msBrz.textContent=`${sums.brz}h`; E.msLask.textContent=`${sums.lask}h`; E.msJB.textContent=`${sums.jb}h`; E.msTotalHours.textContent=`${totalHours}h`; E.msPorts.textContent=String(totalPorts); E.msJednodniowki.textContent=String(sums.jednodniowki); E.msKwalifikacje.textContent=String(sums.kwalifikacje); E.msKomercja.textContent=String(sums.komercja); E.msEarnings.textContent=`${sums.earnings.toLocaleString('pl-PL')} z≈Ç`; E.sheetTitle.textContent=`${mNames[cur.getMonth()]} ${cur.getFullYear()}`; };

    const calId=()=>`${cur.getFullYear()}-${cur.getMonth()+1}`;
    const save=async(day,field,val)=>setDoc(doc(db,calId(),String(day)),{[field]:val},{merge:true});
    const del=async(day,field)=>updateDoc(doc(db,calId(),String(day)),{[field]:deleteField()});
    
    function openEdit(day, field, overrideText = null) { const entry = data[day]?.[field] || {}; const initialText = typeof entry === 'object' ? entry.text || '' : entry || ''; const entryText = overrideText ?? initialText; const textParts = entryText.split('/').map(t => t.trim()); E.editTitle.textContent = `${labels[field]} ‚Äî ${day} ${mNames[cur.getMonth()]}`; let formHTML = `<div class="form-group"><label class="form-label">Tre≈õƒá wpisu</label><input type="text" id="editText" class="form-input" value="${entryText.replace(/"/g, '&quot;')}" placeholder="np. JB wybudzenia / ortho od 15:00"></div>`; const createHoursHTML = (partNum, text, hours) => { const defaultH = getDefaultHours(text); const currentH = hours ?? defaultH; const labelText = text || (partNum === 1 ? "G≈Ç√≥wny wpis" : "Dodatkowy wpis"); return `<div class="hours-control"><div class="hours-control-label">${labelText}</div><div class="mt-2"><input type="range" min="0" max="48" step="0.5" value="${currentH}" data-part="${partNum}" data-role="slider" class="hours-slider"><input type="number" min="0" max="48" step="0.5" value="${currentH}" placeholder="${defaultH}" data-part="${partNum}" data-role="num" class="hours-number"></div></div>`; }; formHTML += createHoursHTML(1, textParts[0], getEntryProp(day, field, 'h1', null)); if (textParts.length > 1) { formHTML += createHoursHTML(2, textParts[1], getEntryProp(day, field, 'h2', null)); } if (field === 'michalPraca') { formHTML += `<div class="hours-control" style="background: #ede9fe;"><div class="hours-control-label">Porty</div><div class="grid grid-cols-2 gap-3 mt-2"><div><label class="text-xs text-gray-500">Za≈Ço≈ºenie</label><input type="number" min="0" value="${getEntryProp(day, field, 'ports_i', '')}" id="editPortsI" placeholder="0" class="form-input text-center"></div><div><label class="text-xs text-gray-500">Usuniƒôcie</label><input type="number" min="0" value="${getEntryProp(day, field, 'ports_r', '')}" id="editPortsR" placeholder="0" class="form-input text-center"></div></div></div>`; formHTML += `<div class="hours-control" style="background: #f0fdfa;"><div class="hours-control-label">Inne procedury</div><div class="grid grid-cols-3 gap-2 mt-2"><div><label class="text-xs text-gray-500">Jednodni√≥wki</label><input type="number" min="0" value="${getEntryProp(day, field, 'endo_od', '')}" id="editEndoOD" placeholder="0" class="form-input text-center"></div><div><label class="text-xs text-gray-500">Kwalifikacje</label><input type="number" min="0" value="${getEntryProp(day, field, 'endo_q', '')}" id="editEndoQ" placeholder="0" class="form-input text-center"></div><div><label class="text-xs text-gray-500">Komercja</label><input type="number" min="0" value="${getEntryProp(day, field, 'komercja', '')}" id="editKomercja" placeholder="0" class="form-input text-center"></div></div></div>`; } E.editContent.innerHTML = formHTML; const editTextEl = el('editText'); editTextEl.focus(); editTextEl.selectionStart = editTextEl.selectionEnd = editTextEl.value.length; const handleSliderSync = (e) => { if (e.target.dataset.role === 'slider') { const numInput = E.editContent.querySelector(`input[data-role="num"][data-part="${e.target.dataset.part}"]`); if (numInput) numInput.value = e.target.value; } else if (e.target.dataset.role === 'num') { const slider = E.editContent.querySelector(`input[data-role="slider"][data-part="${e.target.dataset.part}"]`); const currentTextPart = textParts[parseInt(e.target.dataset.part, 10) - 1] || ''; if (slider) slider.value = e.target.value || getDefaultHours(currentTextPart); } }; E.editContent.addEventListener('input', handleSliderSync); editTextEl.addEventListener('input', (e) => { const newText = e.target.value; const needsRerender = (initialText.includes('/') !== newText.includes('/')); if (needsRerender) { openEdit(day, field, newText); } }); E.editSave.onclick = async () => { const newText = el('editText').value.trim(); if (!newText && !el('editPortsI')?.value && !el('editPortsR')?.value && !el('editEndoOD')?.value && !el('editEndoQ')?.value && !el('editKomercja')?.value) { await del(day, field); } else { const finalData = { text: newText }; const getNumVal = (selector, isFloat = false) => { const i = el(selector) || E.editContent.querySelector(selector); if (!i || i.value === '') return deleteField(); return isFloat ? parseFloat(i.value.replace(',', '.')) : parseInt(i.value, 10); }; const initialParts = initialText.split('/').map(t => t.trim()); const newParts = newText.split('/').map(t => t.trim()); const processHours = (partNum, initialPartText, newPartText) => { const formVal = getNumVal(`input[data-part="${partNum}"][data-role="num"]`, true); if (typeof formVal === 'object') { return getDefaultHours(newPartText) || deleteField(); } const oldDefault = getDefaultHours(initialPartText); if (formVal === oldDefault && initialPartText !== newPartText) { return getDefaultHours(newPartText) || deleteField(); } return formVal; }; finalData.h1 = processHours(1, initialParts[0], newParts[0]); if (newText.includes('/')) { finalData.h2 = processHours(2, initialParts[1] || '', newParts[1] || ''); } if (field === 'michalPraca') { finalData.ports_i = getNumVal('#editPortsI'); finalData.ports_r = getNumVal('#editPortsR'); finalData.endo_od = getNumVal('#editEndoOD'); finalData.endo_q = getNumVal('#editEndoQ'); finalData.komercja = getNumVal('#editKomercja'); } await save(day, field, finalData); } E.edit.style.display = 'none'; }; E.edit.style.display='flex'; }
    E.editClose.onclick=()=>E.edit.style.display='none'; E.edit.addEventListener('click',e=>{if(e.target===E.edit) E.edit.style.display='none';}); document.addEventListener('keydown', e=>{if(e.key==='Escape') E.edit.style.display='none';});
    E.mobileMenuBtn.onclick=()=>E.mobileMenu.classList.add('open'); E.menuClose.onclick=()=>E.mobileMenu.classList.remove('open'); E.mobileMenu.addEventListener('click',e=>{if(e.target===E.mobileMenu) E.mobileMenu.classList.remove('open');});
    document.addEventListener('contextmenu', e=>{ const fld=e.target.closest('.fld,.m-content,.mobile-grid-content'); if(!fld)return; e.preventDefault(); E.ctx.style.display='block'; const day = parseInt(fld.dataset.day); const menuHeight = 180; if(day >= 25 && e.clientY > window.innerHeight - menuHeight - 50) { E.ctx.style.left = e.clientX + 'px'; E.ctx.style.top = (e.clientY - menuHeight) + 'px'; } else { E.ctx.style.left = e.clientX + 'px'; E.ctx.style.top = e.clientY + 'px'; } setTimeout(() => { const rect = E.ctx.getBoundingClientRect(); if(rect.right > window.innerWidth) E.ctx.style.left = (window.innerWidth - rect.width - 10) + 'px'; if(rect.bottom > window.innerHeight) E.ctx.style.top = (e.clientY - rect.height) + 'px'; if(rect.top < 0) E.ctx.style.top = '10px'; }, 0); E.ctx.dataset.day=fld.dataset.day; E.ctx.dataset.field=fld.dataset.field; });
    document.addEventListener('click', e=>{if(!e.target.closest('#ctx')) E.ctx.style.display='none';});
    E.ctxCopy.onclick=()=>{const d=E.ctx.dataset; clip=data[d.day]?.[d.field]; E.ctx.style.display='none';}; E.ctxCut.onclick=async()=>{const d=E.ctx.dataset; clip=data[d.day]?.[d.field]; await del(d.day,d.field); E.ctx.style.display='none';}; E.ctxPaste.onclick=async()=>{const d=E.ctx.dataset; if(clip) await save(d.day,d.field,clip); E.ctx.style.display='none';}; E.ctxDel.onclick=async()=>{const d=E.ctx.dataset; await del(d.day,d.field); E.ctx.style.display='none';};
    const launchEdit = (e) => { const target = e.target.closest('[data-day][data-field]'); if (target) openEdit(target.dataset.day, target.dataset.field); };
    E.desk.addEventListener('click', launchEdit); E.mob.addEventListener('click', launchEdit); E.mobileGridView.addEventListener('click', launchEdit); E.desk.addEventListener('click', e => { const dayCell = e.target.closest('.day-cell'); if (dayCell) toggleHoliday(dayCell.dataset.day); });
    if(E.gridViewBtn && E.cardViewBtn) { E.gridViewBtn.onclick = () => { document.body.classList.remove('card-view'); E.gridViewBtn.classList.add('active'); E.cardViewBtn.classList.remove('active'); }; E.cardViewBtn.onclick = () => { document.body.classList.add('card-view'); E.cardViewBtn.classList.add('active'); E.gridViewBtn.classList.remove('active'); }; }
    function updateClock() { if(E.currentTime) E.currentTime.textContent = new Date().toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' }); } setInterval(updateClock, 1000); updateClock();
    async function toggleHoliday(day){ const ref=doc(db,calId(),String(day)); const snap=await getDoc(ref); const cur=(snap.exists()&&snap.data().isHoliday)||false; await setDoc(ref,{isHoliday:!cur},{merge:true}); }
    function setTitle(){ const title = `${mNames[cur.getMonth()]} ${cur.getFullYear()}`; E.title.textContent = title; E.titleMobile.textContent = title; }
    async function update(){ if(!db) return; setTitle(); unsub(); unsub=onSnapshot(collection(db,calId()),s=>{ data={}; s.forEach(doc => data[doc.id] = doc.data()); if(isMobile) { renderMobileGrid(cur.getFullYear(),cur.getMonth(),data); renderMobile(cur.getFullYear(),cur.getMonth(),data); } else { renderDesktop(cur.getFullYear(),cur.getMonth(),data); } computeSumsAndEarnings(); }); }
    const changeMonth = (delta) => { cur.setDate(1); cur.setMonth(cur.getMonth()+delta); update(); };
    const goToToday = () => { cur=new Date(); update(); };
    E.prev.onclick=()=>changeMonth(-1); E.next.onclick=()=>changeMonth(1); E.prevMobile.onclick=()=>changeMonth(-1); E.nextMobile.onclick=()=>changeMonth(1); E.today.onclick=goToToday; E.todayMobile.onclick=goToToday;
    
    E.fab.onclick = () => E.sheet.classList.add('open');
    E.sheetClose.onclick = () => E.sheet.classList.remove('open');
    
    const mNamesToNum = { 
      'stycze≈Ñ': 0, 'stycznia': 0, 'sty': 0, 
      'luty': 1, 'lutego': 1, 'lut': 1, 
      'marzec': 2, 'marca': 2, 'mar': 2, 
      'kwiecie≈Ñ': 3, 'kwietnia': 3, 'kwi': 3, 
      'maj': 4, 'maja': 4, 
      'czerwiec': 5, 'czerwca': 5, 'cze': 5, 
      'lipiec': 6, 'lipca': 6, 'lip': 6, 
      'sierpie≈Ñ': 7, 'sierpnia': 7, 'sie': 7, 
      'wrzesie≈Ñ': 8, 'wrze≈õnia': 8, 'wrz': 8, 
      'pa≈∫dziernik': 9, 'pa≈∫dziernika': 9, 'pa≈∫': 9, 
      'listopad': 10, 'listopada': 10, 'lis': 10, 
      'grudzie≈Ñ': 11, 'grudnia': 11, 'gru': 11 
    };
    
    async function handleExcelImport(event) { 
      const file = event.target.files[0]; 
      if (!file) return; 
      
      try { 
        const monthNamesPattern = Object.keys(mNamesToNum).join('|'); 
        const dateRegex = new RegExp(`(?:plan\\s+pracy\\s+)?(${monthNamesPattern})\\s+(\\d{4})`, 'i'); 
        const match = file.name.match(dateRegex); 
        let targetMonth = null, targetYear = null; 
        
        if (match) { 
          targetMonth = mNamesToNum[match[1].toLowerCase()]; 
          targetYear = parseInt(match[2], 10); 
          console.log(`Import pliku: ${file.name} ‚Üí ${mNames[targetMonth]} ${targetYear}`); 
        } else { 
          alert('Nie mo≈ºna rozpoznaƒá miesiƒÖca i roku z nazwy pliku.\n\nNazwa pliku powinna byƒá w formacie:\n"plan pracy stycze≈Ñ 2025.xlsx"\nlub po prostu:\n"stycze≈Ñ 2025.xlsx"'); 
          return; 
        } 
        
        const reader = new FileReader(); 
        reader.onload = async function(e) { 
          await processExcelData(e.target.result, file.name, targetYear, targetMonth); 
          await update(); 
          alert(`‚úÖ Zaimportowano dane do ${mNames[targetMonth]} ${targetYear}`); 
        }; 
        reader.readAsArrayBuffer(file); 
      } catch (error) { 
        console.error("B≈ÇƒÖd importu:", error); 
        alert('‚ùå B≈ÇƒÖd podczas importu pliku'); 
      } finally { 
        event.target.value = ''; 
      } 
    }
    
    E.xlsxFileInput.onchange = handleExcelImport; 
    E.xlsxFileInputMobile.onchange = (e) => { 
      handleExcelImport(e); 
      E.mobileMenu.classList.remove('open'); 
    };
    
    const handleClearMonth = async () => { 
      if(!confirm(`Czy na pewno chcesz usunƒÖƒá WSZYSTKIE wpisy z ${mNames[cur.getMonth()]} ${cur.getFullYear()}?`))return; 
      const q=await getDocs(collection(db,calId())); 
      const batch=writeBatch(db); 
      q.docs.forEach(d=>batch.delete(d.ref)); 
      await batch.commit(); 
    };
    
    E.clearMonthBtn.onclick=handleClearMonth; 
    E.clearMonthBtnMobile.onclick=()=>{ 
      handleClearMonth(); 
      E.mobileMenu.classList.remove('open'); 
    };
    
    function exportToICS() { 
      const year = cur.getFullYear(), month = cur.getMonth(); 
      const formatICSDate = d => `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}T${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}${String(d.getSeconds()).padStart(2,'0')}`; 
      const parseStartTime = text => { 
        const match = text?.match(/\bod\s+(\d{1,2})[:.]?(\d{2})?/i); 
        return match ? { hour: parseInt(match[1],10), minute: match[2] ? parseInt(match[2],10) : 0 } : { hour: 8, minute: 0 }; 
      }; 
      
      let icsContent = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Kalendarz Rodzinny//PL\nCALSCALE:GREGORIAN\nMETHOD:PUBLISH\n'; 
      const days = new Date(year, month+1, 0).getDate(); 
      
      for(let d=1; d<=days; d++){ 
        const dayData = data[d]; 
        if(!dayData) continue; 
        
        for(const field of fields){ 
          const entry = dayData[field]; 
          if(!entry) continue; 
          const text = typeof entry === 'object' ? entry.text : entry; 
          if(!text) continue; 
          
          const startTime = parseStartTime(text); 
          const start = new Date(year, month, d, startTime.hour, startTime.minute); 
          const end = new Date(start.getTime() + 3600000); 
          const uid = `${year}${month}${d}${field}@kalendarz-rodzinny`; 
          
          icsContent += `BEGIN:VEVENT\n`; 
          icsContent += `UID:${uid}\n`; 
          icsContent += `DTSTAMP:${formatICSDate(new Date())}\n`; 
          icsContent += `DTSTART:${formatICSDate(start)}\n`; 
          icsContent += `DTEND:${formatICSDate(end)}\n`; 
          icsContent += `SUMMARY:${labels[field]}: ${text.replace(/\n/g, ' ')}\n`; 
          icsContent += `DESCRIPTION:${text.replace(/\n/g, '\\n')}\n`; 
          icsContent += `STATUS:CONFIRMED\n`; 
          icsContent += `END:VEVENT\n`; 
        }
      } 
      
      icsContent += 'END:VCALENDAR'; 
      const blob = new Blob([icsContent], { type: 'text/calendar' }); 
      const url = URL.createObjectURL(blob); 
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = `kalendarz-${mNames[month]}-${year}.ics`; 
      a.click(); 
      URL.revokeObjectURL(url); 
    }
    
    E.exportIcsBtn.onclick = exportToICS; 
    E.exportIcsBtnMobile.onclick = () => { 
      exportToICS(); 
      E.mobileMenu.classList.remove('open'); 
    };
    
    function init(){ 
      const savedToken = localStorage.getItem('onedrive_token');
      if (savedToken) {
        onedriveToken = savedToken;
        updateOneDriveUI(true);
        startAutoSync();
      }
      
      if (handleAuthRedirect()) {
        console.log('OneDrive po≈ÇƒÖczony pomy≈õlnie');
      }
      
      update(); 
    }
  </script>
</body>
</html>
